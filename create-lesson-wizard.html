<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>AI School Template ‚Äî Wizard (LOCAL, completo)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="assets/brand/favicon.png">
  <link rel="stylesheet" href="assets/css/global-header.css">
  <style>
    :root{
      --bg:#E6E6E6;--brand:#085078;--ink:#1f2937;--muted:#6b7280;--card:#fff;
      --border:#e5e7eb;--shadow:0 8px 32px rgba(0,0,0,.08);
      --radius:12px;--ok:#28a745;--warn:#ffc107;--info:#17a2b8;--danger:#dc3545;
      --pillw: 240px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:"Raleway",system-ui,sans-serif;color:var(--ink)}
    .container{max-width:1000px;margin:24px auto;padding:0 20px}
    .wizard-header{background:var(--card);border-radius:20px;box-shadow:var(--shadow);padding:24px;text-align:center}
    .wizard-header h1{margin:.2rem 0 0;color:var(--brand)}
    .steps{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .steps .pill{font-weight:600;font-size:.9rem;border:1px solid var(--border);border-radius:999px;padding:6px 12px;background:#f8fafc;color:#475569;cursor:pointer}
    .steps .pill.active{background:var(--brand);border-color:var(--brand);color:#fff}
    .steps-break{
      flex-basis: 100%;
      height: 0;
    }
    .steps .pill{
      flex: 0 0 var(--pillw);
      text-align: center;
    }
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:var(--radius);padding:16px;box-shadow:0 2px 6px rgba(0,0,0,0.08);margin:18px 0}
    .card + .card{margin-top:20px}
    .card > * + *{margin-top:12px}
    .card h2{font-size:1.45rem}
    .card > div[style*="flex-direction:column"] > div{margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .grid.three{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    label{font-weight:600;margin-bottom:6px;display:block}
    input[type="text"],input[type="url"],input[type="date"],select,textarea, input[type="number"]{
      width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font:inherit
    }
    textarea{min-height:110px;resize:vertical}
    input[type="text"]:focus-visible,
    input[type="url"]:focus-visible,
    input[type="date"]:focus-visible,
    input[type="number"]:focus-visible,
    select:focus-visible,
    textarea:focus-visible{
      outline: 3px solid rgba(8, 80, 120, 0.25);
      outline-offset: 2px;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(8, 80, 120, 0.12);
    }
    .hint, .muted{font-size:.95rem;margin-top:6px;background:#f5f6f7;border:1px solid #e5e7eb;border-radius:var(--radius);padding:10px 12px;color:#555}
    .form-hint{background:#f5f6f7;border-radius:var(--radius);padding:14px 16px;border:1px solid #e5e7eb;margin-top:12px;text-align:left}
    .preview-box{display:none;margin-top:8px}
    .preview-box img, .preview-box video{max-width:100%;max-height:512px;border-radius:12px;border:1px solid var(--border);box-shadow:var(--shadow);display:block;margin:12px 0}
    .btnbar{display:flex;justify-content:space-between;gap:12px;margin:22px 0}
    .btn{display:inline-block;text-decoration:none;background:#085078;color:#F1F1F1;border-radius:var(--radius);padding:12px 20px;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,0.08);transition:background-color 0.2s ease;border:none;cursor:pointer}
    .btn:hover{background-color:#063a55;color:#F1F1F1;text-decoration:none;transform:none;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
    .btn.secondary{background:#6c757d;color:#fff}
    .btn.info{background:var(--info);color:#fff}
    .btn.warn{background:var(--warn);color:#000}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.ok{background:var(--ok);color:#fff}
    .btn.danger{background:var(--danger);color:#fff}
    .btn-link{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:12px 18px;
      border-radius:12px;
      border:1px solid var(--border);
      color:var(--brand);
      text-decoration:none;
      font-weight:700;
      background:transparent;
    }
    .badge{display:inline-block;background:#f8fafc;color:var(--brand);border:1px solid var(--border);border-radius:8px;padding:4px 8px;font-weight:600}
    .avatar-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .avatar-card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .avatar-card > header{font-weight:700;color:var(--brand);margin-bottom:8px}
    .hr{height:0;border:0;border-top:1px solid #e5e7eb;margin:20px 0}
    .line{height:1px;background:var(--border);margin:12px 0}
    .tag{display:inline-flex;gap:6px;align-items:center;background:#f1f5f9;border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-weight:600}
    .list{display:grid;gap:12px;margin-top:6px}
    .item{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .item .row-end{display:flex;justify-content:flex-end;gap:8px}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{text-align:left;font-size:.9rem;color:#334155}
    .table td{background:#fff;border:1px solid var(--border);padding:8px;border-radius:8px}
    .small{font-size:.85rem}
    #envBanner{display:none;background:#fff3cd;border:1px solid #ffeeba;color:#856404;padding:.8rem;border-radius:10px;margin:12px 0}
    .right{justify-content:flex-end}
    .center{text-align:center}
    /* Avatar badge + error */
    .avatar-badge{width:132px;height:132px;border-radius:50%;overflow:hidden;box-shadow:0 8px 28px rgba(0,0,0,.08);display:flex;align-items:center;justify-content:center;background:#f1f5f9;border:1px solid var(--border)}
    .avatar-badge img,.avatar-badge video{width:100%;height:100%;object-fit:cover}
    .input-error{border-color:var(--danger)!important}
    .error-banner{background:#fde2e1;color:#9b1c1c;border:1px solid #f5b5b2;border-radius:10px;padding:.6rem .8rem;margin-top:.5rem;display:none}
    /* Cover preview */
    #coverPreview{margin-top:.75rem;display:grid;place-items:center;gap:.5rem}
    #coverPreviewImage,#coverPreviewVideo,#coverPreviewEmbed,#coverPreviewYTLink{width:min(720px,100%);max-height:60vh;border-radius:.75rem;box-shadow:0 6px 18px rgba(0,0,0,.08);background:#000}
    #coverPreviewImage,#coverPreviewVideo{object-fit:contain}
    #coverPreviewEmbed{border:0;width:min(720px,100%);aspect-ratio:16/9}
    #coverPreviewYTLink{display:inline-block;position:relative;text-decoration:none;width:min(640px,100%);aspect-ratio:16/9}
    #coverPreviewYTThumb{width:100%;height:100%;display:block;object-fit:cover}
    #coverPreviewYTLink .yt-play{position:absolute;right:8px;bottom:8px;background:rgba(0,0,0,.6);color:#fff;padding:.25rem .5rem;border-radius:.375rem;font-weight:700}
    #coverPreviewYTLink[hidden]{ display:none !important; }
    #coverPreviewVideoURL[hidden]{ display:none !important; }
    .cover-error{margin-top:.5rem;color:#B00020;font-size:.925rem}
    #coverMeta code{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px}
  
/* FIX: prevent wizard styles from breaking the global header */
.global-header { 
  position: sticky;
  top: 0;
  z-index: 9999;
  display: block;
}
.global-header .global-header-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.global-header .global-nav {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}
.global-header .global-nav a {
  display: inline-block;
}

/* FIX wizard: header non fisso (evita overlay e logo gigante) */
body.wizard-page .global-header{ position: sticky !important; top:0 !important; }
body.wizard-page.with-global-header{ padding-top: 0 !important; }

/* === FIX DEFINITIVO HEADER NEL WIZARD === */

/* nel wizard l‚Äôheader NON deve essere fisso */
body.wizard-page .global-header {
  position: static !important;
  top: auto !important;
}

/* elimina compensazioni per header fisso */
body.wizard-page.with-global-header {
  padding-top: 0 !important;
}

/* assicura che il menu sia visibile */
body.wizard-page .global-header .global-nav {
  display: flex !important;
  position: relative !important;
  z-index: 10 !important;
}

/* FIX wizard: impedisci che regole globali sulle immagini esplodano il logo */
body.wizard-page .global-header .global-logo img{
  height: 50px !important;
  max-width: 280px !important;
  width: auto !important;
  object-fit: contain !important;
}

/* FIX wizard: impedisci overflow che spinge il menu fuori viewport */
body.wizard-page .global-header,
body.wizard-page .global-header .global-header-content{
  overflow: visible !important;
}

/* === FIX wizard: ripristina look del global header === */
body.wizard-page .global-header{
  background: #085078 !important;
  color: #fff !important;
  padding: 0.75rem 2rem !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
}

body.wizard-page .global-header .global-header-content{
  max-width: 1400px !important;
  margin: 0 auto !important;
  width: 100% !important;
  display: flex !important;
  align-items: center !important;
  justify-content: space-between !important;
}

body.wizard-page .global-header .global-nav a{
  text-decoration: none !important;
}

/* === FIX wizard: colore e underline menu header === */
body.wizard-page .global-header .global-nav a,
body.wizard-page .global-header .global-nav a:visited{
  color: #F1F1F1 !important;
  text-decoration: none !important;
}

body.wizard-page .global-header .global-nav a:hover{
  color: #FFFFFF !important;
  text-decoration: none !important;
}

/* === FIX wizard: spaziatura menu header === */
body.wizard-page .global-header .global-nav{
  gap: 1.5rem !important;   /* prova 1.5rem; se vuoi pi√π aria ‚Üí 2rem */
}

@media (max-width: 768px) {
  body.wizard-page .global-header .global-header-content{
    display:flex !important;
    flex-direction:row !important;
    align-items:center !important;
    justify-content:space-between !important;
  }

  body.wizard-page .global-header{
    padding-left:12px !important;
    padding-right:12px !important;
  }

  body.wizard-page .global-header .global-nav{
    align-items:flex-end !important;
    text-align:right !important;
    row-gap:0.15rem !important;
  }

  body.wizard-page .global-header .global-nav a{
    padding-top:0.25rem !important;
    padding-bottom:0.25rem !important;
  }
}

/* FIX wizard: rimuove banner giallo iniziale */
#wizard-page #envBanner,
body.wizard-page #envBanner{
  display: none !important;
}

/* FIX: URL lunghi (es. data:image;base64...) ‚Äî render pi√π leggibile */
input[type="url"].truncate,
input.truncate {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* quando l'input √® in focus, lascia scorrere */
input[type="url"].truncate:focus,
input.truncate:focus {
  text-overflow: clip;
  overflow: auto;
}

/* FIX: righe testo tipo "Sorgente: ..." */
.truncate-line {
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.wizard-header + .card {
  margin-top: 28px;
}

.doc-note {
  font-size: 0.9rem;
  font-style: italic;
  color: #666;
  margin-top: 4px;
  margin-bottom: 6px;
}

.meta-gray-box{
  background:#f5f6f7;
  border:1px solid #e5e7eb;
  border-radius:var(--radius);
  padding:16px;
  width:100%;
  box-sizing:border-box;
  margin: 12px 0 18px 0;
}

.meta-gray-box > * + * { margin-top: 12px; }

.avatar-gray-box{
  background:#f5f6f7;
  border:1px solid #e5e7eb;
  border-radius:var(--radius);
  padding:16px;
  width:100%;
  box-sizing:border-box;
  margin: 12px 0 18px 0;
}

.avatar-gray-box > * + * { margin-top: 12px; }

.avatar-preview-white{
  background:#ffffff;
  border:1px solid #e5e7eb;
  border-radius:var(--radius);
  padding:12px;
}

.btn.danger{background:#085078 !important;color:#F1F1F1 !important}

.cover-gray-box{
  background:#f5f6f7;
  border:1px solid #e5e7eb;
  border-radius:var(--radius);
  padding:16px;
  width:100%;
  box-sizing:border-box;
  margin: 12px 0 18px 0;
}

.cover-gray-box > * + * { margin-top: 12px; }

.cover-preview-white{
  background:#ffffff;
  border:1px solid #e5e7eb;
  border-radius:var(--radius);
  padding:12px;
}

/* Centra contenuti nelle anteprime (immagine/video) */
.avatar-preview-white,
.cover-preview-white {
  display: flex;
  align-items: center;
  justify-content: center;
}

.avatar-preview-white img,
.avatar-preview-white video,
.cover-preview-white img,
.cover-preview-white video {
  display: block;
  margin: 0;
}

/* COPERTINA: centra contenuti nel riquadro bianco */
.cover-preview-white {
  display: grid !important;
  place-items: center !important;
  text-align: center;
}

/* Centra qualunque wrapper interno */
.cover-preview-white > * {
  margin-left: auto;
  margin-right: auto;
}

/* Media centrati */
.cover-preview-white img,
.cover-preview-white video {
  display: block !important;
  margin: 0 auto !important;
}

/* Box grigino standard per sottosezioni wizard */
.subsection-gray-box{
  background:#f5f6f7;
  border:1px solid #e5e7eb;
  border-radius:var(--radius);
  padding:16px;
  width:100%;
  box-sizing:border-box;
  margin: 12px 0 18px 0;
}

.subsection-gray-box > * + * { margin-top: 12px; }

/* Regola generale: campi compilabili sempre bianchi */
.subsection-gray-box input,
.subsection-gray-box textarea,
.subsection-gray-box select{
  background:#ffffff;
  border:1px solid #ced4da;
}

/* Note docenti: corsivo + pi√π piccolo */
.doc-note{
  font-size:0.9rem;
  font-style:italic;
  color:#666;
  margin-top:4px;
  margin-bottom:6px;
}

/* Coerenza con vista studente: titoli in blu (wizard) */
h2, h3, h4 {
  color: #085078 !important;
}

/* Le note docenti restano grigie (non blu) */
.doc-note {
  color: #666 !important;
}

/* STEP 0: pulsanti in Avatar e Copertina tutti blu (anche quelli di rimozione) */
.avatar-gray-box .btn,
.cover-gray-box .btn,
.avatar-gray-box .btn.danger,
.cover-gray-box .btn.danger {
  background: #085078 !important;
  color: #F1F1F1 !important;
  border: none !important;
}

.avatar-gray-box .btn:hover,
.cover-gray-box .btn:hover,
.avatar-gray-box .btn.danger:hover,
.cover-gray-box .btn.danger:hover {
  background-color: #063a55 !important;
  color: #F1F1F1 !important;
}

/* STEP 0: titoli dei campi (label) in blu */
.meta-gray-box label {
  color: #085078 !important;
}

/* Le note docenti restano grigie */
.meta-gray-box .doc-note {
  color: #666 !important;
}

/* STEP 1: sottotitoli in blu */
.subsection-gray-box label {
  color: #085078 !important;
}

/* STEP 1: pulsanti "Aggiungi" in blu */
.subsection-gray-box button,
.subsection-gray-box .btn {
  background: #085078 !important;
  color: #F1F1F1 !important;
  border: none !important;
}

.subsection-gray-box button:hover,
.subsection-gray-box .btn:hover {
  background-color: #063a55 !important;
  color: #F1F1F1 !important;
}

/* Override per box Mappa concettuale: allineamento a sinistra */
#conceptMapBox{ display:block; min-height:auto; text-align:left; }
#conceptMapBox > div{ text-align:left; }

/* Override per box Indicazioni approfondimento e Fonti crediti: layout verticale */

#resourcesDeepeningBox h3,

#resourcesDeepeningBox textarea,

#ethicsCreditsBox h3,

#ethicsCreditsBox textarea{

  display: block !important;

  width: 100% !important;

}

#resourcesDeepeningBox,

#ethicsCreditsBox{

  display: block !important;

  grid-template-columns: none !important;

  grid-column: 1 / -1 !important;

  flex: 0 0 100% !important;

  max-width: 100% !important;

}

#resourcesDeepeningBox,

#ethicsCreditsBox{

  display: flex !important;

  flex-direction: column !important;

  align-items: stretch !important;

}

#resourcesDeepeningBox h3,

#ethicsCreditsBox h3{

  width: 100% !important;

  margin: 0 !important;

}

#resourcesDeepeningBox textarea,

#ethicsCreditsBox textarea{

  width: 100% !important;

  box-sizing: border-box !important;

  margin-top: 12px !important;

}

/* STEP 0: nasconde mini box grigio inutile accanto a Rimuovi (copertina) */
.cover-gray-box #coverFileImageName,
.cover-gray-box #coverFileVideoName {
  display: none !important;
}

/* STEP 0: se l'img √® hidden, non deve mai mostrare fallback/alt nel preview */
#coverPreviewImage[hidden],
#coverPreviewImageURL[hidden] {
  display: none !important;
}

/* (opzionale) per sicurezza: se per qualche motivo hanno src vuoto */
#coverPreviewImage:not([src]),
#coverPreviewImageURL:not([src]),
#coverPreviewImage[src=""],
#coverPreviewImageURL[src=""] {
  display: none !important;
}

/* STEP 0: nasconde video player quando non ha src valido (evita player vuoto) */
#coverPreviewVideo[hidden],
#coverPreviewVideoURL[hidden] {
  display: none !important;
}

#coverPreviewVideo:not([src]),
#coverPreviewVideoURL:not([src]),
#coverPreviewVideo[src=""],
#coverPreviewVideoURL[src=""] {
  display: none !important;
}

/* STEP 0: nasconde il box preview video URL quando √® vuoto (evita pillolino/placeholder) */
#coverPreviewBoxVideoURL:has(video[hidden]),
#coverPreviewBoxVideoURL:has(video:not([src])),
#coverPreviewBoxVideoURL:has(video[src=""]) {
  display: none !important;
}


</style>
</head>
<body class="wizard-page with-global-header">
  <div class="container">
    <div id="envBanner">‚ÑπÔ∏è Stai creando una lezione.<br>Compila i campi e premi "Salva bozza" o "Avanti".<br>Puoi tornare alla "Dashboard" quando vuoi.</div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <div style="flex:1;"></div>
      <a href="teacher-dashboard.html" class="btn-link">Torna alla Dashboard</a>
    </div>

      <div class="wizard-header">
      <div class="badge">AI School Template ‚Äì CPIA</div>
      <h1>Creazione lezione</h1>
      <p class="muted">Compila gli step. Puoi salvare in bozza in qualsiasi momento.</p>
      <div id="stepPills" class="steps"></div>
    </div>

    <main id="wizardSlot"></main>

    <div class="btnbar">
      <div class="row">
        <button class="btn secondary" id="btnPrev" style="display:none;">‚Üê Indietro</button>
        <button class="btn info" id="btnPreview">üëÅÔ∏è Anteprima</button>
        </div>
      <div class="row">
        <button class="btn warn" id="btnDraft">üìù Salva bozza</button>
        <button class="btn ok" id="btnFinalize" style="display:none;">‚úÖ Rendi definitiva la lezione</button>
        <button class="btn primary" id="btnNext">Avanti ‚Üí</button>
        </div>
    </div>
  </div>

  <!-- ============================= -->
  <!-- TEMPLATES STEP (0‚Äì6) LOCALI  -->
  <!-- ============================= -->

  <!-- STEP 0 ‚Äì HOME (titolo+avatar obbligatori, anteprime on-demand) -->
  <template id="tpl-step-0">
    <section class="card">
      <h2>üìù Home della lezione</h2>

      <div class="meta-gray-box">
            <div style="display:flex;flex-direction:column;gap:12px;">
        <div>
          <label for="home-title">Titolo della lezione *</label>
          <input id="home-title" type="text" placeholder="Titolo breve e chiaro">
          <div id="err-title" class="muted" style="color:#dc3545;display:none;margin-top:4px;">Inserisci il titolo della lezione.</div>
        </div>

        <div>
          <label for="home-desc">Descrizione breve *</label>
          <textarea id="home-desc" placeholder="1‚Äì2 righe, linguaggio chiaro."></textarea>
          <div id="err-desc" class="muted" style="color:#dc3545;display:none;margin-top:4px;">Inserisci una descrizione breve (1‚Äì2 righe).</div>
        </div>

        <div>
          <label for="home-context">Contesto / target (facoltativo)</label>
          <p class="doc-note">Questo campo non √® visibile agli studenti e serve al docente per progettare meglio la lezione.</p>
          <select id="home-context">
            <option value="">‚Äî</option>
            <option value="Alfabetizzazione">Alfabetizzazione</option>
            <option value="Primo periodo">Primo periodo</option>
            <option value="Secondo periodo">Secondo periodo</option>
            <option value="Secondo livello">Secondo livello</option>
            <option value="Percorsi modulari per adulti">Percorsi modulari per adulti</option>
            <option value="Altro (es. laboratorio, progetto, orientamento)">Altro (es. laboratorio, progetto, orientamento)</option>
          </select>
        </div>

        <div>
          <label for="meta-cefr">Livello CEFR</label>
          <p class="doc-note">Questo campo non √® visibile agli studenti e serve al docente per progettare meglio la lezione.</p>
          <p class="doc-note">Il livello CEFR (A0‚ÄìB2) indica la difficolt√† linguistica. Default consigliato: A2.</p>
          <select id="meta-cefr">
            <option value="">‚Äî</option>
            <option>A0</option><option>A1</option><option selected>A2</option>
            <option>B1</option><option>B2</option>
          </select>
        </div>

        <div>
          <label for="meta-author">Docente</label>
          <input id="meta-author" type="text" placeholder="Nome Cognome">
        </div>
      </div>
      </div>


      <div style="display:none;">
        <input id="home-tags" type="text">
        <input id="meta-duration" type="text">
        <input id="meta-pfi" type="text">
      </div>

      <div class="hr"></div>

          <!-- AVATAR -->
      <div class="avatar-gray-box">
      <h3>üßë Avatar *</h3>
      <p class="doc-note" id="avatar-note">Cos'√® l'avatar?
L'avatar √® la piccola immagine o video rotondo che appare sotto al titolo della lezione nelle pagine pubblicate.
Non √® una copertina, ma un elemento introduttivo e accogliente: pu√≤ rappresentare l'idea centrale della lezione, il suo tono o il suo stile (ad esempio un simbolo, un volto, un oggetto, un paesaggio).

Puoi scegliere:

un avatar predefinito tra quelli del template;

oppure caricare il tuo avatar personalizzato (immagine o breve video quadrato 1:1).

Se vuoi invece inserire un video introduttivo o un'immagine di copertina pi√π ampia, fallo nella sezione Copertina della lezione.</p>
      
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;padding:12px;background:#f8f9fa;border-radius:10px;">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 12px;border-radius:6px;background:#fff;border:2px solid var(--border);"><input type="radio" name="avatarMode" value="logo" checked style="margin:0;"> Logo</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 12px;border-radius:6px;background:#fff;border:2px solid var(--border);"><input type="radio" name="avatarMode" value="img_f" style="margin:0;"> Immagine F</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 12px;border-radius:6px;background:#fff;border:2px solid var(--border);"><input type="radio" name="avatarMode" value="img_m" style="margin:0;"> Immagine M</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 12px;border-radius:6px;background:#fff;border:2px solid var(--border);"><input type="radio" name="avatarMode" value="vid_f" style="margin:0;"> Video F</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 12px;border-radius:6px;background:#fff;border:2px solid var(--border);"><input type="radio" name="avatarMode" value="vid_m" style="margin:0;"> Video M</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 12px;border-radius:6px;background:#fff;border:2px solid var(--border);"><input type="radio" name="avatarMode" value="img_custom" style="margin:0;"> Immagine personalizzata</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 12px;border-radius:6px;background:#fff;border:2px solid var(--border);"><input type="radio" name="avatarMode" value="vid_custom" style="margin:0;"> Video personalizzato</label>
      </div>
      
      <div id="avatar-modes" style="display:none;"></div>

      <!-- PREVIEW AVATAR -->
      <div id="avatarPreviewArea" class="avatar-preview-white" style="margin:16px 0;min-height:200px;display:flex;align-items:center;justify-content:center;">
        <div class="preview-box" id="prev-logo" style="display:none;">
          <figure class="avatar-badge"><img src="assets/brand/logo_edubot_icon.png" alt="Logo" onerror="this.style.display='none'; var ph=document.getElementById('logo-ph'); if(ph) ph.style.display='flex';"></figure>
          <div id="logo-ph" style="display:none;width:132px;height:132px;border-radius:50%;background:#e5e7eb;color:#374151;align-items:center;justify-content:center;font-weight:700;font-size:38px;">AI</div>
        </div>
        <div class="preview-box" id="prev-img-m" style="display:none;">
          <figure class="avatar-badge"><img src="assets/avatars/avatar_edubot_default.png" alt="Avatar M"></figure>
        </div>
        <div class="preview-box" id="prev-img-f" style="display:none;">
          <figure class="avatar-badge"><img src="assets/avatars/avatar_edubot_female.png" alt="Avatar F"></figure>
        </div>
        <div class="preview-box" id="prev-vid-m" style="display:none;">
          <figure class="avatar-badge"><video src="assets/video/intro_m.mp4" poster="assets/video/poster_m.png" muted playsinline autoplay loop></video></figure>
        </div>
        <div class="preview-box" id="prev-vid-f" style="display:none;">
          <figure class="avatar-badge"><video src="assets/video/intro_f.mp4" poster="assets/video/poster_f.png" muted playsinline autoplay loop></video></figure>
        </div>
        <div class="preview-box" id="prev-img-custom" style="display:none;">
          <figure class="avatar-badge"><img id="prev-img-custom-img" alt="Anteprima"></figure>
        </div>
        <div class="preview-box" id="prev-vid-custom" style="display:none;">
          <figure class="avatar-badge"><video id="prev-vid-custom-vid" muted playsinline autoplay loop></video></figure>
        </div>
      </div>
      <div id="err-avatar" class="muted" style="color:#dc3545;display:none;margin-top:4px;">Scegli un avatar (icona rotonda vicino al titolo).</div>

      <!-- CAMP Johnson: Immagine personalizzata -->
      <div id="avatarCustomImageWrap" style="display:none;margin-top:12px;">
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div>
            <label>Avatar personalizzato ‚Äì Immagine (quadrata)</label>
            <input type="file" id="avatarImageFile" accept="image/png,image/jpeg,image/webp">
            <div class="muted doc-note" style="margin-top:4px;">Carica <strong>immagine quadrata (1:1)</strong> ‚Äì consigliato ‚â• 512√ó512 px. Formati: PNG/JPG/WebP. <strong>Max 2 MB</strong>. <span class="small">Se non √® 1:1 verr√† <strong>centrata e ritagliata</strong> nel cerchio.</span></div>
          </div>
          <div class="error-banner" id="avatarImgError"></div>
          <div class="row" style="gap:8px;margin-top:4px;">
            <button type="button" id="avatarImageChangeBtn" class="btn secondary">Cambia immagine</button>
            <button type="button" id="avatarImageClearBtn" class="btn secondary">Rimuovi immagine</button>
          </div>
        </div>
      </div>

      <!-- CAMP Video personalizzato -->
      <div id="avatarCustomVideoWrap" style="display:none;margin-top:12px;">
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div>
            <label>Avatar personalizzato ‚Äì Video (quadrato)</label>
            <input type="file" id="avatarVideoFile" accept="video/mp4,video/webm">
            <div class="muted doc-note" style="margin-top:4px;">Carica <strong>video quadrato (1:1)</strong> ‚Äì <strong>MP4/WebM</strong>, durata consigliata ‚â§ <strong>10 s</strong>, <strong>autoplay silenzioso</strong>. <strong>Max 10 MB</strong>. I video YouTube <strong>non</strong> sono ammessi per l'avatar. <span class="small">Se non √® 1:1 verr√† <strong>centrato e ritagliato</strong> nel cerchio.</span></div>
          </div>
          <div class="error-banner" id="avatarVidError"></div>
          <div class="muted doc-note" style="margin-top:2px;">Per immagini o video da <strong>link</strong> (YouTube/Drive o link esterni) usa la <strong>Copertina introduttiva</strong>, non l'avatar.</div>
          <div class="row" style="gap:8px;margin-top:4px;">
            <button type="button" id="avatarVideoChangeBtn" class="btn secondary">Cambia video</button>
            <button type="button" id="avatarVideoClearBtn" class="btn secondary">Rimuovi video</button>
          </div>
        </div>
      </div>
      </div>

      <div class="hr"></div>

      <!-- COPERTINA INTRODUTTIVA -->
      <div class="cover-gray-box">
      <h3>üñºÔ∏è Copertina introduttiva (facoltativa)</h3>

      <!-- FIX: 5 opzioni esclusive (nessuna / img file / img url / vid file / vid url) -->
      <div class="row" id="coverModeWrap" style="gap:16px;flex-wrap:wrap;">
        <label><input type="radio" name="coverMode" value="none" checked> Nessuna copertina</label>
        <label><input type="radio" name="coverMode" value="image_file"> Immagine dal dispositivo</label>
        <label><input type="radio" name="coverMode" value="image_url"> Immagine da URL</label>
        <label><input type="radio" name="coverMode" value="video_file"> Video dal dispositivo</label>
        <label><input type="radio" name="coverMode" value="video_url"> Video da link (YouTube, MP4/WebM diretto, Drive pubblico)</label>
      </div>
      <!-- FIX: righe dinamiche che si aprono solo per la modalit√† selezionata -->
      <div id="coverRows" style="margin-top:12px;display:grid;gap:12px;">

        <!-- Nessuna -->
        <div id="row-none" style="display:block;">
          <div class="muted doc-note">Nessuna copertina verr√† mostrata.</div>
          </div>

        <!-- Immagine da FILE -->
        <div id="row-image_file" style="display:none;">
          <label>Seleziona immagine (consigliato ‚â§ 3MB)</label>
          <div class="row" style="gap:8px;align-items:center;">
            <input id="coverFileImage" type="file" accept="image/png,image/jpeg,image/webp" style="max-width:420px">
            <span id="coverFileImageName" class="small muted"></span>
            <button id="coverFileImageClear" type="button" class="btn secondary">Rimuovi</button>
          </div>
          <div class="preview-box cover-preview-white" id="coverPreviewBoxImage"><img id="coverPreviewImage" hidden alt="Immagine di copertina"></div>
            <label>Descrizione per ipovedenti (ALT)</label>
            <input type="text" id="introImageAlt" placeholder="Descrivi brevemente l'immagine">
          </div>

        <!-- Immagine da URL -->
        <div id="row-image_url" style="display:none;">
          <label>URL immagine</label>
          <div class="row" style="gap:8px;">
            <input id="coverUrlImage" type="url" class="truncate" placeholder="https://... (PNG/JPG/WebP)" style="flex:1;min-width:280px">
            <button id="coverUrlImageApply" type="button" class="btn secondary">Usa URL</button>
            <!-- FIX: clear URL immagine -->
            <button id="coverUrlImageClear" type="button" class="btn secondary">Rimuovi URL</button>
        </div>
          <div class="preview-box cover-preview-white" id="coverPreviewBoxImageURL"><img id="coverPreviewImageURL" hidden alt="Immagine di copertina"></div>
          <label>Descrizione per ipovedenti (ALT)</label>
          <input type="text" id="introImageAltURL" placeholder="Descrivi brevemente l'immagine">
      </div>

        <!-- Video da FILE -->
        <div id="row-video_file" style="display:none;">
          <label>Seleziona video (MP4/WebM, consigliato ‚â§ 8MB)</label>
          <div class="row" style="gap:8px;align-items:center;">
            <input id="coverFileVideo" type="file" accept="video/mp4,video/webm" style="max-width:420px">
            <span id="coverFileVideoName" class="small muted"></span>
            <button id="coverFileVideoClear" type="button" class="btn secondary">Rimuovi</button>
          </div>
          <div class="preview-box cover-preview-white" id="coverPreviewBoxVideo"><video id="coverPreviewVideo" hidden muted playsinline controls></video></div>
            <label>Trascrizione (facoltativa)</label>
            <textarea id="introVideoTranscript" placeholder="Testo del parlato o descrizione del video..."></textarea>
            <label>Riassunto (facoltativo)</label>
            <textarea id="introVideoSummary" placeholder="4‚Äì6 frasi semplici sui concetti chiave..."></textarea>
          </div>

        <!-- Video da URL (YouTube incluso) -->
        <div id="row-video_url" style="display:none;">
          <label>Link video (YouTube, MP4/WebM diretto, Drive pubblico)</label>
          <div class="row" style="gap:8px;">
            <input id="coverUrlVideo" type="url" class="truncate" placeholder="Incolla un link pubblico (YouTube/Drive) o un link diretto .mp4/.webm" style="flex:1;min-width:280px">
            <button id="coverUrlVideoApply" type="button" class="btn secondary">Usa URL</button>
            <!-- FIX: clear URL video -->
            <button id="coverUrlVideoClear" type="button" class="btn secondary">Rimuovi URL</button>
          </div>
          <div class="muted doc-note" style="margin-top:4px;">Suggerimento: per Google Drive il video deve essere condiviso ("Chiunque abbia il link pu√≤ visualizzare").</div>
          <!-- Preview: YT thumbnail cliccabile oppure video MP4/WebM -->
          <div id="coverPreview" class="cover-preview-white" aria-live="polite" style="margin-top:.5rem;">
            <a id="coverPreviewYTLink" hidden target="_blank" rel="noopener"
               style="display:inline-block;position:relative;width:min(640px,100%);aspect-ratio:16/9">
              <img id="coverPreviewYTThumb" alt="Anteprima YouTube"
                   style="width:100%;height:100%;object-fit:cover;border-radius:.75rem;border:1px solid #e5e7eb;box-shadow:0 6px 18px rgba(0,0,0,.08);">
              <span class="yt-play" style="position:absolute;right:8px;bottom:8px;background:rgba(0,0,0,.6);color:#fff;padding:.25rem .5rem;border-radius:.375rem;font-weight:700">‚ñ∂</span>
            </a>
            <!-- Aggiungi id al box del video URL per poterlo mostrare -->
            <div class="preview-box cover-preview-white" id="coverPreviewBoxVideoURL">
              <video id="coverPreviewVideoURL" hidden muted playsinline controls
                     style="max-width:100%;border-radius:.75rem;border:1px solid #e5e7eb;box-shadow:0 6px 18px rgba(0,0,0,.08);"></video>
        </div>
      </div>

          <!-- FIX: campi anche per i video da URL (YT incluso) -->
          <label>Trascrizione (facoltativa)</label>
          <textarea id="introVideoTranscriptURL" placeholder="Testo del parlato o descrizione del video..."></textarea>

          <label>Riassunto (facoltativo)</label>
          <textarea id="introVideoSummaryURL" placeholder="4‚Äì6 frasi semplici sui concetti chiave..."></textarea>
        </div>

        </div>

        <div id="coverMeta" class="small muted" style="margin-top:.25rem" hidden></div>
        <div id="coverError" class="cover-error" hidden></div>
      </div>
    </section>
  </template>

  <!-- STEP 1 ‚Äì LEZIONE / SPIEGAZIONE -->
  <template id="tpl-step-1">
    <section class="card">
      <h2>üìñ Lezione</h2>
      <p class="muted doc-note">Inserisci i contenuti della lezione: testo, immagini (con descrizione per ipovedenti), video (con trascrizione o breve riassunto), glossario bilingue e mappa concettuale.</p>

      <div class="subsection-gray-box">
        <label for="lesson-title">Titolo</label>
        <input id="lesson-title" type="text" placeholder="Titolo della sezione lezione (facoltativo)">
      </div>

      <div class="subsection-gray-box">
        <label for="lesson-objectives">Obiettivi (facoltativi)</label>
        <textarea id="lesson-objectives" placeholder="Obiettivi..."></textarea>
      </div>

      <div class="subsection-gray-box">
        <label for="lessonText">Testo della lezione</label>
        <textarea id="lessonText" placeholder="Inserisci il testo della lezione..."></textarea>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>üìó Glossario (IT)</h3>
        <p class="small muted doc-note">Facoltativo: aggiungi parole chiave e una spiegazione semplice.</p>
        <div class="row">
          <button type="button" class="btn secondary" id="btnAddGloss">+ Aggiungi termine</button>
            </div>
        <div id="glossList" class="list"></div>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>üñºÔ∏è Immagini</h3>
        <div class="row">
          <button type="button" class="btn secondary" id="btnAddImg">+ Aggiungi immagine</button>
            </div>
        <div id="imgList" class="list"></div>
        <p class="small muted doc-note">Per ogni immagine: descrizione per ipovedenti (ALT).</p>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>üé• Video</h3>
        <div class="row">
          <button type="button" class="btn secondary" id="btnAddVid">+ Aggiungi video</button>
            </div>
        <div id="vidList" class="list"></div>
        <p class="small muted doc-note">Per ogni video: trascrizione e breve riassunto.</p>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box" id="conceptMapBox">
        <h3>üó∫Ô∏è Mappa concettuale</h3>
        <div>
          <h4>Immagine mappa (facoltativa)</h4>
          <label>URL immagine</label>
          <input id="conceptImageUrl" type="url" class="truncate" placeholder="https://...">
          <button type="button" id="btnDelConceptUrl" class="btn danger" style="margin-top: 0.5rem; display: none;">Elimina</button>
          <label>Oppure carica da file locale</label>
          <input id="conceptImageFile" type="file" accept="image/*">
          <label>Descrizione per ipovedenti (ALT) (facoltativa)</label>
          <input id="conceptImageAlt" type="text" placeholder="Descrizione accessibile dell'immagine">
        </div>
      </div>
    </section>
  </template>

  <!-- STEP 2 ‚Äì ATTIVIT√Ä -->
  <template id="tpl-step-2">
    <section class="card">
          <h2>üß© Attivit√†</h2>
      <p class="muted doc-note">Proponi domande di comprensione, attivit√† creativa, compito di realt√† e link a quiz esterni.</p>

      <div class="subsection-gray-box">
        <h3>‚ùì Domande di comprensione (max 3)</h3>
        <label>Domanda 1</label>
        <textarea id="cq1" placeholder="Prima domanda di comprensione..."></textarea>
        <label>Domanda 2</label>
        <textarea id="cq2" placeholder="Seconda domanda di comprensione..."></textarea>
        <label>Domanda 3</label>
        <textarea id="cq3" placeholder="Terza domanda di comprensione..."></textarea>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>üé® Attivit√† creativa</h3>
        <label>Descrizione attivit√†</label>
        <textarea id="creativeActivity" placeholder="Osservazione, attivit√† pratica, esperimento semplice, racconto, disegno, schema, diagramma, mappa personale..."></textarea>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>üåç Compito di realt√†</h3>
        <div id="realTask" class="item">
          <label>Titolo</label>
          <input id="rtTitle" type="text" placeholder="Titolo compito di realt√†">
          <label>Descrizione</label>
          <textarea id="rtDesc" placeholder="Descrizione e contesto reale..."></textarea>
          <label>Cosa √® importante in questa attivit√†</label>
          <p class="small muted doc-note">Queste indicazioni ti aiutano a capire cosa √® importante mentre lavori.</p>
          <textarea id="rtEval" placeholder="Scrivi 2‚Äì4 frasi semplici: cosa conta (chiarezza, completezza, correttezza, impegno‚Ä¶)."></textarea>
        </div>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>üîó Attivit√† online esterne</h3>
        <p class="section-note doc-note">Link a quiz, esercizi, giochi e simulazioni utili per allenarsi.</p>
        <div class="row">
          <button type="button" class="btn secondary" id="btnAddExtQuiz">+ Aggiungi link</button>
          </div>
        <div id="extQuizList" class="list"></div>
      </div>

      <div class="hr"></div>
      <p class="muted doc-note">Il template non raccoglie risposte; attivit√† e riflessioni vengono riprese in classe.</p>
    </section>
  </template>

  <!-- STEP 3 ‚Äì RISORSE -->
  <template id="tpl-step-3">
    <section class="card">
      <h2>üìö Risorse</h2>
      <p class="muted doc-note">Materiali utili per approfondire o rivedere i contenuti della lezione.</p>

      <div class="subsection-gray-box">
        <h3>üîó Link utili</h3>
        <div class="row">
          <button type="button" class="btn secondary" id="btnAddLink">+ Aggiungi link</button>
            </div>
        <div id="linkList" class="list"></div>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>üìÑ Documenti</h3>
        <div class="row">
          <button type="button" class="btn secondary" id="btnAddDoc">+ Aggiungi documento</button>
              </div>
        <div id="docList" class="list"></div>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>üé• Video</h3>
        <div class="row">
          <button type="button" class="btn secondary" id="btnAddResVid">+ Aggiungi video</button>
              </div>
        <div id="resVidList" class="list"></div>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box" id="resourcesDeepeningBox">
        <h3>üìù Indicazioni per l'approfondimento</h3>
        <textarea id="teacherNotes" placeholder="Suggerimenti su come usare queste risorse per approfondire o ripassare."></textarea>
      </div>
    </section>
  </template>

  <!-- STEP 4 ‚Äì VALUTAZIONE -->
  <template id="tpl-step-4">
    <section class="card">
      <h2>üß† Valutazione & Riflessione</h2>
      <p class="muted doc-note">Quiz di ripasso, autovalutazione e riflessione personale (non vengono raccolti). Se ne parla in classe.</p>

      <div class="subsection-gray-box">
        <h3>Quiz di ripasso</h3>
        <p class="small muted doc-note">Max 5 domande.</p>
        <div class="row">
          <button type="button" class="btn secondary" id="btnAddQuestion">+ Aggiungi domanda</button>
            </div>
        <div id="quizList" class="list"></div>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>Autovalutazione</h3>
        <p class="small muted doc-note">Quanto ti senti preparato su questi argomenti?</p>
        <div>
          <label class="small">Argomento 1</label>
          <input id="selfTopic1" type="text">
        </div>
        <div>
          <label class="small">Argomento 2</label>
          <input id="selfTopic2" type="text">
        </div>
        <div>
          <label class="small">Argomento 3</label>
          <input id="selfTopic3" type="text">
        </div>
        <div>
          <label class="small">Argomento 4</label>
          <input id="selfTopic4" type="text">
        </div>
        <div>
          <label class="small">Argomento 5</label>
          <input id="selfTopic5" type="text">
        </div>
        <div>
          <label>Scala (faccine o punteggi)</label>
          <input id="selfScale" type="text" placeholder="üòü üòê üôÇ üòÄ üòÉ oppure 1 2 3 4 5">
        </div>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>Riflessione</h3>
        <p class="small muted doc-note">Scrivi domande guida brevi e semplici.</p>
        <div class="row">
          <button type="button" class="btn secondary" id="btnAddRefl">+ Aggiungi domanda guida</button>
        </div>
        <div id="reflList" class="list"></div>
      </div>

      <div class="hr"></div>
      <p class="muted doc-note">Il template non raccoglie risposte; attivit√† e riflessioni vengono riprese in classe.</p>
    </section>
  </template>

  <!-- STEP 5 ‚Äì INFO & ETICA -->
  <template id="tpl-step-5">
    <section class="card">
      <h2>‚ÑπÔ∏è Info & Etica</h2>
      <p class="muted doc-note">Compila questa sezione per garantire trasparenza sull'uso dell'IA, tutelando scuola e docente in modo semplice.</p>

      <div class="subsection-gray-box">
        <h3>Uso dell'Intelligenza Artificiale</h3>
        <div>
          <label class="small">In questa lezione sono stati utilizzati strumenti di Intelligenza Artificiale come supporto alla creazione dei contenuti.</label>
          <div style="margin-top:6px;">
            <div><label><input type="radio" name="aiUsedChoice" value="yes"> S√¨</label></div>
            <div><label><input type="radio" name="aiUsedChoice" value="no"> No</label></div>
          </div>
        </div>
        <div id="aiUsageDescWrap" hidden>
          <label>Come √® stata utilizzata l'IA</label>
          <textarea id="aiUsageDesc" rows="2" placeholder="Es.: semplificazione del testo, supporto alla progettazione, generazione di esempi o immagini, riformulazione linguistica‚Ä¶"></textarea>
          <div style="margin-top:8px;">
            <label>Strumenti IA usati (facoltativo)</label>
            <input id="aiTools" type="text" placeholder="Es.: ChatGPT, Canva‚Ä¶">
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>Controllo umano</h3>
        <p>Tutti i contenuti sono stati revisionati dal docente prima della pubblicazione.</p>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <div id="aiBadgeWrap">
          <h3>Etichettatura [IA]</h3>
          <p>üìå I contenuti generati o supportati da Intelligenza Artificiale sono etichettati con il badge [IA].</p>
        </div>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>Privacy e dati personali</h3>
        <p>üîí Questa lezione non raccoglie dati personali, non prevede login, profilazione o valutazione automatizzata.</p>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <div id="aiStudentWrap">
          <h3>Nota informativa per lo studente</h3>
          <p id="aiStudentNote" class="muted doc-note">‚ÑπÔ∏è In questa lezione l'Intelligenza Artificiale √® stata utilizzata come strumento di supporto dal docente. I contenuti sono stati controllati, adattati e validati prima della pubblicazione.</p>
        </div>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box" id="ethicsCreditsBox">
        <h3>Fonti e crediti (facoltativo)</h3>
        <textarea id="sourcesText" rows="3" placeholder="Es.: NASA (link...), USGS (link...)"></textarea>
      </div>
    </section>
  </template>

  <!-- STEP 6 ‚Äì CONCLUSIONE & FEEDBACK -->
  <template id="tpl-step-6">
    <section class="card">
      <h2>üéØ Conclusione & Feedback</h2>
      <p class="muted doc-note">Chiudi il percorso con un messaggio finale e spunti di chiusura.</p>

      <div class="subsection-gray-box">
        <label>Messaggio di chiusura</label>
        <textarea id="closingText" placeholder="Messaggio finale per lo studente..."></textarea>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>Domande di chiusura del percorso</h3>
        <div class="row">
          <button type="button" class="btn secondary" id="btnAddQ">+ Aggiungi domanda</button>
        </div>
        <div id="qList" class="list"></div>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <h3>Feedback e consegna (link esterno)</h3>
        <p class="small muted doc-note" style="margin-top: .25rem; margin-bottom: .75rem;">
          In questa fase finale puoi inviare al docente riflessioni, commenti, suggerimenti o risposte alle domande di chiusura del percorso. Clicca sul pulsante per aprire il modulo e inviare il tuo feedback.
        </p>
        <label>Link al modulo esterno</label>
        <input id="externalFormUrl" type="url" placeholder="https://...">
        <p class="small muted doc-note">Puoi usare questo modulo esterno per raccogliere feedback, riflessioni, spunti o una valutazione del percorso. Il modulo √® gestito fuori dal template (es. Google Moduli) e pu√≤ essere strutturato liberamente secondo le tue esigenze didattiche.</p>
      </div>

      <div class="hr"></div>
      <div class="subsection-gray-box">
        <div class="desc-box">
          <p style="white-space: pre-line; margin: 0;">
Grazie per aver seguito questo percorso.
Non finisce qui: le domande, le riflessioni e i dubbi che emergono sono parte importante dell'apprendimento.
Continueremo a lavorarci insieme in classe.
          </p>
        </div>
      </div>
      <p class="muted doc-note">Il template non raccoglie risposte; attivit√† e riflessioni vengono riprese in classe.</p>
    </section>
  </template>

  <!-- ============================= -->
  <!-- CONTROLLER (no fetch)        -->
  <!-- ============================= -->
  <script>
    (function(){
      const TOTAL_STEPS = 7; // 0..6
      let current = 0;

      const $ = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));
      const slot = $('#wizardSlot');

      function openStep0Panel(){
        try{
          let el = slot;
          while (el && el !== document.body){
            if (el.hidden) el.hidden = false;
            if (el.style && el.style.display === 'none') el.style.display = '';
            if (el.classList){
              el.classList.remove('hidden','is-hidden','collapsed','is-closed');
            }
            el = el.parentElement;
          }
        }catch(_){}
      }

      const lessonId = (function(){
        const u = new URLSearchParams(location.search);
        const fromUrl = u.get('edit') || u.get('id') || u.get('lesson') || u.get('lessonId');
        if (fromUrl) {
          sessionStorage.setItem('currentDraftId', fromUrl);
          return fromUrl;
        }
        const cached = sessionStorage.getItem('currentDraftId');
        if (cached) return cached;
        const fresh = 'draft_' + Date.now();
        sessionStorage.setItem('currentDraftId', fresh);
        return fresh;
      })();

      // ========== Riparazione automatica step 1-6 mancanti ==========
      (function repairMissingSections() {
        const configKey = 'lesson_config_' + lessonId;
        const configRaw = localStorage.getItem(configKey);
        if (!configRaw) return; // Nessun config, niente da riparare
        
        const section1Key = `lesson_section_${lessonId}_1`;
        if (localStorage.getItem(section1Key)) return; // Step 1 esiste, non serve riparazione
        
        try {
          const cfg = JSON.parse(configRaw);
          const targetTitle = cfg.home?.title || cfg.title || '';
          if (!targetTitle) return; // Senza titolo non possiamo cercare match
          
          // Cerca candidateId con stesso titolo che ha step 1-6
          let candidateId = null;
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (!key.startsWith('lesson_section_')) continue;
            
            const match = key.match(/^lesson_section_(.+?)_1$/);
            if (!match) continue;
            
            const candidate = match[1];
            const candidateConfigKey = 'lesson_config_' + candidate;
            const candidateConfigRaw = localStorage.getItem(candidateConfigKey);
            if (!candidateConfigRaw) continue;
            
            try {
              const candidateCfg = JSON.parse(candidateConfigRaw);
              const candidateTitle = candidateCfg.home?.title || candidateCfg.title || '';
              if (candidateTitle === targetTitle) {
                candidateId = candidate;
                break;
              }
            } catch(e) { continue; }
          }
          
          if (!candidateId) return; // Nessun candidate trovato
          
          // Copia step 1-6 da candidateId a lessonId
          let copied = 0;
          for (let s = 1; s <= 6; s++) {
            const srcKey = `lesson_section_${candidateId}_${s}`;
            const srcData = localStorage.getItem(srcKey);
            if (srcData) {
              const destKey = `lesson_section_${lessonId}_${s}`;
              localStorage.setItem(destKey, srcData);
              copied++;
            }
          }
          
          if (copied > 0) {
            // Traccia migrazione nel config
            cfg.migratedSectionsFrom = candidateId;
            localStorage.setItem(configKey, JSON.stringify(cfg));
          }
        } catch(e) {
          console.warn('Errore riparazione step mancanti', e);
        }
      })();

      // ========== IndexedDB utilities for video blobs ==========
      async function idbOpen(){
        return new Promise((resolve, reject)=>{
          const req = indexedDB.open('ai_school_template', 1);
          req.onerror = () => reject(req.error);
          req.onsuccess = () => resolve(req.result);
          req.onupgradeneeded = (e)=>{
            const db = e.target.result;
            if(!db.objectStoreNames.contains('blobs')){
              db.createObjectStore('blobs', {keyPath: 'key'});
            }
          };
        });
      }

      async function idbPutBlob(key, blob){
        const db = await idbOpen();
        return new Promise((resolve, reject)=>{
          const tx = db.transaction('blobs', 'readwrite');
          const store = tx.objectStore('blobs');
          store.put({key, blob, ts: Date.now()});
          tx.oncomplete = () => resolve();
          tx.onerror = () => {
            const err = tx.error;
            if(err && err.name === 'QuotaExceededError'){
              reject(new Error('QuotaExceededError'));
            }else{
              reject(err || new Error('Transaction failed'));
            }
          };
          tx.onabort = () => reject(new Error('Transaction aborted'));
        });
      }

      async function idbGetBlob(key){
        const db = await idbOpen();
        return new Promise((resolve, reject)=>{
          const tx = db.transaction('blobs', 'readonly');
          const store = tx.objectStore('blobs');
          const req = store.get(key);
          req.onerror = () => reject(req.error);
          req.onsuccess = () => resolve(req.result ? req.result.blob : null);
        });
      }

      async function idbDelBlob(key){
        const db = await idbOpen();
        return new Promise((resolve, reject)=>{
          const tx = db.transaction('blobs', 'readwrite');
          const store = tx.objectStore('blobs');
          const req = store.delete(key);
          req.onerror = () => reject(req.error);
          req.onsuccess = () => resolve();
        });
      }

      function setVideoPreviewFromBlob(videoEl, blob, label){
        try{
          // normalizza: assicurati di avere un <video>, altrimenti cerca il primo video interno
          let v = videoEl;
          if (!(v instanceof HTMLVideoElement)){
            const innerVideo = v && typeof v.querySelector === 'function' ? v.querySelector('video') : null;
            if (innerVideo) v = innerVideo;
          }
          if (!(v instanceof HTMLVideoElement)){
            console.warn('[VIDEO]', label, 'no <video> element found');
            return;
          }
          if (!blob){
            console.warn('[VIDEO]', label, 'blob null/undefined');
            v.hidden = true;
            return;
          }
          console.log('[VIDEO]', label, 'blob ok', { type: blob.type, size: blob.size });
          // reset pulito
          v.pause();
          v.removeAttribute('src');
          v.load();
          v.onloadedmetadata = null;
          v.onloadeddata = null;
          v.onerror = null;
          const url = URL.createObjectURL(blob);
          console.log('[VIDEO]', label, 'objectURL', url);
          v.src = url;
          v.playsInline = true;
          v.controls = true;
          v.muted = true;
          v.hidden = false;
          v.style.display = '';
          const ensureVisible = () => {
            try{
              v.hidden = false;
              v.style.display = '';
              v.style.visibility = 'visible';
              v.style.opacity = '1';
              const wrap = v.closest('.preview-box') || v.closest('#prev-vid-custom');
              if (wrap){
                wrap.hidden = false;
                wrap.style.display = 'block';
                wrap.style.visibility = 'visible';
                wrap.style.opacity = '1';
                wrap.classList && wrap.classList.remove('hidden','is-hidden','collapsed');
              }
            }catch(_){}
          };
          ensureVisible();
          const onOk = () => {
            console.log('[VIDEO]', label, 'loaded OK');
            // Assicura che lo step 0 (wizardSlot e parent) sia visibile per avatar/cover
            if (typeof openStep0Panel === 'function' && (label.includes('avatar') || label.includes('cover'))){
              try{ openStep0Panel(); }catch(_){}
            }
            ensureVisible();
            try{
              v.currentTime = 0.01;
            }catch(_){}
            try{
              const cs = window.getComputedStyle(v);
              const rect = v.getBoundingClientRect();
              console.log('[VIDEO]', label, 'diag', {
                videoWidth: v.videoWidth,
                videoHeight: v.videoHeight,
                display: cs.display,
                visibility: cs.visibility,
                opacity: cs.opacity,
                hasOffsetParent: !!v.offsetParent,
                rect: { width: rect.width, height: rect.height }
              });
              if (rect.width === 0 || rect.height === 0){
                const forceSize = () => {
                  try{
                    v.style.display = 'block';
                    v.style.width = '100%';
                    v.style.maxWidth = '100%';
                    const wrap = v.closest('.preview-box') || v.closest('#prev-vid-custom');
                    if (wrap){
                      wrap.hidden = false;
                      wrap.style.display = 'block';
                      wrap.style.minHeight = '180px';
                    }
                  }catch(_){}
                };
                requestAnimationFrame(()=>{
                  requestAnimationFrame(()=>{
                    ensureVisible();
                    forceSize();
                    try{
                      const r2 = v.getBoundingClientRect();
                      console.log('[VIDEO]', label, 'rect after force', { width: r2.width, height: r2.height });
                    }catch(_){}
                  });
                });
              }
            }catch(_){}
          };
          const onErr = () => {
            console.error('[VIDEO]', label, 'error', v.error);
            v.hidden = true;
          };
          v.onloadedmetadata = onOk;
          v.onloadeddata = onOk;
          v.onerror = onErr;
          v.load();
        }catch(e){
          console.error('[VIDEO]', label, 'exception', e);
          if (videoEl) videoEl.hidden = true;
        }
      }

      async function loadVideoPreviewFromIdb(key, videoEl){
        try{
          console.log('[VIDEO] loadVideoPreviewFromIdb start', { key });
          const blob = await idbGetBlob(key);
          if(!blob){
            console.warn('[VIDEO] loadVideoPreviewFromIdb blob null', { key });
            videoEl.hidden = true;
            return;
          }
          console.log('[VIDEO] loadVideoPreviewFromIdb blob ok', { key, type: blob.type, size: blob.size });
          // Token incrementale per evitare stale load
          const token = String(Date.now()) + ':' + Math.random();
          videoEl.dataset.loadToken = token;
          // usa helper comune per preview da Blob (senza revoca anticipata)
          setVideoPreviewFromBlob(videoEl, blob, `idb:${key}`);
        }catch(err){
          console.error('Errore caricamento video da IDB:', err);
          videoEl.hidden = true;
        }
      }

      // ====== STATE di base (Step 0) ======
      const state = {
        avatar: { mode:'logo', url:'assets/brand/logo_edubot_icon.png', audio:false, picked:null },
        // FIX: estendo info copertina con kind/source/name
        intro:  { 
          type:'none',                       // 'none' | 'image' | 'video' (semantico)
          kind:null,                         // 'image' | 'video' (derivato)
          source:null,                       // 'file' | 'url'
          name:'',                           // filename o url mostrabile
          image:{url:'',alt:''},
          video:{url:'',thumbnail:'',transcript:'',summary:''}
        }
      };

      function init() {
        if (location.protocol === 'file:') $('#envBanner').style.display = 'block';
        buildPills();
        bindNav();
        goTo(0);
      }

      function buildPills(){
        const wrap = $('#stepPills'); wrap.innerHTML = '';
        const labels = ['Home della lezione','Lezione','Attivit√†','Risorse','Valutazione & Riflessione','Info & Etica','Conclusione & Feedback'];
        for (let i=0;i<TOTAL_STEPS;i++){
          const span = document.createElement('span');
          span.className = 'pill' + (i===current?' active':'');
          span.textContent = labels[i];
          span.addEventListener('click',()=>{ saveCurrent(true); goTo(i); });
          wrap.appendChild(span);
          if (i === 0) {
            const breakEl = document.createElement('span');
            breakEl.className = 'steps-break';
            wrap.appendChild(breakEl);
          }
        }
      }

      function goTo(n){
        current = Math.max(0, Math.min(TOTAL_STEPS-1, n));
        const tpl = document.getElementById('tpl-step-' + current);
        slot.innerHTML = tpl ? tpl.innerHTML : '<section class="card"><p>Step non disponibile.</p></section>';
        buildPills();
        updateNavButtons();
        afterMount(current);
        window.scrollTo({top:0,behavior:'smooth'});
      }

      function bindNav(){
        $('#btnPrev')?.addEventListener('click', ()=> { if(current>0) goTo(current-1); });
        $('#btnNext').setAttribute('data-action','next');
        $('#btnDraft').setAttribute('data-action','save-draft');
        $('#btnNext').addEventListener('click', ()=> {
          if (current===0 && !validateHome()) return;
          saveCurrent(true);
          goTo(current+1);
        });
        $('#btnDraft').addEventListener('click', (e)=> {
          e.preventDefault();
          // Step 0: obbligatori Titolo + Descrizione anche per salvare
          if (typeof current !== 'undefined' && current === 0) {
            const title = ($('#home-title')?.value || '').trim();
            const desc  = ($('#home-desc')?.value || '').trim();
            if (!title || title.length < 3) {
              alert('‚ö†Ô∏è Inserisci il Titolo (min 3 caratteri)');
              showStep0Errors();
              const t = $('#home-title');
              if (t) t.focus();
              return;
            }
            if (!desc || desc.length < 3) { alert('‚ö†Ô∏è Inserisci la Descrizione breve'); showStep0Errors(); return; }
          }
          if (!canSaveDraft()) {
            e.preventDefault();
            showStep0Errors();
            return;
          }
          saveCurrent(true);
          alert('‚úÖ Bozza salvata');
        });
               $('#btnPreview').addEventListener('click', ()=> {
          if (!validateHome()) return;
          saveCurrent(true);

          // Apri anteprima NELLA STESSA SCHEDA e passa un "return" per tornare al wizard.
          const returnUrl = `${location.pathname}?edit=${encodeURIComponent(lessonId)}`;
          const previewUrl = `percorso-tematico.html?lesson=${encodeURIComponent(lessonId)}&return=${encodeURIComponent(returnUrl)}&dashboard=${encodeURIComponent('teacher-dashboard.html')}`;

          location.href = previewUrl;
        });

      }
      
      function updateNavButtons(){
        const prevBtn = $('#btnPrev');
        if (prevBtn) {
          if (current===0) {
            prevBtn.style.display = 'none';
          } else {
            prevBtn.style.display = '';
          }
        }
        const nextBtn = $('#btnNext');
        const finalizeBtn = $('#btnFinalize');
        if (current === 6) {
          if (nextBtn) nextBtn.style.display = 'none';
          if (finalizeBtn) finalizeBtn.style.display = '';
        } else {
          if (nextBtn) nextBtn.style.display = '';
          if (finalizeBtn) finalizeBtn.style.display = 'none';
        }
      }

      // ========= SAVE per step =========
      function saveCurrent(isDraft=false){
        // Controllo minimo: Titolo + Descrizione obbligatori per salvataggio bozza
        if (isDraft && current === 0){
          const titleEl = $('#home-title');
          const descEl  = $('#home-desc');
          const title = titleEl?.value?.trim() || '';
          const desc  = descEl?.value?.trim() || '';
          let invalid = false;
          // Blocca solo se ENTRAMBI sono vuoti
          if (!title && !desc){
            if (titleEl){ titleEl.classList.add('input-error'); titleEl.focus(); }
            if (descEl){ descEl.classList.add('input-error'); }
            invalid = true;
          } else {
            // Rimuovi errori se almeno uno √® compilato
            if (titleEl){ titleEl.classList.remove('input-error'); }
            if (descEl){ descEl.classList.remove('input-error'); }
          }
          if (invalid){
            alert('‚ö†Ô∏è Per salvare la bozza compila Titolo e Descrizione nella Home.');
            return;
          }
        }
        if (current===0){
          const data = collectHome();
          const now = new Date().toISOString();
          // ===== Helpers per pointer sessione (evitare quota localStorage)
          function ssKey(kind){ return `session_blob_${lessonId}_${kind}`; }
          function toSessionPointer(kind, dataUrl){
            try{ sessionStorage.setItem(ssKey(kind), dataUrl); return `session://${kind}`; }
            catch(e){ console.warn('SessionStorage set failed', e); return dataUrl; }
          }
          const prev = localStorage.getItem('lesson_config_'+lessonId);
          const prevCfg = prev ? JSON.parse(prev) : null;
          const createdAt = prevCfg?.meta?.createdAt || now;

          // Calcolo versione avatar per cache-busting dashboard
          const newAvatarMode = state.avatar.mode;
          const newAvatarUrl  = state.avatar.url || '';
          // Risolve i pointer session://... in un vero dataURL preso da sessionStorage
function resolveSessionPointer(u){
  if(!u || typeof u !== 'string') return u;
  if(!u.startsWith('session://')) return u;
  const kind = u.replace('session://','').trim(); // es: avatar_image / avatar_video / cover_image / cover_video
  const key  = `session_blob_${lessonId}_${kind}`;
  return sessionStorage.getItem(key) || '';
}

const newAvatarSrcRaw = state.avatar.src || newAvatarUrl || '';

let avatarVersion = prevCfg?.meta?.avatarVersion || 0;
const prevAvatarKey = (prevCfg?.avatarMode||'') + '|' + (prevCfg?.avatarSrc||prevCfg?.avatar||'');
const newAvatarKey  = newAvatarMode + '|' + newAvatarSrcRaw;
if (prevAvatarKey !== newAvatarKey) {
  avatarVersion += 1;
}

          const cfg = {
            id: lessonId,
            meta: {
              author: $('#meta-author')?.value?.trim() || '',
              duration: $('#meta-duration')?.value?.trim() || '',
              cefr: $('#meta-cefr')?.value || '',
              pfi: $('#meta-pfi')?.value?.trim() || '',
              updatedAt: now, createdAt,
              avatarVersion
            },
            home: {
              ...data,
              introType: state.intro?.type || 'none',
              heroKind: state.intro?.kind || null,            // FIX: nuovo
              heroSource: state.intro?.source || null,        // FIX: nuovo
              heroName: state.intro?.name || '',              // FIX: nuovo (filename/url)
              heroImage: state.intro?.image?.url || '',
              heroImageAlt: state.intro?.image?.alt || '',
              heroVideo: state.intro?.video?.url || '',
              heroVideoThumb: state.intro?.video?.thumbnail || '',
              // FIX: persisto anche i campi descrittivi del video in home
              videoTranscript: state.intro?.video?.transcript || '',
              videoSummary: state.intro?.video?.summary || ''
            },
        avatarMode: newAvatarMode,
        avatar: newAvatarUrl,
        avatarType: state.avatar.type || (state.avatar.picked? 'preset' : ''),
        avatarSrc: newAvatarSrcRaw,
        avatarBlobKey: (function(){
          // Salva la chiave IDB per video locale
          if (newAvatarMode === 'video' && newAvatarUrl === 'session://avatar_video') {
            const avatarVideoKey = `session_blob_${lessonId}_avatar_video`;
            const idbPointer = sessionStorage.getItem(avatarVideoKey);
            if (idbPointer && idbPointer.startsWith('idb://')) {
              return idbPointer.replace('idb://', ''); // Estrae solo la chiave (es: "lessonId::avatar_video")
            }
          }
          return undefined;
        })(),
        avatarImageBlobKey: (function(){
          // Salva la chiave IDB per immagine locale
          if (newAvatarMode === 'image' && newAvatarUrl === 'session://avatar_image') {
            const avatarImageKey = `session_blob_${lessonId}_avatar_image`;
            const idbPointer = sessionStorage.getItem(avatarImageKey);
            if (idbPointer && idbPointer.startsWith('idb://')) {
              return idbPointer.replace('idb://', ''); // Estrae solo la chiave (es: "lessonId::avatar_image")
            }
          }
          return undefined;
        })(),
        coverImageBlobKey: (function(){
          // Salva la chiave IDB per immagine copertina locale
          if (state.intro.type === 'image' && state.intro.image.url === 'session://cover_image') {
            const coverImageKey = `session_blob_${lessonId}_cover_image`;
            const idbPointer = sessionStorage.getItem(coverImageKey);
            if (idbPointer && idbPointer.startsWith('idb://')) {
              return idbPointer.replace('idb://', ''); // Estrae solo la chiave (es: "lessonId::cover_image")
            }
          }
          return undefined;
        })(),
        coverVideoBlobKey: (function(){
          // Salva la chiave IDB per video copertina locale
          if (state.intro.type === 'video' && state.intro.video.url === 'session://cover_video') {
            const coverVideoKey = `session_blob_${lessonId}_cover_video`;
            const idbPointer = sessionStorage.getItem(coverVideoKey);
            if (idbPointer && idbPointer.startsWith('idb://')) {
              return idbPointer.replace('idb://', ''); // Estrae solo la chiave (es: "lessonId::cover_video")
            }
          }
          return undefined;
        })(),
        avatarPicked: (function(){
              if(state.avatar.picked) return state.avatar.picked; // 'logo', 'img-f-default', ...
              if(newAvatarMode==='image' && !state.avatar.picked) return 'img_custom';
              if(newAvatarMode==='video' && !state.avatar.picked) return 'vid_custom';
              return 'logo';
            })(),
            avatarAudio: state.avatar.audio || false,
            introType: state.intro.type,
            // FIX: mantengo anche i campi flat per r√©tro-compatibilit√†
            heroKind: state.intro.kind || null,
            heroSource: state.intro.source || null,
            heroName: state.intro.name || '',
            heroImage: state.intro.image.url || '',
            heroImageAlt: state.intro.image.alt || '',
            heroVideo: state.intro.video.url || '',
            heroVideoThumb: state.intro.video.thumbnail || '',
            // FIX: per retro-compatibilit√† coi campi flat gi√† esistenti
            introVideoTranscript: state.intro?.video?.transcript || '',
            introVideoSummary: state.intro?.video?.summary || '',
            useIA:false,
            isDraft: !!isDraft,
            currentStep: current,
            updatedAt: now
          };
          try{
            localStorage.setItem('lesson_config_'+lessonId, JSON.stringify(cfg));
            window.onbeforeunload = null;
          }catch(e){
            console.warn('LocalStorage quota, ritento con pointer forzati', e);
            if(/^data:/.test(cfg.home.heroImage)) cfg.home.heroImage = toSessionPointer('cover_image', cfg.home.heroImage);
            if(/^data:/.test(cfg.home.heroVideo)) cfg.home.heroVideo = toSessionPointer('cover_video', cfg.home.heroVideo);
            if(/^data:/.test(cfg.avatarSrc)){
              const avatarKind = (cfg.avatarMode === 'video') ? 'avatar_video' : 'avatar_image';
              cfg.avatarSrc = toSessionPointer(avatarKind, cfg.avatarSrc);
            }
            if(/^data:/.test(cfg.avatar)){
              const avatarKind = (cfg.avatarMode === 'video') ? 'avatar_video' : 'avatar_image';
              cfg.avatar = toSessionPointer(avatarKind, cfg.avatar);
            }
            try{ localStorage.setItem('lesson_config_'+lessonId, JSON.stringify(cfg)); window.onbeforeunload = null; }
            catch(e2){ alert('‚ö†Ô∏è Spazio locale insufficiente per salvare in bozza. Riduci il peso dei media o usa URL esterni.'); }
          }
          sessionStorage.setItem('currentDraftId', lessonId);
          return;
        }

        // step 1‚Äì6
        const payload = collectStep(current);
        try {
          localStorage.setItem(`lesson_section_${lessonId}_${current}`, JSON.stringify(payload));
          window.onbeforeunload = null;
        } catch (e) {
          alert('Errore salvataggio: spazio insufficiente o dati troppo grandi.');
          console.error(e);
        }
      }

      // ========= LOAD per step =========
      function loadStep(step){
        if (step===0){
          const raw = localStorage.getItem('lesson_config_'+lessonId);
          if (!raw) return;
          const cfg = JSON.parse(raw);
          // base fields
                    $('#home-title') && ($('#home-title').value = cfg.home?.title || '');
          $('#home-desc') && ($('#home-desc').value = cfg.home?.description || '');
          $('#home-context') && ($('#home-context').value = cfg.home?.context || '');

          $('#home-tags') && ($('#home-tags').value = cfg.home?.tags || '');
          $('#meta-author') && ($('#meta-author').value = cfg.meta?.author || '');
          $('#meta-duration') && ($('#meta-duration').value = cfg.meta?.duration || '');
          if ($('#meta-cefr')){
            const allowed = ['A0','A1','A2','B1','B2'];
            const val = cfg.meta?.cefr || 'A2';
            $('#meta-cefr').value = allowed.includes(val) ? val : 'A2';
          }
          $('#meta-pfi') && ($('#meta-pfi').value = cfg.meta?.pfi || '');
          // state avatar/intro
          state.avatar.mode = cfg.avatarMode || 'logo';
          state.avatar.url = cfg.avatar || 'assets/brand/logo_edubot_icon.png';
          state.avatar.audio = !!cfg.avatarAudio;
          state.avatar.picked = cfg.avatarPicked || null;
          state.avatar.type = cfg.avatarType || state.avatar.type || undefined;
          state.avatar.src  = cfg.avatarSrc  || state.avatar.url || undefined;
          // Fix: ripristina correttamente i preset video
          if (state.avatar.picked === 'vid-m-default' || state.avatar.picked === 'vid-f-default') {
            state.avatar.mode = 'video';
            state.avatar.type = 'preset';
            state.avatar.url = cfg.avatar || cfg.avatarSrc;
            state.avatar.src = state.avatar.url;
          }
          // Normalizzazione fallback: se avatarPicked mancante ma src punta a preset video
          const srcPreset = (state.avatar.src || state.avatar.url || '').toString();
          if (state.avatar.picked !== 'vid-f-default' && state.avatar.picked !== 'vid-m-default') {
            if (srcPreset.includes('assets/video/intro_f.mp4')) {
              state.avatar.picked = 'vid-f-default';
              state.avatar.mode = 'video';
              state.avatar.type = 'preset';
              state.avatar.url = 'assets/video/intro_f.mp4';
              state.avatar.src = state.avatar.url;
            } else if (srcPreset.includes('assets/video/intro_m.mp4')) {
              state.avatar.picked = 'vid-m-default';
              state.avatar.mode = 'video';
              state.avatar.type = 'preset';
              state.avatar.url = 'assets/video/intro_m.mp4';
              state.avatar.src = state.avatar.url;
            }
          }
          // Normalizzazione fallback: se avatarPicked mancante ma src punta a preset immagine
          if (state.avatar.picked !== 'img-f-default' && state.avatar.picked !== 'img-m-default') {
            if (srcPreset.includes('assets/avatars/avatar_edubot_female.png')) {
              state.avatar.picked = 'img-f-default';
              state.avatar.mode = 'image';
              state.avatar.type = 'preset';
              state.avatar.url = 'assets/avatars/avatar_edubot_female.png';
              state.avatar.src = state.avatar.url;
            } else if (srcPreset.includes('assets/avatars/avatar_edubot_default.png')) {
              state.avatar.picked = 'img-m-default';
              state.avatar.mode = 'image';
              state.avatar.type = 'preset';
              state.avatar.url = 'assets/avatars/avatar_edubot_default.png';
              state.avatar.src = state.avatar.url;
            }
          }
          // Ricrea puntatore sessionStorage per immagine custom da IDB
          if (state.avatar.mode === 'image' && state.avatar.url === 'session://avatar_image' && cfg.avatarImageBlobKey) {
            const avatarImageKey = `session_blob_${lessonId}_avatar_image`;
            sessionStorage.setItem(avatarImageKey, 'idb://' + cfg.avatarImageBlobKey);
          }
          // Ricrea puntatore sessionStorage per video custom da IDB
          if (state.avatar.mode === 'video' && state.avatar.url === 'session://avatar_video' && cfg.avatarBlobKey) {
            const avatarVideoKey = `session_blob_${lessonId}_avatar_video`;
            sessionStorage.setItem(avatarVideoKey, 'idb://' + cfg.avatarBlobKey);
          }
          // Ricrea puntatore sessionStorage per immagine copertina da IDB
          if (cfg.coverImageBlobKey) {
            const coverImageKey = `session_blob_${lessonId}_cover_image`;
            sessionStorage.setItem(coverImageKey, 'idb://' + cfg.coverImageBlobKey);
          }
          // Ricrea puntatore sessionStorage per video copertina da IDB
          if (cfg.coverVideoBlobKey) {
            const coverVideoKey = `session_blob_${lessonId}_cover_video`;
            sessionStorage.setItem(coverVideoKey, 'idb://' + cfg.coverVideoBlobKey);
          }
          state.intro.type = cfg.introType || 'none';
          state.intro.kind = cfg.heroKind || cfg.home?.heroKind || null;
          state.intro.source = cfg.heroSource || cfg.home?.heroSource || null;
          state.intro.name = cfg.heroName || cfg.home?.heroName || '';
          state.intro.image.url = cfg.heroImage || '';
          state.intro.image.alt = cfg.heroImageAlt || '';
          state.intro.video.url = cfg.heroVideo || '';
          state.intro.video.thumbnail = cfg.heroVideoThumb || cfg.home?.heroVideoThumb || '';
          state.intro.video.transcript = cfg.introVideoTranscript || cfg.home?.videoTranscript || '';
          state.intro.video.summary = cfg.introVideoSummary || cfg.home?.videoSummary || '';
          // reflect UI (avatar radio coerente con scelta salvata)
          (function reflectAvatarRadio(){
            const radios = $$('input[name="avatarMode"]');
            const picked = cfg.avatarPicked || state.avatar.picked;
            let v = 'logo';
            if (picked === 'logo') v = 'logo';
            else if (picked === 'img-f-default') v = 'img_f';
            else if (picked === 'img-m-default') v = 'img_m';
            else if (picked === 'vid-f-default') v = 'vid_f';
            else if (picked === 'vid-m-default') v = 'vid_m';
            else if (state.avatar.mode === 'image') v = 'img_custom';
            else if (state.avatar.mode === 'video') v = 'vid_custom';
            const r = Array.from(radios).find(r=> r.value===v);
            if (r) r.checked = true;
            updateAvatarUI(true);
          })();
          
          // FIX: ricostruzione coverMode selezionato + UI + preview + etichetta nome
          (function reflectCoverMode(){
            const setRadio = (val) => {
              const r = document.querySelector(`#coverModeWrap input[name="coverMode"][value="${val}"]`);
              if (r) r.checked = true;
            };
            const showRow = (id) => {
              ['row-none','row-image_file','row-image_url','row-video_file','row-video_url'].forEach(x=>{
                const el = document.getElementById(x); if (el) el.style.display = (x===id)?'block':'none';
              });
            };
            const setMeta = (txt) => {
              const m = document.getElementById('coverMeta'); if(!m) return;
              if (txt) { 
              m.textContent = `Sorgente: ${txt}`; 
              m.classList.add('truncate-line');
              m.title = txt;
              m.hidden = false; 
            } else { 
              m.textContent=''; 
              m.classList.remove('truncate-line');
              m.title = '';
              m.hidden=true; 
            }
            };

            // Heuristic da stato salvato
            const type  = state.intro.type;               // none | image | video
            const src   = (type==='image') ? state.intro.image.url : (type==='video' ? state.intro.video.url : '');
            const kind  = state.intro.kind || (type!=='none' ? type : null);
            const fromSession = (s)=> s && s.startsWith('session://');
            const isYT = (u)=> /youtu\.be|youtube\.com/.test(u||'');

            if (type==='none' || !src){
              setRadio('none'); showRow('row-none'); setMeta('');
              return;
            }

            if (kind==='image' || type==='image'){
              if (fromSession(src)) {
                // file immagine salvato in sessione
                setRadio('image_file'); showRow('row-image_file');
                const stored = sessionStorage.getItem(`session_blob_${lessonId}_cover_image`) || '';
                const img = document.getElementById('coverPreviewImage');
                if(stored && stored.startsWith('idb://')){
                  // Immagine da IndexedDB
                  const idbKey = stored.replace('idb://','');
                  idbGetBlob(idbKey).then(blob => {
                    if(blob && img){
                      const url = URL.createObjectURL(blob);
                      img.src = url;
                      img.hidden = false;
                      showPreviewBoxOf(img);
                      const nameEl = document.getElementById('coverFileImageName');
                      if (nameEl) nameEl.textContent = state.intro.name || '(file immagine)';
                      setMeta('(file in sessione) cover_image');
                      const altIn = document.getElementById('introImageAlt');
                      if (altIn) altIn.value = state.intro.image.alt || '';
                    }
                  }).catch(err => {
                    console.error('Errore caricamento immagine copertina da IDB:', err);
                    const nameEl = document.getElementById('coverFileImageName');
                    if (nameEl) nameEl.textContent = '(file non disponibile: ri-seleziona)';
                    if (img){ img.removeAttribute('src'); img.hidden = true; hidePreviewBoxOf(img); }
                    setMeta('(file non disponibile in questa sessione)');
                    const altIn = document.getElementById('introImageAlt');
                    if (altIn) altIn.value = state.intro.image.alt || '';
                  });
                }else if (!stored) {
                  // FIX: se la sessione √® persa, non lasciare la UI "vuota"
                  // fallback: segnala assenza e non mostrare pannello nero
                  const nameEl = document.getElementById('coverFileImageName');
                  if (nameEl) nameEl.textContent = '(file non disponibile: ri-seleziona)';
                  // evitare preview "vuota"
                  if (img){ img.removeAttribute('src'); img.hidden = true; hidePreviewBoxOf(img); }
                  setMeta('(file non disponibile in questa sessione)');
                  // FIX: ripristina ALT (file) anche se sessione persa
                  const altIn = document.getElementById('introImageAlt');
                  if (altIn) altIn.value = state.intro.image.alt || '';
                  return;
                }else{
                  // Fallback per dataURL legacy (se presente)
                  if (img){ img.src = stored; img.hidden = !stored; }
                  showPreviewBoxOf(img);
                  const nameEl = document.getElementById('coverFileImageName');
                  if (nameEl) nameEl.textContent = state.intro.name || '(file immagine)';
                  setMeta('(file in sessione) cover_image');
                  const altIn = document.getElementById('introImageAlt');
                  if (altIn) altIn.value = state.intro.image.alt || '';
                }
              } else {
                // URL immagine
                setRadio('image_url'); showRow('row-image_url');
                const urlIn = document.getElementById('coverUrlImage');
                if (urlIn) urlIn.value = src;
                const img = document.getElementById('coverPreviewImageURL');
                if (img){ img.src = src; img.hidden = !src; }
                // FIX: assicura la visualizzazione del contenitore .preview-box su load
                showPreviewBoxOf(img);
                // FIX: ripristina ALT (URL)
                const altIn = document.getElementById('introImageAltURL');
                if (altIn) altIn.value = state.intro.image.alt || '';
                setMeta(src);
              }
              return;
            }

            if (kind==='video' || type==='video'){
              if (fromSession(src)) {
                // file video salvato in sessione
                setRadio('video_file'); showRow('row-video_file');
                const stored = sessionStorage.getItem(`session_blob_${lessonId}_cover_video`) || '';
                const v = document.getElementById('coverPreviewVideo');
                if(stored && stored.startsWith('idb://')){
                  // Video da IndexedDB
                  const idbKey = stored.replace('idb://','');
                  if(v){
                    v.playsInline = true; v.muted = false; v.controls = true;
                    loadVideoPreviewFromIdb(idbKey, v).catch(err=>{
                      console.error('Errore caricamento video cover da IDB:', err);
                    });
                  }
                  showPreviewBoxOf(v);
                  const nameEl = document.getElementById('coverFileVideoName');
                  if (nameEl) nameEl.textContent = state.intro.name || '(file video)';
                  setMeta('(file in sessione) cover_video');
                }else if (!stored) {
                  // FIX: se la sessione √® persa, non lasciare la UI "vuota"
                  // fallback: segnala assenza e non mostrare pannello nero
                  const nameEl = document.getElementById('coverFileVideoName');
                  if (nameEl) nameEl.textContent = '(file non disponibile: ri-seleziona)';
                  // evitare preview "vuota"
                  if (v){ v.removeAttribute('src'); v.hidden = true; hidePreviewBoxOf(v); }
                  setMeta('(file non disponibile in questa sessione)');
                  // FIX: ripristina trascrizione/riassunto per video file anche se sessione persa
                  const transIn = document.getElementById('introVideoTranscript');
                  if (transIn) transIn.value = state.intro.video.transcript || '';
                  const summIn = document.getElementById('introVideoSummary');
                  if (summIn) summIn.value = state.intro.video.summary || '';
                  return;
                }else{
                  // Video da sessionStorage (dataURL)
                  if (v){ v.src = stored; v.hidden = !stored; v.playsInline = true; v.muted = false; v.controls = true; v.load(); }
                  // FIX: assicura la visualizzazione del contenitore .preview-box su load
                  showPreviewBoxOf(v);
                  const nameEl = document.getElementById('coverFileVideoName');
                  if (nameEl) nameEl.textContent = state.intro.name || '(file video)';
                  setMeta('(file in sessione) cover_video');
                }
                // FIX: ripristina trascrizione/riassunto per video file
                const transIn = document.getElementById('introVideoTranscript');
                if (transIn) transIn.value = state.intro.video.transcript || '';
                const summIn = document.getElementById('introVideoSummary');
                if (summIn) summIn.value = state.intro.video.summary || '';
              } else {
                // URL video (YouTube incluso)
                clearPreview();
                setRadio('video_url'); showRow('row-video_url');
                const urlIn = document.getElementById('coverUrlVideo');
                if (urlIn) urlIn.value = src;
                const link = document.getElementById('coverPreviewYTLink');
                const thumb= document.getElementById('coverPreviewYTThumb');
                const v    = document.getElementById('coverPreviewVideoURL');
                if (isYT(src)) {
                  // FIX: usa regex estesa per YT (shorts, youtu.be, watch?v=, embed/)
                  const extractYTId = (u)=>{
                    if(!u) return null;
                    try{
                      const url = new URL(u, location.origin);
                      if ((/youtube\.com$/i).test(url.hostname) || (/youtube\.com$/i).test(url.hostname.replace(/^www\./,''))) {
                        if (url.searchParams.get('v')) {
                          return url.searchParams.get('v').trim().slice(0,11);
                        }
                        const em = url.pathname.match(/\/embed\/([A-Za-z0-9_-]{11})/);
                        if (em) return em[1];
                        const sh = url.pathname.match(/\/shorts\/([A-Za-z0-9_-]{11})/);
                        if (sh) return sh[1];
                      }
                      if ((/youtu\.be$/i).test(url.hostname) || (/youtu\.be$/i).test(url.hostname.replace(/^www\./,''))) {
                        const m = url.pathname.match(/\/([A-Za-z0-9_-]{11})/);
                        if (m) return m[1];
                      }
                    }catch(_){
                      const m = (u||'').match(/(?:youtu\.be\/|embed\/|shorts\/|watch\?v=)([A-Za-z0-9_-]{11})/);
                      if (m) return m[1];
                    }
                    return null;
                  };
                  const id = extractYTId(src);
                  if (id && link && thumb){
                    link.href = `https://www.youtube.com/watch?v=${id}`;
                    thumb.src = `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
                    link.hidden = false;
                    if (v){ v.hidden = true; try{ v.pause(); }catch(_){} v.removeAttribute('src'); v.load(); }
                    setMeta(link.href);
                  } else {
                    // Se non estraiamo ID, ripieghiamo su semplice link testuale
                    if (link){
                      link.href = src;
                      link.hidden = false;
                      if (thumb){ thumb.removeAttribute('src'); }
                      setMeta(src);
                    }
                    if (v){ v.hidden = true; try{ v.pause(); }catch(_){} v.removeAttribute('src'); v.load(); }
                  }
                } else {
                  if (v){ v.src = src; v.hidden = !src; v.playsInline = true; v.muted = false; v.controls = true; v.load(); }
                  // FIX: assicura la visualizzazione del contenitore .preview-box su load
                  showPreviewBoxOf(v);
                  if (link) link.hidden = true;
                  setMeta(src);
                }
                // FIX: ripristina trascrizione/riassunto per video URL (YT incluso)
                const transUrlIn = document.getElementById('introVideoTranscriptURL');
                if (transUrlIn) transUrlIn.value = state.intro.video.transcript || '';
                const summUrlIn = document.getElementById('introVideoSummaryURL');
                if (summUrlIn) summUrlIn.value = state.intro.video.summary || '';
              }
            }
          })();
          
          return;
        }

        const raw = localStorage.getItem(`lesson_section_${lessonId}_${step}`);
        if (!raw) return;
        const data = JSON.parse(raw);

        if (step===1){
          $('#lesson-title') && ($('#lesson-title').value = data.title || '');
          $('#lesson-objectives') && ($('#lesson-objectives').value = data.objectives || '');
          $('#lessonText') && ($('#lessonText').value = data.text || '');
          // immagini
          const imgList = $('#imgList'); (data.images||[]).forEach(addImageItemUI);
          // video
          const vidList = $('#vidList'); (data.videos||[]).forEach(addVideoItemUI);
          // glossario
          (data.glossary||[]).forEach(item => {
            // Compatibilit√†: se esiste translation o note, ignorare
            addGlossItemUI({ term: item.term || '', explain: item.explain || '' });
          });
          // mappa
          $('#conceptImageUrl') && ($('#conceptImageUrl').value = data.concept?.imageUrl || '');
          $('#conceptImageAlt') && ($('#conceptImageAlt').value = data.concept?.imageAlt || '');
          const conceptMapBox = $('#conceptMapBox');
          if (conceptMapBox && data.concept?.blobKey) {
            conceptMapBox.dataset.conceptBlobKey = data.concept.blobKey;
          }
          // Aggiorna visibilit√† pulsante Elimina
          const cu = $('#conceptImageUrl');
          const btnDelUrl = $('#btnDelConceptUrl');
          if (cu && cu.value && cu.value.trim()) {
            if (btnDelUrl) btnDelUrl.style.display = 'inline-block';
          } else {
            if (btnDelUrl) btnDelUrl.style.display = 'none';
          }
          return;
        }

        if (step===2){
          // Domande di comprensione
          if (data.comprehensionQuestions){
            $('#cq1') && ($('#cq1').value = data.comprehensionQuestions[0]?.question || '');
            $('#cq2') && ($('#cq2').value = data.comprehensionQuestions[1]?.question || '');
            $('#cq3') && ($('#cq3').value = data.comprehensionQuestions[2]?.question || '');
          }
          // Attivit√† creativa
          $('#creativeActivity') && ($('#creativeActivity').value = data.creativeActivity || '');
          // Compito di realt√†
          if (data.realTask){
            $('#rtTitle').value = data.realTask.title || '';
            $('#rtDesc').value = data.realTask.desc || '';
            $('#rtEval').value = data.realTask.eval || '';
          }
          // Attivit√† online esterne
          (data.extQuiz||[]).forEach(addExtQuizItemUI);
          return;
        }

        if (step===3){
          (data.links||[]).forEach(addLinkItemUI);
          (data.docs||[]).forEach(addDocItemUI);
          (data.media||[]).forEach(addResVidItemUI);
          $('#teacherNotes') && ($('#teacherNotes').value = data.notes || '');
          return;
        }

        if (step===4){
          (data.quiz || []).forEach(addQuestionItemUI);
          const topics = data.self?.topics || data.self?.items || [];
          $('#selfTopic1') && ($('#selfTopic1').value = topics[0] || '');
          $('#selfTopic2') && ($('#selfTopic2').value = topics[1] || '');
          $('#selfTopic3') && ($('#selfTopic3').value = topics[2] || '');
          $('#selfTopic4') && ($('#selfTopic4').value = topics[3] || '');
          $('#selfTopic5') && ($('#selfTopic5').value = topics[4] || '');
          $('#selfScale') && ($('#selfScale').value = data.self?.scale || '');
          (data.reflection?.questions || []).forEach(q => addReflectionItemUI({q}));
          return;
        }

        if (step===5){
          const aiUsed = !!data.aiUsed;
          const yesRadio = document.querySelector('input[name="aiUsedChoice"][value="yes"]');
          const noRadio = document.querySelector('input[name="aiUsedChoice"][value="no"]');
          if (aiUsed && yesRadio) yesRadio.checked = true;
          if (!aiUsed && noRadio) noRadio.checked = true;
          $('#aiUsageDesc') && ($('#aiUsageDesc').value = data.aiUsageDesc || '');
          $('#aiTools') && ($('#aiTools').value = data.aiTools || '');
          $('#sourcesText') && ($('#sourcesText').value = data.sourcesText || '');
          updateAiVisibility(aiUsed);
          return;
        }

        if (step===6){
          $('#closingText') && ($('#closingText').value = data.closing || '');
          (data.closingQuestions || data.questions || []).forEach(q => addClosingQItemUI(q));
          $('#externalFormUrl') && ($('#externalFormUrl').value = data.externalFormUrl || '');
          return;
        }
      }

      // ========= COLLECT per step =========
            function collectHome(){
        return {
          title: $('#home-title')?.value?.trim() || '',
          description: $('#home-desc')?.value?.trim() || '',
          context: $('#home-context')?.value?.trim() || '',
          tags: $('#home-tags')?.value?.trim() || '',
          goals: []
        };
      }


      function collectStep(step){
        if (step===1){
          const images = $$('#imgList .item').map(it=>{
            return {
              url: it.querySelector('[name="url"]').value.trim(),
              alt: it.querySelector('[name="alt"]').value.trim(),
              blobKey: it.dataset.blobKey || ''
            };
          }).filter(x=>x.url || x.blobKey);
          const videos = $$('#vidList .item').map(it=>({
            url: it.querySelector('[name="url"]').value.trim(),
            transcript: it.querySelector('[name="trans"]').value.trim(),
            summary: it.querySelector('[name="summary"]').value.trim(),
            blobKey: it.dataset.blobKey || ''
          })).filter(x=>x.url || x.blobKey);
          const glossary = $$('#glossList .item').map(it=>({
            term: it.querySelector('[name="term"]').value.trim(),
            explain: it.querySelector('[name="explain"]').value.trim()
          })).filter(x=>x.term);
          return {
            title: $('#lesson-title')?.value?.trim() || '',
            objectives: $('#lesson-objectives')?.value?.trim() || '',
            text: $('#lessonText')?.value?.trim() || '',
            images, videos, glossary,
            concept: (() => {
              const urlValue = $('#conceptImageUrl')?.value?.trim() || '';
              const altValue = $('#conceptImageAlt')?.value?.trim() || '';
              const conceptMapBox = $('#conceptMapBox');
              const blobKey = conceptMapBox?.dataset.conceptBlobKey || '';
              // Se tutti vuoti, salva oggetto vuoto
              if (!urlValue && !altValue && !blobKey) {
                return {};
              }
              return {
                imageUrl: urlValue,
                imageAlt: altValue,
                blobKey: blobKey
              };
            })()
          };
        }
        if (step===2){
          const comprehensionQuestions = [
            { question: $('#cq1')?.value?.trim() || '' },
            { question: $('#cq2')?.value?.trim() || '' },
            { question: $('#cq3')?.value?.trim() || '' }
          ];
          const creativeActivity = $('#creativeActivity')?.value?.trim() || '';
          const realTask = {
            title: $('#rtTitle')?.value?.trim() || '',
            desc: $('#rtDesc')?.value?.trim() || '',
            eval: $('#rtEval')?.value?.trim() || ''
          };
          const extQuiz = $$('#extQuizList .item').map(it=>({
            title: it.querySelector('[name="title"]').value.trim(),
            url: it.querySelector('[name="url"]').value.trim(),
            note: it.querySelector('[name="note"]')?.value?.trim() || ''
          })).filter(x=>x.url);
          return { comprehensionQuestions, creativeActivity, realTask, extQuiz };
        }
        if (step===3){
          const links = $$('#linkList .item').map(it=>({
            title: it.querySelector('[name="title"]').value.trim(),
            url: it.querySelector('[name="url"]').value.trim(),
            desc: it.querySelector('[name="desc"]')?.value?.trim() || ''
          })).filter(x=>x.url);
          const docs = $$('#docList .item').map(it=>{
            const title = it.querySelector('[name="title"]').value.trim();
            const fileInput = it.querySelector('input[name="file"]');
            let fileName = '';
            if (fileInput && fileInput.files && fileInput.files[0]){
              fileName = fileInput.files[0].name || '';
            } else if (it.dataset.fileName){
              fileName = it.dataset.fileName.trim();
            } else {
              const nameEl = it.querySelector('.file-name');
              fileName = nameEl?.textContent?.trim() || '';
            }
            const blobKey = (it.dataset.blobKey || '').trim();
            const desc = it.querySelector('[name="desc"]')?.value?.trim() || '';
            return { title, fileName, blobKey, desc };
          }).filter(x=> (x.fileName && x.fileName.trim()) || (x.blobKey && x.blobKey.trim()));
          const media = $$('#resVidList .item').map(it=>({
            title: it.querySelector('[name="title"]').value.trim(),
            url: it.querySelector('[name="url"]').value.trim(),
            summary: it.querySelector('[name="summary"]')?.value?.trim() || '',
            transcript: it.querySelector('[name="trans"]')?.value?.trim() || ''
          })).filter(x=>x.url);
          return { links, docs, media, notes: $('#teacherNotes')?.value?.trim() || '' };
        }
        if (step===4){
          const quiz = $$('#quizList .item').map(it=>{
            const answers = Array.from(it.querySelectorAll('[name="ans"]')).map(a=>a.value.trim()).filter(Boolean);
            return {
              q: it.querySelector('[name="q"]').value.trim(),
              answers
            };
          }).filter(x=>x.q);
          const topics = [
            $('#selfTopic1')?.value?.trim() || '',
            $('#selfTopic2')?.value?.trim() || '',
            $('#selfTopic3')?.value?.trim() || '',
            $('#selfTopic4')?.value?.trim() || '',
            $('#selfTopic5')?.value?.trim() || ''
          ].filter(Boolean);
          const self = {
            prompt: 'Quanto ti senti preparato su questi argomenti?',
            scale: $('#selfScale')?.value?.trim() || '',
            topics
          };
          const questions = $$('#reflList .item textarea[name="q"]').map(t=> t.value.trim()).filter(Boolean);
          const reflection = { questions };
          return { quiz, self, reflection };
        }
        if (step===5){
          const choice = document.querySelector('input[name="aiUsedChoice"]:checked')?.value || 'no';
          const aiUsed = (choice === 'yes');
          return {
            aiUsed,
            aiUsageDesc: $('#aiUsageDesc')?.value?.trim() || '',
            aiTools: $('#aiTools')?.value?.trim() || '',
            sourcesText: $('#sourcesText')?.value?.trim() || ''
          };
        }
        if (step===6){
          const closingQuestions = $$('#qList .item').map(it=> {
            const textarea = it.querySelector('textarea');
            return textarea ? textarea.value.trim() : '';
          }).filter(Boolean).slice(0, 3);
          return {
            closing: $('#closingText')?.value?.trim() || '',
            closingQuestions,
            externalFormUrl: $('#externalFormUrl')?.value?.trim() || ''
          };
        }
        return {};
      }

      // ========= Validazione minima home =========
            function validateHome(){
        let title = ($('#home-title')?.value || '').trim();
        let desc  = ($('#home-desc')?.value || '').trim();

        if (!title || !desc) {
          try {
            const raw = localStorage.getItem('lesson_config_' + lessonId);
            if (raw) {
              const cfg = JSON.parse(raw);
              title = title || ((cfg.home?.title || cfg.title || cfg.lessonTitle || '').toString().trim());
              desc  = desc  || ((cfg.home?.description || cfg.description || cfg.desc || cfg.lessonDesc || '').toString().trim());
            }
          } catch (e) {}
        }

        if (!title){ alert('‚ö†Ô∏è Inserisci il Titolo'); return false; }
        if (!desc || desc.length < 3){ alert('‚ö†Ô∏è Inserisci la Descrizione breve'); return false; }

        if (state.avatar.mode==='logo' && !state.avatar.url){
          state.avatar.url = 'assets/brand/logo_edubot_icon.png';
        }
        if (!state.avatar.url){ alert('‚ö†Ô∏è Seleziona un Avatar'); return false; }

        return true;
      }


      function afterMount(step){
        if (step===0) mountHome();
        if (step===1) mountLesson();
        if (step===2) mountActivities();
        if (step===3) mountResources();
        if (step===4) mountAssessment();
        if (step===5) mountEthics();
        if (step===6) mountClosing();
        loadStep(step);
        if (step===0) {
          updateDraftAvailability();
        }
      }

      // FIX: helper globale per mostrare la .preview-box del media
      function showPreviewBoxOf(el){
        // Attiva il contenitore .preview-box che avvolge <img>/<video>/<a>
        try{
          const box = el && el.closest && el.closest('.preview-box');
          if (box) box.style.display = 'block';
        }catch(_){ /* noop */ }
      }

      // FIX: helper globale per nascondere completamente un box preview
      function hidePreviewBoxOf(el){
        try{
          const box = el && el.closest && el.closest('.preview-box');
          if (box) box.style.display = 'none';
        }catch(_){ /* noop */ }
      }

      // ==== Step 0 handlers ====
      function mountHome(){
        // monitora titolo per abilitare/disabilitare salvataggio
        $('#home-title')?.addEventListener('input', updateDraftAvailability);
$('#home-desc')?.addEventListener('input', updateDraftAvailability);


        // Default: mostra SUBITO il logo come selezione e anteprima finch√© non ci sono salvataggi
        (function ensureDefaultLogo(){
          const raw = localStorage.getItem('lesson_config_'+lessonId);
          if(!raw){
            // forza stato logo
            state.avatar.mode = 'logo';
            state.avatar.url  = 'assets/brand/logo_edubot_icon.png';
            state.avatar.src  = state.avatar.url;
            state.avatar.picked = 'logo';
            // seleziona radio "Logo"
            const radios = $$('input[name="avatarMode"]');
            const logoRadio = Array.from(radios).find(r => (r.value==='logo') || r.parentElement?.textContent?.includes('Logo'));
            if(logoRadio) logoRadio.checked = true;
            // mostra subito la preview del logo
            const pl = document.getElementById('prev-logo');
            if (pl) { pl.style.display = 'block'; }
            // sincronizza UI stato avatar
            updateAvatarUI(true);
          }
        })();

        // Radio avatar mode - nuova struttura orizzontale
        $$('input[name="avatarMode"]').forEach(r=>{
          r.addEventListener('change',()=>{
            const selected = $$('input[name="avatarMode"]:checked')[0];
            if(!selected) return;
            const v = selected.value;
            // Determina quale opzione specifica √® stata selezionata (valori univoci)
            if (v === 'logo'){
              state.avatar.mode = 'logo';
              state.avatar.url = 'assets/brand/logo_edubot_icon.png';
              state.avatar.src = state.avatar.url;
              state.avatar.picked = 'logo';
            } else if (v === 'img_f'){
              state.avatar.mode = 'image';
              state.avatar.url = 'assets/avatars/avatar_edubot_female.png';
              state.avatar.src = state.avatar.url;
              state.avatar.picked = 'img-f-default';
            } else if (v === 'img_m'){
              state.avatar.mode = 'image';
              state.avatar.url = 'assets/avatars/avatar_edubot_default.png';
              state.avatar.src = state.avatar.url;
              state.avatar.picked = 'img-m-default';
            } else if (v === 'vid_f'){
              state.avatar.mode = 'video';
              state.avatar.url = 'assets/video/intro_f.mp4';
              state.avatar.src = state.avatar.url;
              state.avatar.picked = 'vid-f-default';
            } else if (v === 'vid_m'){
              state.avatar.mode = 'video';
              state.avatar.url = 'assets/video/intro_m.mp4';
              state.avatar.src = state.avatar.url;
              state.avatar.picked = 'vid-m-default';
            } else if (v === 'img_custom'){
              state.avatar.mode = 'image';
              state.avatar.picked = null;
              // evita mostrare residui: aspetta upload/URL
              state.avatar.url = '';
            } else if (v === 'vid_custom'){
              state.avatar.mode = 'video';
              state.avatar.picked = null;
              // evita poster/clip predefiniti: aspetta upload/URL
              state.avatar.url = '';
            }
            
            updateAvatarUI(true);
            updateDraftAvailability();
            
            // Mostra/nascondi campi personalizzati
            const customImgWrap = $('#avatarCustomImageWrap');
            const customVidWrap = $('#avatarCustomVideoWrap');
            if(customImgWrap) customImgWrap.style.display = (state.avatar.mode==='image' && !state.avatar.picked) ? '' : 'none';
            if(customVidWrap) customVidWrap.style.display = (state.avatar.mode==='video' && !state.avatar.picked) ? '' : 'none';
          });
        });
        
        // Audio checkbox per Video F/M
        $('#avatarVideoAudioF')?.addEventListener('change', e=>{ if(state.avatar.picked==='vid-f-default') state.avatar.audio = !!e.target.checked; updateAvatarUI(true); });
        $('#avatarVideoAudioM')?.addEventListener('change', e=>{ if(state.avatar.picked==='vid-m-default') state.avatar.audio = !!e.target.checked; updateAvatarUI(true); });

        // Helpers validazione avatar
        function setAvatarError(msg, kind){
  const el = kind==='video'? $('#avatarVidError') : $('#avatarImgError');
  if(el){ el.textContent = msg||''; el.style.display = msg? '' : 'none'; }
  // NON disabilitare qui i bottoni: li gestiamo con updateDraftAvailability()
}

        function clearAvatarError(){ setAvatarError('', 'image'); setAvatarError('', 'video'); }

        function validateSquareImage(file, done){
          if(!['image/png','image/jpeg','image/webp'].includes(file.type)) return done('Formato non supportato (PNG/JPG/WebP)');
          if(file.size > 2*1024*1024) return done('Dimensione oltre il limite (max 2 MB)');
          const fr=new FileReader(); fr.onload=e=>{
            const img=new Image(); img.onload=()=>{
              // Non forziamo pi√π 1:1: consigliato ma non obbligatorio. Preview user√† object-fit: cover.
              done(null, e.target.result);
            }; img.src=e.target.result;
          }; fr.readAsDataURL(file);
        }
        function validateSquareVideo(file, done){
          if(!['video/mp4','video/webm'].includes(file.type)) return done('Formato non supportato (MP4/WebM)');
          if(file.size > 10*1024*1024) return done('Dimensione oltre il limite (max 10 MB)');
          const fr = new FileReader();
          fr.onload = (e)=>{
            const dataUrl = e.target.result; // DataURL persistente
            done(null, dataUrl, true);
          };
          fr.onerror = ()=> done('Impossibile leggere il video');
          fr.readAsDataURL(file);
        }

          // Custom image (solo file locale)
          const avatarImageFileInput = $('#avatarImageFile');
          if(avatarImageFileInput) avatarImageFileInput.onclick = () => { avatarImageFileInput.value = ''; };
          avatarImageFileInput?.addEventListener('change', async e=>{
          const f = e.target.files[0]; if(!f) return; clearAvatarError();
          validateSquareImage(f, async (err, dataUrl)=>{
            if(err){ setAvatarError(err,'image'); e.target.classList.add('input-error'); return; }
            e.target.classList.remove('input-error');
            state.avatar.mode='image'; state.avatar.type='custom_image';
            const avatarImageKey = `session_blob_${lessonId}_avatar_image`;
            const imgKey = `${lessonId}::avatar_image`;
            try{
              // Converti dataURL in blob e salva in IDB
              const blob = await (await fetch(dataUrl)).blob();
              await idbPutBlob(imgKey, blob);
              // Salva puntatore IDB in sessionStorage
              sessionStorage.setItem(avatarImageKey, 'idb://' + imgKey);
            }catch(idbErr){
              console.error('Errore salvataggio immagine in IDB:', idbErr);
              // Fallback: salva dataURL in sessionStorage come prima
              try{ sessionStorage.setItem(avatarImageKey, dataUrl); }catch(_){}
            }
            if(!sessionStorage.getItem(avatarImageKey)){ alert('‚ö†Ô∏è File non caricato correttamente, riprova a selezionarlo'); return; }
            state.avatar.url = 'session://avatar_image';
state.avatar.src = state.avatar.url;
 state.avatar.picked=null; state.avatar.audio=false;
            updateAvatarUI(true); updateDraftAvailability();
            const radios=$$('input[name="avatarMode"]');
            const r = Array.from(radios).find(r => r.parentElement?.textContent?.includes('Immagine personalizzata')); if(r) r.checked=true;
          });
        });
        // RIMOSSO supporto URL per avatar immagine (solo file locale)

          // Controlli avatar immagine custom: Cambia / Rimuovi
          $('#avatarImageChangeBtn')?.addEventListener('click', ()=>{
            const input = $('#avatarImageFile');
            if(input){
              input.value = '';
              input.click();
            }
          });
          $('#avatarImageClearBtn')?.addEventListener('click', ()=>{
            const avatarImageKey = `session_blob_${lessonId}_avatar_image`;
            try{ sessionStorage.removeItem(avatarImageKey); }catch(_){}
            state.avatar.mode = 'logo';
            state.avatar.type = undefined;
            state.avatar.url  = 'assets/brand/logo_edubot_icon.png';
            state.avatar.src  = state.avatar.url;
            state.avatar.picked = 'logo';
            const box = $('#prev-img-custom');
            if(box) box.style.display = 'none';
            const img = $('#prev-img-custom-img');
            if(img){ img.src = ''; }
            const radios = $$('input[name="avatarMode"]');
            const logoRadio = Array.from(radios).find(r => (r.value==='logo') || r.parentElement?.textContent?.includes('Logo'));
            if(logoRadio) logoRadio.checked = true;
            updateAvatarUI(true);
            updateDraftAvailability();
            saveCurrent(true);
          });

          // Custom video (solo file locale)
          const avatarVideoFileInput = $('#avatarVideoFile');
          if(avatarVideoFileInput) avatarVideoFileInput.onclick = () => { avatarVideoFileInput.value = ''; };
          avatarVideoFileInput?.addEventListener('change', async e=>{
          const f = e.target.files[0]; if(!f) return;
          console.log('[VIDEO] avatar selected file', f.name, f.type, f.size);
          const input = e.target;
          if(input.dataset.busy === '1') return;
          input.dataset.busy = '1';
          input.disabled = true;
          clearAvatarError();
          if(!f.type.startsWith('video/')){ 
            setAvatarError('Formato non supportato','video'); 
            input.classList.add('input-error');
            input.disabled = false;
            input.dataset.busy = '0';
            return; 
          }
          input.classList.remove('input-error');
          state.avatar.mode='video'; state.avatar.type='custom_video';
          const key = `${lessonId}::avatar_video`;
          try{
            console.log('[VIDEO] avatar idbPutBlob start', { key });
            await idbPutBlob(key, f);
            console.log('[VIDEO] avatar idbPutBlob saved ok', { key });
            const avatarVideoKey = `session_blob_${lessonId}_avatar_video`;
            sessionStorage.setItem(avatarVideoKey, 'idb://' + key);
            state.avatar.url = 'session://avatar_video';
            state.avatar.src = state.avatar.url;
            state.avatar.picked=null; state.avatar.audio=false;
            const videoEl = $('#prev-vid-custom-vid') || $('#prev-vid-custom')?.querySelector('video');
            if(videoEl){
              // fallback diretto per diagnosi
              setVideoPreviewFromBlob(videoEl, f, 'avatar direct-file-fallback');
              await loadVideoPreviewFromIdb(key, videoEl);
            }
            updateAvatarUI(true); updateDraftAvailability();
            const radios=$$('input[name="avatarMode"]');
            const r = Array.from(radios).find(r => r.parentElement?.textContent?.includes('Video personalizzato')); if(r) r.checked=true;
          }catch(err){
            console.error(err);
            alert('Spazio browser insufficiente o salvataggio non riuscito. Prova con un file pi√π leggero o pulisci cache/sito.');
            setAvatarError('Errore salvataggio','video');
            input.classList.add('input-error');
          }finally{
            input.disabled = false;
            input.dataset.busy = '0';
            input.value = '';
          }
        });
        // RIMOSSO supporto URL per avatar video (solo file locale)

        // RIMOSSO toggle audio per avatar video personalizzato

          // Controlli avatar video custom: Cambia / Rimuovi
          $('#avatarVideoChangeBtn')?.addEventListener('click', ()=>{
            const input = $('#avatarVideoFile');
            if(input){
              input.value = '';
              input.click();
            }
          });
          $('#avatarVideoClearBtn')?.addEventListener('click', ()=>{
            const avatarVideoKey = `session_blob_${lessonId}_avatar_video`;
            try{ sessionStorage.removeItem(avatarVideoKey); }catch(_){}
            state.avatar.mode = 'logo';
            state.avatar.type = undefined;
            state.avatar.url  = 'assets/brand/logo_edubot_icon.png';
            state.avatar.src  = state.avatar.url;
            state.avatar.picked = 'logo';
            const wrap = $('#prev-vid-custom');
            if(wrap) wrap.style.display = 'none';
            const v = $('#prev-vid-custom-vid') || (wrap && wrap.querySelector && wrap.querySelector('video'));
            if(v){
              try{ v.pause(); }catch(_){}
              v.removeAttribute('src');
              v.load();
            }
            const radios = $$('input[name="avatarMode"]');
            const logoRadio = Array.from(radios).find(r => (r.value==='logo') || r.parentElement?.textContent?.includes('Logo'));
            if(logoRadio) logoRadio.checked = true;
            updateAvatarUI(true);
            updateDraftAvailability();
            saveCurrent(true);
          });

        // ===== COPERTINA: 5 modalit√† esclusive =====
        // FIX: utilit√†
        const $id = (x)=> document.getElementById(x);
        const setCoverError = (msg)=>{ 
  const box=$id('coverError'); 
  if(!box) return; 
  if(msg){ box.textContent=msg; box.hidden=false; } 
  else { box.textContent=''; box.hidden=true; } 
};

        const setCoverMeta  = (txt)=>{ 
          const m=$id('coverMeta'); 
          if(!m) return; 
          if(txt){ 
            m.textContent=`Sorgente: ${txt}`; 
            m.classList.add('truncate-line');
            m.title = txt;
            m.hidden=false;
          } else { 
            m.textContent=''; 
            m.classList.remove('truncate-line');
            m.title = '';
            m.hidden=true; 
          } 
        };
        const toggleActions = (dis)=>{ const save=$('#btnDraft'); const next=$('#btnNext'); if(save) save.disabled=!!dis; if(next) next.disabled=!!dis; };
        const clearPreview  = ()=>{
          ['coverPreviewImage','coverPreviewImageURL','coverPreviewVideo','coverPreviewVideoURL','coverPreviewYTLink'].forEach(id=>{
            const el=$id(id); if(!el) return;
            if(el.tagName==='VIDEO'){ try{ el.pause(); }catch(_){}; el.removeAttribute('src'); el.load(); }
            if(el.tagName==='A'){ el.href=''; }
            if(el.tagName==='IMG'){ el.removeAttribute('src'); }
            el.hidden = true;
          });
          const box = $id('coverPreviewBoxVideoURL');
          if (box) box.style.display = 'none';
          setCoverMeta('');
        };
        const showRow = (id)=>{
          ['row-none','row-image_file','row-image_url','row-video_file','row-video_url'].forEach(x=>{
            const el=$id(x); if(el) el.style.display = (x===id)?'block':'none';
          });
          clearPreview(); setCoverError('');
        };

        // FIX: cambio modalit√†
        $$('#coverModeWrap input[name="coverMode"]').forEach(r=>{
          r.addEventListener('change', ()=>{
            const v = r.value;
            // reset stato
            state.intro.type   = (v.startsWith('image')) ? 'image' : (v.startsWith('video') ? 'video' : 'none');
            state.intro.kind   = (v==='none') ? null : (v.startsWith('image') ? 'image' : 'video');
            state.intro.source = (v.endsWith('file')) ? 'file' : (v.endsWith('url') ? 'url' : null);
            if (v==='none'){
              state.intro.image.url=''; state.intro.image.alt='';
              state.intro.video.url=''; state.intro.video.transcript=''; state.intro.video.summary='';
              state.intro.name='';
              showRow('row-none');
              updateDraftAvailability();
              return;
            }
            showRow(`row-${v}`);
            if (v === 'video_url') {
              const link = $id('coverPreviewYTLink');
              if (link) link.hidden = true;
              const box = $id('coverPreviewBoxVideoURL');
              if (box) box.style.display = 'none';
              state.intro.video.url = '';
              state.intro.video.thumbnail = '';
              state.intro.name = '';
              const urlIn = $id('coverUrlVideo');
              if (urlIn) urlIn.value = '';
            }
            updateDraftAvailability();
          });
        });

        // FIX: IMAGE FILE
          const coverFileImageInput = $id('coverFileImage');
          if(coverFileImageInput) coverFileImageInput.onclick = () => { coverFileImageInput.value = ''; };
          coverFileImageInput?.addEventListener('change', async (e)=>{
          const f = e.target.files?.[0]; clearPreview(); setCoverError('');
            if(!f) return;
          if(!['image/png','image/jpeg','image/webp'].includes(f.type)) return setCoverError('Formato non supportato (PNG/JPG/WebP).');
          if(f.size>3*1024*1024) return setCoverError('Immagine troppo grande (max 3MB).');
          const imgKey = `${lessonId}::cover_image`;
          try{
            // Converti file in Blob e salva in IDB
            const blob = f; // File √® gi√† un Blob
            await idbPutBlob(imgKey, blob);
            // Salva puntatore IDB in sessionStorage
            const coverImageKey = `session_blob_${lessonId}_cover_image`;
            sessionStorage.setItem(coverImageKey, 'idb://' + imgKey);
            // Anteprima immediata con ObjectURL
            const img = $id('coverPreviewImage');
            if(img){
              const url = URL.createObjectURL(blob);
              img.src = url;
              img.hidden = false;
              // FIX: mostra box preview
              showPreviewBoxOf(img);
            }
            $id('coverFileImageName').textContent = f.name;
            state.intro.type='image'; state.intro.kind='image'; state.intro.source='file';
            state.intro.image.url='session://cover_image'; state.intro.name=f.name;
            setCoverMeta('(file in sessione) cover_image');
            updateDraftAvailability();
          }catch(err){
            console.error('Errore salvataggio immagine copertina in IDB:', err);
            alert('‚ö†Ô∏è File non caricato correttamente, riprova a selezionarlo');
            setCoverError('Errore salvataggio');
          }
        });
        $id('coverFileImageClear')?.addEventListener('click', ()=>{
          const inp=$id('coverFileImage'); if(inp) inp.value='';
          $id('coverFileImageName').textContent='';
          state.intro.image.url=''; state.intro.name='';
          clearPreview();
          // FIX: chiudi il box preview immagine file
          hidePreviewBoxOf(document.getElementById('coverPreviewImage'));
          // FIX: pulisci anche ALT file
          const altFileIn = document.getElementById('introImageAlt');
          if (altFileIn) altFileIn.value = '';
          updateDraftAvailability();
        });

        // FIX: IMAGE URL
        $id('coverUrlImageApply')?.addEventListener('click', ()=>{
          const url = ($id('coverUrlImage')?.value||'').trim(); clearPreview(); setCoverError('');
          if(!url) return setCoverError('Inserisci una URL valida.');
          const img = new Image();
          img.onload = ()=>{
            const dst = $id('coverPreviewImageURL'); dst.src = url; dst.hidden = false;
            // FIX: mostra box preview
            showPreviewBoxOf(dst);
            state.intro.type='image'; state.intro.kind='image'; state.intro.source='url';
            state.intro.image.url=url; state.intro.name=url;
            // ALT collegato al campo URL
            const altField = $id('introImageAltURL'); if(altField) state.intro.image.alt = altField.value.trim();
            setCoverMeta(url); updateDraftAvailability();
          };
          img.onerror = ()=> setCoverError('URL non √® un\'immagine valida.');
          img.crossOrigin='anonymous'; img.src = url;
        });
        $id('introImageAltURL')?.addEventListener('input', (e)=>{ if(state.intro && state.intro.kind==='image') state.intro.image.alt = e.target.value.trim(); });

        // FIX: rimozione URL immagine (pulisce stato + UI + abilita salvataggio)
        $id('coverUrlImageClear')?.addEventListener('click', ()=>{
          // Pulisci input
          const urlIn = $id('coverUrlImage'); if (urlIn) urlIn.value = '';
          // Nascondi anteprima
          const img = $id('coverPreviewImageURL');
          if (img){ img.removeAttribute('src'); img.hidden = true; }
          // Pulisci ALT
          const altIn = $id('introImageAltURL'); if (altIn) altIn.value = '';
          // Pulisci stato
          state.intro.type = 'image';
          state.intro.kind = 'image';
          state.intro.source = 'url';
          state.intro.image.url = '';
          state.intro.image.alt = '';
          state.intro.name = '';
          setCoverMeta('');
          setCoverError('');
          // FIX: chiudi il box preview immagine URL
          hidePreviewBoxOf(document.getElementById('coverPreviewImageURL'));
          updateDraftAvailability();
        });

        // FIX: VIDEO FILE
          const coverFileVideoInput = $id('coverFileVideo');
          if(coverFileVideoInput) coverFileVideoInput.onclick = () => { coverFileVideoInput.value = ''; };
          coverFileVideoInput?.addEventListener('change', async (e)=>{
          const f = e.target.files?.[0]; 
          if(!f) return;
          console.log('[VIDEO] cover selected file', f.name, f.type, f.size);
          const input = e.target;
          if(input.dataset.busy === '1') return;
          input.dataset.busy = '1';
          input.disabled = true;
          clearPreview(); setCoverError('');
          if(!f.type.startsWith('video/')){ 
            setCoverError('Formato non supportato (MP4/WebM).');
            input.disabled = false;
            input.dataset.busy = '0';
            return; 
          }
          if(f.size>8*1024*1024){ 
            setCoverError('Video troppo grande (max 8MB).');
            input.disabled = false;
            input.dataset.busy = '0';
            return; 
          }
          const key = `${lessonId}::cover_video`;
          try{
            console.log('[VIDEO] cover idbPutBlob start', { key });
            await idbPutBlob(key, f);
            console.log('[VIDEO] cover idbPutBlob saved ok', { key });
            const coverVideoKey = `session_blob_${lessonId}_cover_video`;
            sessionStorage.setItem(coverVideoKey, 'idb://' + key);
            const v = $id('coverPreviewVideo');
            if(v){
              // fallback diretto per diagnosi
              setVideoPreviewFromBlob(v, f, 'cover direct-file-fallback');
              await loadVideoPreviewFromIdb(key, v);
            }
            v.muted = false; v.controls = true;
            $id('coverFileVideoName').textContent = f.name;
            state.intro.type='video'; state.intro.kind='video'; state.intro.source='file';
            state.intro.video.url='session://cover_video'; state.intro.name=f.name;
            setCoverMeta('(file in sessione) cover_video');
            updateDraftAvailability();
          }catch(err){
            console.error(err);
            alert('Impossibile salvare il video sul dispositivo (IndexedDB).');
            setCoverError('Errore salvataggio');
          }finally{
            input.disabled = false;
            input.dataset.busy = '0';
            input.value = '';
          }
        });
        $id('coverFileVideoClear')?.addEventListener('click', ()=>{
          const inp=$id('coverFileVideo'); if(inp) inp.value='';
          $id('coverFileVideoName').textContent='';
          state.intro.video.url=''; state.intro.name='';
          clearPreview();
          // FIX: chiudi il box preview video file
          hidePreviewBoxOf(document.getElementById('coverPreviewVideo'));
          // FIX: pulisci testi
          const t = document.getElementById('introVideoTranscript');
          if (t) t.value = '';
          const s = document.getElementById('introVideoSummary');
          if (s) s.value = '';
          updateDraftAvailability();
        });

        // FIX: VIDEO URL (YouTube incluso, regex estesa: watch?v=, youtu.be, embed/, shorts/)
        const ytId = (u)=>{
          if(!u) return null;
          try{
            const url = new URL(u, location.origin);
            // watch?v=ID
            if ((/youtube\.com$/i).test(url.hostname) || (/youtube\.com$/i).test(url.hostname.replace(/^www\./,''))) {
              if (url.searchParams.get('v')) {
                return url.searchParams.get('v').trim().slice(0,11);
              }
              // /embed/ID
              const em = url.pathname.match(/\/embed\/([A-Za-z0-9_-]{11})/);
              if (em) return em[1];
              // /shorts/ID
              const sh = url.pathname.match(/\/shorts\/([A-Za-z0-9_-]{11})/);
              if (sh) return sh[1];
            }
            // youtu.be/ID
            if ((/youtu\.be$/i).test(url.hostname) || (/youtu\.be$/i).test(url.hostname.replace(/^www\./,''))) {
              const m = url.pathname.match(/\/([A-Za-z0-9_-]{11})/);
              if (m) return m[1];
            }
          }catch(_){
            // fallback regex grezza
            const m = (u||'').match(/(?:youtu\.be\/|embed\/|shorts\/|watch\?v=)([A-Za-z0-9_-]{11})/);
            if (m) return m[1];
          }
          return null;
        };
        $id('coverUrlVideoApply')?.addEventListener('click', ()=>{
          const url = ($id('coverUrlVideo')?.value||'').trim(); clearPreview(); setCoverError('');
          if(!url) return setCoverError('Incolla un link completo (che inizia con https://).');
          const link = $id('coverPreviewYTLink'); const thumb = $id('coverPreviewYTThumb'); const v = $id('coverPreviewVideoURL');
          const id = ytId(url);
          if (id && link && thumb){
            link.href = `https://www.youtube.com/watch?v=${id}`;
            thumb.src = `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
            link.hidden = false; v.hidden = true;
            state.intro.type='video'; state.intro.kind='video'; state.intro.source='url';
            state.intro.video.url=link.href; state.intro.video.thumbnail=thumb.src; state.intro.name=link.href;
            setCoverMeta(link.href); updateDraftAvailability();
            return;
          }
          // Prova MP4/WebM
          if (/\.(mp4|webm)(\?.*)?$/i.test(url)){
            v.pause();
            v.removeAttribute('src');
            v.load();
            v.onloadeddata = null;
            v.onloadedmetadata = null;
            v.onerror = null;
            v.src = url;
            v.playsInline = true;
            v.muted = false;
            v.controls = true;
            let handled = false;
            const onOk = ()=>{
              if(handled) return;
              handled = true;
              v.hidden = false;
              showPreviewBoxOf(v);
            };
            const onErr = ()=>{
              if(handled) return;
              handled = true;
              console.warn("Cover video URL error", v.error, url);
              v.hidden = true;
              setCoverError('Video non caricabile. Prova un link diretto .mp4/.webm oppure verifica che il link sia pubblico (es. Google Drive).');
            };
            v.addEventListener('loadeddata', onOk, {once: true});
            v.addEventListener('loadedmetadata', onOk, {once: true});
            v.addEventListener('error', onErr, {once: true});
            v.load();
            state.intro.type='video'; state.intro.kind='video'; state.intro.source='url';
            state.intro.video.url=url; state.intro.name=url;
            setCoverMeta(url); updateDraftAvailability();
            return;
          }
          // Fallback: accetta qualsiasi URL http/https come video esterno (link)
          if (/^https?:\/\//i.test(url)){
            // Prova a generare thumbnail per Google Drive
            let driveThumb = '';
            const driveMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/) || url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (driveMatch && /drive\.google\.com/i.test(url)){
              const fileId = driveMatch[1];
              driveThumb = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
            }
            if (link) { link.href = url; link.hidden = !driveThumb; }
            if (thumb) {
              if (driveThumb){
                thumb.src = driveThumb;
                thumb.hidden = false;
              } else {
                thumb.hidden = true;
              }
            }
            if (v) { v.hidden = true; }
            state.intro.type='video'; state.intro.kind='video'; state.intro.source='url';
            state.intro.video.url=url; state.intro.video.thumbnail=driveThumb; state.intro.name=url;
            setCoverMeta(url); updateDraftAvailability();
            return;
          }
          setCoverError('Link non valido. Usa YouTube, un link diretto .mp4/.webm oppure un link pubblico (es. Google Drive).');
        });

        // FIX: rimozione URL video (pulisce stato + UI + abilita salvataggio)
        $id('coverUrlVideoClear')?.addEventListener('click', ()=>{
          const urlIn = $id('coverUrlVideo'); if (urlIn) urlIn.value = '';
          // Nascondi anteprime (YT/thumb o MP4/WebM)
          const link = $id('coverPreviewYTLink'); const thumb = $id('coverPreviewYTThumb');
          const v    = $id('coverPreviewVideoURL');
          if (link){ link.href=''; link.hidden = true; }
          if (thumb){ thumb.removeAttribute('src'); }
          if (v){ try{ v.pause(); }catch(_){ } v.removeAttribute('src'); v.load(); v.hidden = true; }
          // Pulisci eventuali campi extra
          const t = $id('introVideoTranscript'); if (t) t.value = '';
          const s = $id('introVideoSummary');   if (s) s.value = '';
          // Pulisci eventuali campi extra
          const tURL = document.getElementById('introVideoTranscriptURL');
          if (tURL) tURL.value = '';
          const sURL = document.getElementById('introVideoSummaryURL');
          if (sURL) sURL.value = '';
          // Pulisci stato
          state.intro.type = 'video';
          state.intro.kind = 'video';
          state.intro.source = 'url';
          state.intro.video.url = '';
          state.intro.video.transcript = '';
          state.intro.video.summary = '';
          state.intro.name = '';
          setCoverMeta('');
          setCoverError('');
          // FIX: chiudi il box preview video URL
          hidePreviewBoxOf(document.getElementById('coverPreviewVideoURL'));
          updateDraftAvailability();
        });

        // FIX: sincronizza ALT (file)
        document.getElementById('introImageAlt')?.addEventListener('input', (e)=>{
          if (state.intro && state.intro.kind==='image') state.intro.image.alt = e.target.value.trim();
        });

        // (quello per ALT URL esiste gi√†) ‚Äî lo lasciamo

        // FIX: sincronizza transcript/summary per video FILE
        document.getElementById('introVideoTranscript')?.addEventListener('input', (e)=>{
          state.intro.video.transcript = e.target.value;
        });
        document.getElementById('introVideoSummary')?.addEventListener('input', (e)=>{
          state.intro.video.summary = e.target.value;
        });

        // FIX: sincronizza transcript/summary per video URL (YT incluso)
        document.getElementById('introVideoTranscriptURL')?.addEventListener('input', (e)=>{
          state.intro.video.transcript = e.target.value;
        });
        document.getElementById('introVideoSummaryURL')?.addEventListener('input', (e)=>{
          state.intro.video.summary = e.target.value;
        });

        updateAvatarUI(true);
        // Carica stato salvato se presente
        const radios = $$('input[name="avatarMode"]');
        if(state.avatar.picked==='logo' || state.avatar.mode==='logo'){
          const logoRadio = Array.from(radios).find(r => r.parentElement?.textContent?.includes('Logo'));
          if(logoRadio) logoRadio.checked = true;
        }
        const customImgWrap = $('#avatarCustomImageWrap');
        const customVidWrap = $('#avatarCustomVideoWrap');
        if(customImgWrap) customImgWrap.style.display = (state.avatar.mode==='image' && !state.avatar.picked) ? '' : 'none';
        if(customVidWrap) customVidWrap.style.display = (state.avatar.mode==='video' && !state.avatar.picked) ? '' : 'none';

        updateDraftAvailability();
      }

      function updateAvatarUI(forceShow=false){
        // reset anteprime
        const hide = (sel)=>{ 
  const el=$(sel); 
  if(el){ 
    el.style.display='none'; 
    const vid = el.querySelector && el.querySelector('video'); 
    if(vid){ 
      try{ vid.pause(); }catch(_){}
      // NON rimuovere src: i video preset (intro_m/f) altrimenti poi non ripartono pi√π
      // vid.removeAttribute('src');
      // vid.load();
    } 
  } 
};

        const show = (sel)=>{ const el=$(sel); if(el){ el.style.display='block'; } };

        // FIX: risolve i pointer session://... in un vero dataURL preso da sessionStorage
        // Per video/immagini da IDB: se trova idb:// pointer, restituisce null (gestito separatamente)
        const resolveSessionSrc = (u)=>{
          if(!u || typeof u !== 'string') return u;
          if(!u.startsWith('session://')) return u;
          const kind = u.replace('session://','').trim(); // es: avatar_image / avatar_video
          const key  = `session_blob_${lessonId}_${kind}`;
          const stored = sessionStorage.getItem(key);
          if(!stored) return '';
          if(stored.startsWith('idb://')){
            return null; // Video da IDB, gestito separatamente
          }
          return stored;
        };

        hide('#prev-logo');
        hide('#prev-img-m'); hide('#prev-img-f'); hide('#prev-img-custom');
        hide('#prev-vid-m'); hide('#prev-vid-f'); hide('#prev-vid-custom');

        if (state.avatar.mode==='logo'){
          if (forceShow || state.avatar.picked==='logo'){ show('#prev-logo'); }
          if (!state.avatar.url) state.avatar.url='assets/brand/logo_edubot_icon.png';
          return;
        }

        if (state.avatar.mode==='image'){
          if (state.avatar.picked==='img-m-default'){ show('#prev-img-m'); }
          else if (state.avatar.picked==='img-f-default'){ show('#prev-img-f'); }
                   else if (state.avatar.url){
            const img = $('#prev-img-custom-img');
            if (img){
              img.onload = null;
              img.onerror = null;
              img.src = '';
              const src = resolveSessionSrc(state.avatar.url);
              if (src === null){
                // Immagine da IndexedDB
                const key = `session_blob_${lessonId}_avatar_image`;
                const idbPointer = sessionStorage.getItem(key);
                if(idbPointer && idbPointer.startsWith('idb://')){
                  const idbKey = idbPointer.replace('idb://','');
                  idbGetBlob(idbKey).then(blob => {
                    if(blob){
                      const url = URL.createObjectURL(blob);
                      show('#prev-img-custom');
                      img.onload = function(){
                        show('#prev-img-custom');
                      };
                      img.onerror = function(){
                        try { $('#prev-img-custom').style.display='none'; } catch(e){}
                        URL.revokeObjectURL(url);
                      };
                      img.src = url;
                    }
                  }).catch(err => {
                    console.error('Errore caricamento immagine avatar da IDB:', err);
                  });
                }
                return;
              }
              if (!src){ return; }
              // FIX: mostra subito il contenitore, poi riconferma su load
              show('#prev-img-custom');
              img.onload = function(){
                show('#prev-img-custom');
              };
              img.onerror = function(){
                try { $('#prev-img-custom').style.display='none'; } catch(e){}
              };
              img.src = src;
            }
          }

          return;
        }

        if (state.avatar.mode==='video'){
          if (state.avatar.picked==='vid-m-default'){ 
            const wrap = $('#prev-vid-m');
            if(wrap){ 
              const v = wrap.querySelector('video');
              if(v){ 
                v.muted = true; // autoplay policy
                v.playsInline = true; v.setAttribute('playsinline','');
                v.loop = true; v.autoplay = true;
                v.load(); show('#prev-vid-m');
                const tryPlay = () => { try { v.play().catch(()=>{}); } catch(e){} };
                v.onloadedmetadata = tryPlay; tryPlay();
              }
            }
          }
          else if (state.avatar.picked==='vid-f-default'){ 
            const wrap = $('#prev-vid-f');
            if(wrap){ 
              const v = wrap.querySelector('video');
              if(v){ 
                v.muted = true; // autoplay policy
                v.playsInline = true; v.setAttribute('playsinline','');
                v.loop = true; v.autoplay = true;
                v.load(); show('#prev-vid-f');
                const tryPlay = () => { try { v.play().catch(()=>{}); } catch(e){} };
                v.onloadedmetadata = tryPlay; tryPlay();
              }
            }
          }
          else if (state.avatar.url){
            const wrap = $('#prev-vid-custom');
            if (wrap){
              const v = wrap.querySelector('video') || $('#prev-vid-custom-vid');
              if (v){
                const resolved = resolveSessionSrc(state.avatar.url, lessonId);
                if(resolved === null){
                  // Video da IndexedDB
                  const key = `session_blob_${lessonId}_avatar_video`;
                  const idbPointer = sessionStorage.getItem(key);
                  if(idbPointer && idbPointer.startsWith('idb://')){
                    const idbKey = idbPointer.replace('idb://','');
                    openStep0Panel();
                    show('#prev-vid-custom');
                    v.muted = true;
                    v.playsInline = true; v.setAttribute('playsinline','');
                    v.loop = true; v.autoplay = true;
                    loadVideoPreviewFromIdb(idbKey, v).catch(err=>{
                      console.error('Errore caricamento video avatar da IDB:', err);
                    });
                  }
                }else if(resolved){
                  // Video da sessionStorage (dataURL)
                  v.pause();
                  v.removeAttribute('src');
                  v.load();
                  v.onloadedmetadata = null;
                  v.onerror = null;
                  v.muted = true;
                  v.playsInline = true; v.setAttribute('playsinline','');
                  v.loop = true; v.autoplay = true;
                  v.onloadedmetadata = function(){
                    show('#prev-vid-custom');
                    try { v.play().catch(()=>{}); } catch(e){}
                  };
                  v.onloadeddata = () => {
                    // 1) prima apri lo step (il contenitore deve diventare misurabile)
                    openStep0Panel();

                    // 2) rendi visibile il box
                    const box = document.getElementById('prev-vid-custom');
                    if (box) box.style.display = 'block';

                    // 3) aspetta 2 frame: d√† tempo al layout di calcolare dimensioni reali
                    requestAnimationFrame(() => {
                      requestAnimationFrame(() => {
                        try {
                          v.style.width = '100%';
                          v.style.height = '100%';
                          v.style.objectFit = 'cover';
                          // facoltativo: prova a far partire (muted+autoplay spesso ok)
                          v.play?.().catch(()=>{});
                        } catch(e){}
                      });
                    });
                  };
                  v.onerror = function(){ try { $('#prev-vid-custom').style.display='none'; } catch(e){} };
                  v.src = resolved;
                  v.load();
                }
              }
            }
          }
          return;
        }
      }

      function canSaveDraft(){
  if (typeof current !== 'undefined' && current !== 0) return true;

  const title = ($('#home-title')?.value || '').trim();
  const titleOk = title.length >= 3;

  const hasUrl = !!(state.avatar && state.avatar.url);
  const hasPickedPreset = !!(state.avatar && state.avatar.picked); // logo / img-*-default / vid-*-default

  // se √® logo ma per qualche motivo url √® vuoto, lo rimettiamo
  if (state.avatar && state.avatar.mode === 'logo' && !state.avatar.url) {
    state.avatar.url = 'assets/brand/logo_edubot_icon.png';
    state.avatar.src = state.avatar.url;
    state.avatar.picked = state.avatar.picked || 'logo';
  }

  const avatarOk = hasUrl || hasPickedPreset;
  return titleOk && avatarOk;
}


            function showStep0Errors(){
        const title = ($('#home-title')?.value || '').trim();
        const desc  = ($('#home-desc')?.value || '').trim();

        const titleErr = $('#err-title');
        if (titleErr) titleErr.style.display = (title.length >= 3) ? 'none' : '';

        const descErr = document.getElementById('err-desc');
        if (descErr) descErr.style.display = (desc.length >= 3) ? 'none' : '';

        const avatarErr = $('#err-avatar');
        if (avatarErr) avatarErr.style.display = (state.avatar && state.avatar.url) ? 'none' : '';
      }


      function updateDraftAvailability(){
        const btn = $('#btnDraft');
        if (!btn) return;
        // Step 0: non disabilitare mai il pulsante (deve mostrare alert se mancano campi)
        if (typeof current !== 'undefined' && current === 0) {
          btn.disabled = false;
          return;
        }
        const ok = canSaveDraft();
        btn.disabled = !ok;
        // Nascondi errori quando diventa ok
        if (ok){
          const titleErr = $('#err-title'); if (titleErr) titleErr.style.display = 'none';
          const avatarErr = $('#err-avatar'); if (avatarErr) avatarErr.style.display = 'none';
        }
      }

      function updateIntroPreview(kind){
        if (kind==='image'){
          const img = $('#introImagePrev');
          if (img){ img.src = state.intro.image.url; img.style.display = state.intro.image.url ? '' : 'none'; }
          return;
        }
        if (kind==='video'){
          const v = $('#introVideoPrev');
          if (v){ v.src = state.intro.video.url; v.style.display = state.intro.video.url ? '' : 'none'; v.load(); }
        }
      }

      // ==== Step 1 handlers ====
      function mountLesson(){
        $('#btnAddImg')?.addEventListener('click', ()=> addImageItemUI({url:'',alt:''}));
        $('#btnAddVid')?.addEventListener('click', ()=> addVideoItemUI({url:'',transcript:'',summary:''}));
        $('#btnAddGloss')?.addEventListener('click', ()=> addGlossItemUI({term:'',explain:''}));
        
        // Mappa concettuale: gestione URL
        const handleConceptUrl = (e) => {
          const v = (e.target.value || '').trim();
          const btnDelUrl = $('#btnDelConceptUrl');
          if (v) {
            if (btnDelUrl) btnDelUrl.style.display = 'inline-block';
            const conceptMapBox = $('#conceptMapBox');
            if (conceptMapBox && conceptMapBox.dataset.conceptBlobKey) {
              delete conceptMapBox.dataset.conceptBlobKey;
            }
          } else {
            if (btnDelUrl) btnDelUrl.style.display = 'none';
          }
        };
        $('#conceptImageUrl')?.addEventListener('input', handleConceptUrl);
        $('#conceptImageUrl')?.addEventListener('change', handleConceptUrl);
        
        // Elimina URL mappa
        $('#btnDelConceptUrl')?.addEventListener('click', () => {
          const urlInput = $('#conceptImageUrl');
          const btnDelUrl = $('#btnDelConceptUrl');
          if (urlInput) urlInput.value = '';
          if (btnDelUrl) btnDelUrl.style.display = 'none';
        });
        
        // Carica file mappa concettuale
        $('#conceptImageFile')?.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if(file){
            try {
              const conceptBlobKey = `lesson_${lessonId}_concept_${Date.now()}_${Math.random().toString(16).slice(2)}`;
              await idbPutBlob(conceptBlobKey, file);
              const conceptMapBox = $('#conceptMapBox');
              if (conceptMapBox) conceptMapBox.dataset.conceptBlobKey = conceptBlobKey;
              const urlInput = $('#conceptImageUrl');
              if (urlInput) urlInput.value = '';
              const btnDelUrl = $('#btnDelConceptUrl');
              if (btnDelUrl) btnDelUrl.style.display = 'none';
            } catch(err) {
              console.error('Errore salvataggio file mappa', err);
              alert('Errore nel caricamento del file. Riprova.');
            }
          }
        });
      }
      function addImageItemUI(data){
        const wrap = document.createElement('div'); wrap.className='item';
        if(data.blobKey) wrap.dataset.blobKey = data.blobKey;
        wrap.innerHTML = `
          <label>URL immagine</label>
          <input name="url" type="url" class="truncate" value="${data.url||''}" placeholder="https://...">
          <label>Oppure carica da file locale</label>
          <input name="file" type="file" accept="image/*">
          <label>Descrizione per ipovedenti (ALT) (facoltativa)</label>
          <input name="alt" type="text" value="${data.alt||''}" placeholder="Descrizione breve">
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>`;
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        const fileInput = wrap.querySelector('[name="file"]');
        const urlInput = wrap.querySelector('[name="url"]');
        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if(file){
            try {
              const blobKey = `lesson_${lessonId}_img_${Date.now()}_${Math.random().toString(16).slice(2)}`;
              await idbPutBlob(blobKey, file);
              wrap.dataset.blobKey = blobKey;
              if (urlInput) urlInput.value = '';
            } catch(err) {
              console.error('Errore salvataggio file', err);
              alert('Errore nel caricamento del file. Riprova.');
            }
          }
        });
        if (urlInput) {
          urlInput.addEventListener('input', (e) => {
            const v = (e.target.value || '').trim();
            if (v && wrap.dataset.blobKey) {
              delete wrap.dataset.blobKey;
            }
          });
        }
        $('#imgList').appendChild(wrap);
      }
      function addVideoItemUI(data){
        const wrap = document.createElement('div'); wrap.className='item';
        if(data.blobKey) wrap.dataset.blobKey = data.blobKey;
        wrap.innerHTML = `
          <label>URL video</label>
          <input name="url" type="url" class="truncate" value="${data.url||''}" placeholder="https://...">
          <label>Oppure carica da file locale</label>
          <input name="file" type="file" accept="video/*">
          <label>Trascrizione (facoltativa)</label>
          <textarea name="trans" placeholder="Testo del parlato o descrizione...">${data.transcript||''}</textarea>
          <label>Riassunto (facoltativa)</label>
          <input name="summary" type="text" value="${data.summary||''}" placeholder="4‚Äì6 frasi semplici">
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>`;
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        const fileInput = wrap.querySelector('[name="file"]');
        const urlInput = wrap.querySelector('[name="url"]');
        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if(file){
            try {
              const videoBlobKey = `lesson_${lessonId}_vid_${Date.now()}_${Math.random().toString(16).slice(2)}`;
              await idbPutBlob(videoBlobKey, file);
              wrap.dataset.blobKey = videoBlobKey;
              if (urlInput) urlInput.value = '';
            } catch(err) {
              console.error('Errore salvataggio file video', err);
              alert('Errore nel caricamento del file. Riprova.');
            }
          }
        });
        if (urlInput) {
          urlInput.addEventListener('input', (e) => {
            const v = (e.target.value || '').trim();
            if (v && wrap.dataset.blobKey) {
              delete wrap.dataset.blobKey;
            }
          });
        }
        $('#vidList').appendChild(wrap);
      }
      function addGlossItemUI(data){
        const wrap = document.createElement('div'); wrap.className='item';
        wrap.innerHTML = `
          <label>Termine (IT)</label>
          <input name="term" type="text" value="${data.term||''}" placeholder="termine">
          <label>Spiegazione (IT)</label>
          <textarea name="explain" placeholder="Spiegazione del termine...">${data.explain||''}</textarea>
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>`;
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        $('#glossList').appendChild(wrap);
      }

      // ==== Step 2 handlers ====
      function mountActivities(){
        $('#btnAddGuided')?.addEventListener('click', ()=> addGuidedItemUI({title:'',steps:'',materials:''}));
        $('#btnAddIndep')?.addEventListener('click', ()=> addIndepItemUI({task:'',outcome:''}));
        $('#btnAddExtQuiz')?.addEventListener('click', ()=> addExtQuizItemUI({title:'',url:'',note:''}));
      }
      function addGuidedItemUI(data){
        const wrap = document.createElement('div'); wrap.className='item';
        wrap.innerHTML = `
          <label>Titolo</label><input name="title" type="text" value="${data.title||''}">
          <label>Istruzioni/Passi</label><textarea name="steps" placeholder="Passi guidati...">${data.steps||''}</textarea>
          <label>Materiali</label><input name="materials" type="text" value="${data.materials||''}" placeholder="Link o descrizione">
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>`;
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        $('#guidedList').appendChild(wrap);
      }
      function addIndepItemUI(data){
        const wrap = document.createElement('div'); wrap.className='item';
        wrap.innerHTML = `
          <label>Attivit√†</label><input name="task" type="text" value="${data.task||''}">
          <label>Prodotto atteso</label><input name="outcome" type="text" value="${data.outcome||''}">
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>`;
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        $('#indepList').appendChild(wrap);
      }
      function addExtQuizItemUI(data){
        const wrap = document.createElement('div'); wrap.className='item';
        wrap.innerHTML = `
          <label>Titolo</label>
          <input name="title" type="text" value="${data.title||''}">
          <label>URL</label>
          <input name="url" type="url" class="truncate" value="${data.url||''}" placeholder="https://...">
          <label>Nota (facoltativa)</label>
          <input name="note" type="text" value="${data.note||''}" placeholder="Note aggiuntive...">
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>`;
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        $('#extQuizList').appendChild(wrap);
      }

      // ==== Step 3 handlers ====
      function mountResources(){
        $('#btnAddLink')?.addEventListener('click', ()=> addLinkItemUI({title:'',url:''}));
        $('#btnAddDoc')?.addEventListener('click', ()=> addDocItemUI({title:'',fileName:''}));
        $('#btnAddResVid')?.addEventListener('click', ()=> addResVidItemUI({title:'',url:''}));
      }
      function addLinkItemUI(data){
        const wrap = document.createElement('div'); wrap.className='item';
        wrap.innerHTML = `
          <div>
            <label>Titolo</label><input name="title" type="text" value="${data.title||''}">
          </div>
          <div>
            <label>URL</label><input name="url" type="url" class="truncate" value="${data.url||''}" placeholder="https://...">
          </div>
          <div>
            <label>Descrizione (facoltativa)</label><input name="desc" type="text" value="${data.desc||''}">
          </div>
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>`;
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        $('#linkList').appendChild(wrap);
      }
      function addDocItemUI(data){
        const wrap = document.createElement('div'); wrap.className='item';
        wrap.innerHTML = `
          <div>
            <label>Titolo</label><input name="title" type="text" value="${data.title||''}">
          </div>
          <div>
            <label>File (PDF/PPT/PPTX)</label>
            <input name="file" type="file" accept=".pdf,.ppt,.pptx,application/pdf,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation">
            <div class="small muted file-name"></div>
          </div>
          <div>
            <label>Descrizione (facoltativa)</label><input name="desc" type="text" value="${data.desc||''}">
          </div>
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>`;
        if (data.fileName){
          wrap.dataset.fileName = data.fileName;
          const nameEl = wrap.querySelector('.file-name');
          if (nameEl) nameEl.textContent = data.fileName;
        }
        if (data.blobKey){
          wrap.dataset.blobKey = data.blobKey;
        }
        const fileInput = wrap.querySelector('input[name="file"]');
        const fileNameEl = wrap.querySelector('.file-name');
        if (fileInput && fileNameEl){
          fileInput.addEventListener('change', async ()=>{
            const name = fileInput.files?.[0]?.name || '';
            fileNameEl.textContent = name;
            wrap.dataset.fileName = name || '';

            const file = fileInput.files?.[0];
            if (!file) return;

            let blobKey = wrap.dataset.blobKey;
            if (!blobKey){
              blobKey = `${lessonId}::doc_${Date.now()}_${Math.random().toString(16).slice(2)}`;
            }

            try{
              await idbPutBlob(blobKey, file);
              wrap.dataset.blobKey = blobKey;
            }catch(e){
              console.error('Errore salvataggio file in IndexedDB', e);
              alert('File non disponibile');
            }
          });
        }
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        $('#docList').appendChild(wrap);
      }
      function addResVidItemUI(data){
        const wrap = document.createElement('div'); wrap.className='item';
        wrap.innerHTML = `
          <div>
            <label>Titolo</label><input name="title" type="text" value="${data.title||''}">
          </div>
          <div>
            <label>URL</label><input name="url" type="url" class="truncate" value="${data.url||''}" placeholder="https://...">
          </div>
          <div>
            <label>Riassunto (4‚Äì6 frasi)</label><input name="summary" type="text" value="${data.summary||''}">
          </div>
          <div>
            <label>Trascrizione / descrizione</label><textarea name="trans">${data.transcript||''}</textarea>
          </div>
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>`;
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        $('#resVidList').appendChild(wrap);
      }

      // ==== Step 4 handlers ====
      function mountAssessment(){
        $('#btnAddQuestion')?.addEventListener('click', ()=> addQuestionItemUI({q:'',answers:['','','','']}));
        $('#btnAddRefl')?.addEventListener('click', ()=> addReflectionItemUI({q:''}));
      }
      function addQuestionItemUI(data){
        const wrap = document.createElement('div'); wrap.className='item';
        wrap.innerHTML = `
          <label>Domanda</label><input name="q" type="text" value="${data.q||''}">
          <div class="grid two">
            <div><label>Risposta 1</label><input name="ans" type="text" value="${data.answers?.[0]||''}"></div>
            <div><label>Risposta 2</label><input name="ans" type="text" value="${data.answers?.[1]||''}"></div>
            <div><label>Risposta 3</label><input name="ans" type="text" value="${data.answers?.[2]||''}"></div>
            <div><label>Risposta 4</label><input name="ans" type="text" value="${data.answers?.[3]||''}"></div>
          </div>
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>
        `;
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        $('#quizList').appendChild(wrap);
      }
      function addReflectionItemUI(data){
        const wrap = document.createElement('div'); wrap.className='item';
        wrap.innerHTML = `
          <label class="small">Domanda guida</label>
          <textarea name="q" placeholder="Cosa hai capito meglio?">${data.q||''}</textarea>
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>
        `;
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        $('#reflList').appendChild(wrap);
      }
      function addRubricRowUI(data){
        const wrap = document.createElement('div'); wrap.className='item';
        wrap.innerHTML = `
          <label>Criterio</label><input name="criterion" type="text" value="${data.criterion||''}">
          <div class="grid two">
            <div><label>Livello 1</label><input name="l1" type="text" value="${data.l1||''}"></div>
            <div><label>Livello 2</label><input name="l2" type="text" value="${data.l2||''}"></div>
            <div><label>Livello 3</label><input name="l3" type="text" value="${data.l3||''}"></div>
            <div><label>Livello 4</label><input name="l4" type="text" value="${data.l4||''}"></div>
          </div>
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>
        `;
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        $('#rubricList').appendChild(wrap);
      }

      function updateAiVisibility(aiUsed){
        const usageWrap = document.getElementById('aiUsageDescWrap');
        const badgeWrap = document.getElementById('aiBadgeWrap');
        const studentWrap = document.getElementById('aiStudentWrap');
        if (usageWrap) usageWrap.hidden = !aiUsed;
        if (badgeWrap) badgeWrap.hidden = !aiUsed;
        if (studentWrap) studentWrap.hidden = !aiUsed;
      }

      // ==== Step 5 handlers ====
      function mountEthics(){
        const aiRadios = document.querySelectorAll('input[name="aiUsedChoice"]');
        aiRadios.forEach(radio=>{
          radio.addEventListener('change', ()=>{
            const choice = document.querySelector('input[name="aiUsedChoice"]:checked')?.value || 'no';
            updateAiVisibility(choice === 'yes');
          });
        });
      }
      function addSourceItemUI(data){
        const wrap = document.createElement('div'); wrap.className='item';
        wrap.innerHTML = `
          <div class="grid two">
            <div><label>Titolo/Descrizione</label><input name="title" type="text" value="${data.title||''}"></div>
            <div><label>URL</label><input name="url" type="url" class="truncate" value="${data.url||''}" placeholder="https://..."></div>
          </div>
          <div class="grid two">
            <div><label>Licenza</label><input name="license" type="text" value="${data.license||''}" placeholder="CC BY-SA, ecc."></div>
            <div><label>Credito</label><input name="credit" type="text" value="${data.credit||''}" placeholder="Autore/fonte"></div>
          </div>
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>
        `;
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        $('#sourceList').appendChild(wrap);
      }
      function addAIRowUI(data){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input name="tool" type="text" value="${data.tool||''}" placeholder="ChatGPT, Gemini..."></td>
          <td><input name="purpose" type="text" value="${data.purpose||''}" placeholder="Semplificazione testo, generazione quiz..."></td>
          <td><input name="revised" type="text" value="${data.revised||'Docente'}"></td>
          <td><input name="method" type="text" value="${data.method||'Verifica manuale'}"></td>
          <td><button type="button" class="btn danger btnDel">‚úï</button></td>
        `;
        tr.querySelector('.btnDel').addEventListener('click', ()=> tr.remove());
        $('#aiTable').appendChild(tr);
      }

      // ==== Step 6 handlers ====
      function mountClosing(){
        $('#btnAddQ')?.addEventListener('click', ()=> addClosingQItemUI(''));
        $('#btnFinalize')?.addEventListener('click', ()=> {
          saveCurrent(false);
          const raw = localStorage.getItem('lesson_config_'+lessonId);
          if (raw){
            const cfg = JSON.parse(raw);
            cfg.isDraft = false;
            cfg.publishedAt = new Date().toISOString();
            cfg.updatedAt = new Date().toISOString();
            cfg.currentStep = 6;
            localStorage.setItem('lesson_config_'+lessonId, JSON.stringify(cfg));
          }
          window.onbeforeunload = null;
          alert('‚úÖ Bozza resa definitiva! Ora appare in "Le mie lezioni" in Dashboard. Per renderla visibile agli studenti, usa "Pubblica lezioni (lessons.json)" dalla Dashboard.');
        });
        $('#btnPublish')?.addEventListener('click', ()=> {
          saveCurrent(false);
          // qui potresti aggiungere gate di validazione accessibilit√†/etica
          alert('üì§ Pubblica: in questa versione locale non eseguiamo i gate. (Li attiveremo in seguito.)');
        });
      }
      function addClosingQItemUI(val){
        const wrap = document.createElement('div'); wrap.className='item';
        wrap.innerHTML = `
          <label class="small">Spunto di chiusura</label>
          <textarea>${val||''}</textarea>
          <div class="row-end"><button type="button" class="btn danger btnDel">Elimina</button></div>
        `;
        wrap.querySelector('.btnDel').addEventListener('click', ()=> wrap.remove());
        $('#qList').appendChild(wrap);
      }

      init();
    })();
  </script>

  <!-- ============================= -->
  <!-- SCRIPT ESPORTAZIONE HTML     -->
  <!-- ============================= -->
  <script>
    (() => {
      function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function gatherLessonPayload() {
        const id = sessionStorage.getItem('currentDraftId');
        const cfg = JSON.parse(localStorage.getItem('lesson_config_' + id) || '{}');
        const sections = {};
        for (let s = 1; s <= 6; s++) {
          sections['step' + s] = JSON.parse(localStorage.getItem(`lesson_section_${id}_${s}`) || '{}');
        }
      return {
        id,
        meta: cfg.meta || {},
        home: cfg.home || {},
        avatarMode: cfg.avatarMode,
        avatar: cfg.avatar,
        avatarAudio: cfg.avatarAudio,
        avatarBlobKey: cfg.avatarBlobKey,
        avatarImageBlobKey: cfg.avatarImageBlobKey,
        coverImageBlobKey: cfg.coverImageBlobKey,
        coverVideoBlobKey: cfg.coverVideoBlobKey,
          introType: cfg.introType,
          heroImage: cfg.heroImage,
          heroImageAlt: cfg.heroImageAlt,
          heroVideo: cfg.heroVideo,
          sections
        };
      }

            function buildViewerHTML(payload) {
        const title = escapeHtml(payload.home?.title || 'Lezione pubblicata');
        const desc = escapeHtml(payload.home?.description || '');
        const context = escapeHtml(payload.home?.context || '');
        const avatar = payload.avatar || '';
        const safe = JSON.stringify(payload ?? null).replace(/</g, '\\u003c');
        return `<!DOCTYPE html><html lang="it"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${title}</title>
<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--ink:#0f172a;--muted:#6b7280;--brand:#085078;--bg:#f3f4f6}
  body{font-family:"Raleway",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;color:var(--ink)}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.08);padding:16px;margin:16px 0}
  header.viewer-header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin:18px 0}
  h1{color:var(--brand);margin:0 0 6px;font-size:2rem}
  h2{margin:0 0 12px;font-size:1.25rem;color:var(--brand)}
  .muted{color:var(--muted)}
  .badge{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;border-radius:8px;padding:4px 8px;font-weight:600}
  .avatar-badge{width:56px;height:56px;border-radius:50%;object-fit:cover;border:2px solid var(--brand);flex:0 0 auto}
  img,video,iframe{max-width:100%;border-radius:12px;display:block}
  .hero-media{width:100%;max-height:56vh;object-fit:contain;background:#0b1220}
  .toc{padding:12px 16px;border-radius:10px;background:#fff;box-shadow:0 8px 32px rgba(0,0,0,0.08);margin:12px 0}
  .toc h3{margin:0 0 8px;font-size:1rem;color:var(--brand)}
  .toc ul{margin:0;padding-left:18px}
  .toc a{color:var(--brand);text-decoration:none}
  .toc a:hover{text-decoration:underline}
  .caption{font-size:.95rem;color:var(--muted);margin-top:10px;line-height:1.35}
  .sr-only{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}
  .topbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin:10px 0}
  .topbar a{display:inline-block;text-decoration:none;color:var(--brand);font-weight:700;border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:10px 12px}
  .topbar a:hover{text-decoration:underline}
  section{margin:24px 0}
  @media (max-width: 768px){
    :root{ --pillw: 170px; }
    .container{margin:16px auto;padding:0 12px}
    .wizard-header{padding:16px;border-radius:16px}
    .steps{gap:6px}
    .steps .pill{font-size:.85rem;padding:6px 10px}
    .btnbar{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:stretch;
      grid-auto-rows: 1fr;
    }
    .btnbar .row{display:contents;}
    .btnbar .btn{
      width:100%;
      min-height:48px;
    }
  }
  @media print{
    body{background:#fff}
    .card,.toc{box-shadow:none}
    .toc,.topbar{display:none}
    .wrap{margin:0 auto;padding:0 8px}
    section{margin:12px 0}
  }
</style>
</head><body><div class="wrap">
  <div class="topbar" role="navigation" aria-label="Navigazione">
    <a href="#top" id="btnHomeTop">Home</a>
    <a href="teacher-dashboard.html" id="btnDash">Dashboard</a>
    <a href="wizard.html" id="btnWizard">Torna al Wizard</a>
  </div>

  <header class="viewer-header" role="banner" id="top">
    <div>
      <h1 id="lessonTitle">${title}</h1>
      ${context ? '<div class="badge" aria-label="Contesto o target">' + context + '</div>' : ''}
      ${desc ? '<p id="lessonDesc" style="margin-top:10px">' + desc + '</p>' : ''}
    </div>
    ${avatar ? '<img class="avatar-badge" src="' + avatar + '" alt="Avatar lezione">' : ''}
  </header>

  <main id="viewer-main" role="main" aria-labelledby="lessonTitle">
    <nav class="toc" aria-label="Indice" id="toc" style="display:none">
      <h3>Indice</h3>
      <ul id="toc-list"></ul>
    </nav>

    <section id="home" class="card" style="display:none">
      <h2>üè† Home</h2>
      <div id="hero"></div>
      <div id="heroNotes" class="caption" aria-live="polite"></div>
    </section>

    <section id="lesson" class="card" style="display:none"><h2>üìñ Lezione</h2><div id="sec1"></div></section>
    <section id="activities" class="card" style="display:none"><h2>üß© Attivit√†</h2><div id="sec2"></div></section>
    <section id="resources" class="card" style="display:none"><h2>üìö Risorse</h2><div id="sec3"></div></section>
    <section id="assessment" class="card" style="display:none"><h2>üß† Valutazione</h2><div id="sec4"></div></section>
    <section id="ethics" class="card" style="display:none"><h2>‚ÑπÔ∏è Info & Etica</h2><div id="sec5"></div></section>
    <section id="closing" class="card" style="display:none"><h2>üéØ Conclusione</h2><div id="sec6"></div></section>
  </main>
</div>

<script type="application/json" id="published-data">${safe}<\/script>
<script src="assets/js/session-src.js"><\/script>
<script>
  const data = JSON.parse(document.getElementById('published-data').textContent);
  const lessonKey = data.id;
  
  // Risolvi avatar se presente
  const avatarImg = document.querySelector('.avatar-badge');
  if (avatarImg && data.avatar){
    const avatarRaw = data.avatarSrc || data.avatar;
    const avatarResolved = resolveSessionSrc(avatarRaw, lessonKey);
    if (avatarResolved && avatarResolved !== avatarRaw){
      avatarImg.src = avatarResolved;
    }
  }
  
  const S = data.sections||{};
  const toc = document.getElementById('toc');
  const tocList = document.getElementById('toc-list');

  // Link: wizard/dashboard (se la preview viene aperta dal wizard, spesso abbiamo query params)
  (function setupReturnLinks(){
    const p = new URLSearchParams(location.search);
    const ret = p.get('return');
    const dash = p.get('dashboard');
    const btnW = document.getElementById('btnWizard');
    const btnD = document.getElementById('btnDash');
    if (btnW && ret) btnW.href = ret;
    if (btnD && dash) btnD.href = dash;
  })();

  const addToc = (id, label) => {
    const li=document.createElement('li'); const a=document.createElement('a');
    a.href = '#'+id; a.textContent = label;
    li.appendChild(a); tocList.appendChild(li); toc.style.display='block';
  };
  const show = id => { const el=document.getElementById(id); if(el) el.style.display='block'; };

  // YouTube: estrazione ID robusta + embed nocookie (niente autoplay)
  function extractYouTubeId(u){
    if(!u) return null;
    try{
      const url = new URL(u, location.origin);
      const h = (url.hostname||'').replace(/^www\./,'').toLowerCase();
      if (h === 'youtube.com' || h === 'm.youtube.com' || h === 'music.youtube.com'){
        if (url.searchParams.get('v')) return (url.searchParams.get('v')||'').trim().slice(0,11);
        const em = url.pathname.match(/\/embed\/([A-Za-z0-9_-]{11})/);
        if (em) return em[1];
        const sh = url.pathname.match(/\/shorts\/([A-Za-z0-9_-]{11})/);
        if (sh) return sh[1];
      }
      if (h === 'youtu.be'){
        const m = url.pathname.match(/\/([A-Za-z0-9_-]{11})/);
        if (m) return m[1];
      }
    }catch(e){
      const m = (u||'').match(/(?:youtu\.be\/|embed\/|shorts\/|watch\?v=)([A-Za-z0-9_-]{11})/);
      if (m) return m[1];
    }
    return null;
  }

  const hero = document.getElementById('hero');
  const heroNotes = document.getElementById('heroNotes');

  // HOME: immagine o video con accessibilit√† (ALT, trascrizione, riassunto)
  if (data.introType==='image' && data.heroImage){
    const srcRaw = data.heroImage;
    const src = resolveSessionSrc(srcRaw, lessonKey);

    if (!src || src === srcRaw && srcRaw.startsWith('session://')){
      heroNotes.textContent = '‚ö†Ô∏è Copertina: file non disponibile (ri-seleziona nel Wizard).';
      show('home'); addToc('home','Home');
    } else {
      const img = new Image();
      img.src = src;
      img.alt = (data.heroImageAlt || 'Immagine di copertina').trim();
      img.className = 'hero-media';
      hero.appendChild(img);

      // Mostra anche il testo ALT (utile per docenti e per accessibilit√†)
      const altText = (data.heroImageAlt || '').trim();
      if (altText){
        const p = document.createElement('p');
        p.className = 'caption';
        p.textContent = 'Descrizione immagine (ALT): ' + altText;
        heroNotes.appendChild(p);
      }

      show('home'); addToc('home','Home');
    }
  } else if (data.introType==='video' && data.heroVideo){
    const urlRaw = data.heroVideo;
    const url = resolveSessionSrc(urlRaw, lessonKey);

    if (!url || url === urlRaw && urlRaw.startsWith('session://')){
      heroNotes.textContent = '‚ö†Ô∏è Copertina: file non disponibile (ri-seleziona nel Wizard).';
      show('home'); addToc('home','Home');
    } else {
      const yt = extractYouTubeId(url);

      if (yt){
        const iframe = document.createElement('iframe');
        iframe.src = 'https://www.youtube-nocookie.com/embed/' + yt;
        iframe.setAttribute('allowfullscreen','');
        iframe.setAttribute('title','Video YouTube di copertina');
        iframe.style.width = '100%';
        iframe.style.aspectRatio = '16/9';
        iframe.style.border = '0';
        hero.appendChild(iframe);
      } else {
        const v = document.createElement('video');
        v.controls = true;
        v.src = url;
        v.className = 'hero-media';
        v.playsInline = true;
        hero.appendChild(v);
      }

      // Trascrizione + riassunto (devono "essere letti" e visibili)
      const t = (data.home?.videoTranscript || '').trim();
      const s = (data.home?.videoSummary || '').trim();

      if (t){
        const tt = document.createElement('p');
        tt.className = 'caption';
        tt.textContent = 'Trascrizione: ' + t;
        heroNotes.appendChild(tt);
      }
      if (s){
        const ss = document.createElement('p');
        ss.className = 'caption';
        ss.textContent = 'Riassunto: ' + s;
        heroNotes.appendChild(ss);
      }
      if (!t && !s){
        const note = document.createElement('p');
        note.className = 'caption';
        note.textContent = 'Nota: trascrizione e riassunto non inseriti.';
        heroNotes.appendChild(note);
      }

      show('home'); addToc('home','Home');
    }
  }

  // LEZIONE
  const lessonHtml = (S.step1?.text||'').replace(/\\n/g,'<br>');
  if (lessonHtml.trim()) {
    document.getElementById('sec1').innerHTML = lessonHtml;
    show('lesson'); addToc('lesson','Lezione');
  }

  // ATTIVIT√Ä
  if ((S.step2?.guided?.length)||(S.step2?.indep?.length)||(S.step2?.realTask?.title)){
    const sec2 = document.getElementById('sec2');
    let html='';
    if (S.step2.guided?.length){ html += '<p><strong>Guidate:</strong> '+S.step2.guided.length+'</p>'; }
    if (S.step2.indep?.length){ html += '<p><strong>Indipendenti:</strong> '+S.step2.indep.length+'</p>'; }
    if (S.step2.realTask?.title){ html += '<p><strong>Compito di realt√†:</strong> '+escapeHtml(S.step2.realTask.title)+'</p>'; }
    sec2.innerHTML = html;
    show('activities'); addToc('activities','Attivit√†');
  }

  // RISORSE (link/doc/media con target _blank)
  if ((S.step3?.links?.length)||(S.step3?.docs?.length)||(S.step3?.media?.length)){
    const sec3 = document.getElementById('sec3'); let html='';
    if (S.step3.links?.length){
      html += '<h3>Link</h3><ul>' + S.step3.links.map(l=>'<li><a href="'+l.url+'" target="_blank" rel="noopener">'+escapeHtml(l.title||l.url)+'</a></li>').join('') + '</ul>';
    }
    if (S.step3.docs?.length){
      html += '<h3>Documenti</h3><ul>' + S.step3.docs.map(d=>'<li><a href="'+d.url+'" target="_blank" rel="noopener">'+escapeHtml(d.title||d.url)+'</a></li>').join('') + '</ul>';
    }
    if (S.step3.media?.length){
      html += '<h3>Media</h3><ul>' + S.step3.media.map(m=>'<li>'+escapeHtml(m.title||m.url)+'</li>').join('') + '</ul>';
    }
    sec3.innerHTML = html;
    show('resources'); addToc('resources','Risorse');
  }

  // VALUTAZIONE
  if ((S.step4?.quiz?.length)||(S.step4?.rubric?.length)){
    const sec4 = document.getElementById('sec4');
    let html='';
    if (S.step4.quiz?.length){ html += '<p><strong>Quiz:</strong> '+S.step4.quiz.length+' domande</p>'; }
    if (S.step4.rubric?.length){ html += '<p><strong>Rubrica:</strong> '+S.step4.rubric.length+' criteri</p>'; }
    sec4.innerHTML = html;
    show('assessment'); addToc('assessment','Valutazione');
  }

  // INFO & ETICA
  if ((data.meta?.author)||(S.step5?.sources?.length)||(S.step5?.ai?.length)){
    const sec5 = document.getElementById('sec5');
    let html='';
    if (data.meta?.author){ html += '<div class="muted">Docente: '+escapeHtml(data.meta.author)+'</div>'; }
    if (S.step5.sources?.length){ html += '<div class="muted">Fonti/licenze: '+S.step5.sources.length+'</div>'; }
    if (S.step5.ai?.length){ html += '<div class="muted">Registro IA: '+S.step5.ai.length+' voci</div>'; }
    sec5.innerHTML = html;
    show('ethics'); addToc('ethics','Info & Etica');
  }

  // CONCLUSIONE
  if (S.step6?.closing){
    document.getElementById('sec6').innerHTML = escapeHtml(S.step6?.closing || '');
    show('closing'); addToc('closing','Conclusione');
  }
<\/script></body></html>`;
      }


      function download(filename, text) {
        const blob = new Blob([text], {type:'text/html;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
      }

      document.addEventListener('click', (e) => {
        if (e.target && e.target.id === 'btnExportHtml') {
          const payload = gatherLessonPayload();
          const name = (payload.home?.title ? payload.home.title.trim().replace(/\s+/g,'_').toLowerCase() : 'lezione') + '.html';
          const html = buildViewerHTML(payload);
      download(name, html);
          }
        });
      })();
  </script>
  <script src="assets/js/global-header.js" charset="utf-8"></script>
</body>
</html>
