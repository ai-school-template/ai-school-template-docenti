<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conclusione e Feedback - AI School</title>
  <link rel="icon" type="image/png" href="../assets/brand/favicon.png">
  <link rel="stylesheet" href="../assets/css/styles.css">
  <link rel="stylesheet" href="../assets/css/global-header.css">
</head>
<body>
  <!-- Header -->
  <div id="global-header"></div>

  <main class="layout-wrap">
    <a id="backToLessonTop" href="../percorso-tematico.html" class="btn" style="margin-bottom: 1rem; display: inline-block;">‚Üê Torna alla home della lezione</a>

    <div id="empty-view" class="card" style="text-align:center; margin-top:2rem; display:none;">
      <h2>‚ö†Ô∏è Conclusione &amp; Feedback non disponibile</h2>
      <p>Questa sezione non √® ancora stata preparata per questa lezione.</p>
    </div>

    <div id="conclusion-view">
      <div id="headerCard" class="card">
        <p id="lessonTitleHeader" style="font-weight:700; margin-top:4px; margin-bottom:0;"></p>
      </div>
      <div id="closingMessageCard" class="card" style="display:none;"></div>
      <div id="closingQuestionsCard" class="card" style="display:none;"></div>
      <div id="feedbackCard" class="card" style="display:none;"></div>
      <div id="finalMessageCard" class="card"></div>
      <div id="disclaimerBox"></div>
    </div>
  </main>

  <script src="../assets/js/global-header.js"></script>
  <script>
    // Aggiorna link al percorso tematico
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const lessonId = urlParams.get('lesson');
      const isStudent = urlParams.get('student') === '1';
      const ret = urlParams.get('return');
      const dash = urlParams.get('dashboard');
      
      if (lessonId) {
        let href = `../percorso-tematico.html?lesson=${encodeURIComponent(lessonId)}`;
        if (isStudent) {
          href += '&student=1';
        } else {
          if (ret) href += `&return=${encodeURIComponent(ret)}`;
          if (dash) href += `&dashboard=${encodeURIComponent(dash)}`;
        }
        const backToLessonTop = document.getElementById('backToLessonTop');
        if (backToLessonTop) {
          backToLessonTop.href = href;
        }
      }
    });
    
    // Carica configurazione lezione
    function loadLessonConfig() {
      const urlParams = new URLSearchParams(window.location.search);
      const lessonId = urlParams.get('lesson');
      const emptyView = document.getElementById('empty-view');
      const conclusionView = document.getElementById('conclusion-view');
      
      if (!lessonId) {
        if (emptyView) emptyView.style.display = 'block';
        if (conclusionView) conclusionView.style.display = 'none';
        return;
      }
      if (emptyView) emptyView.style.display = 'none';
      if (conclusionView) conclusionView.style.display = 'block';
      
      // Prova a caricare da localStorage (lezioni create dal docente)
      const lessonConfig = localStorage.getItem(`lesson_config_${lessonId}`);
      if (!lessonConfig) {
        if (emptyView) emptyView.style.display = 'block';
        if (conclusionView) conclusionView.style.display = 'none';
        return;
      }
      if (lessonConfig) {
        try {
          const lesson = JSON.parse(lessonConfig);
          const lessonTitle = lesson.title || '';
          
          // Carica dati step 6 (Conclusione & Feedback)
          const raw6 = localStorage.getItem(`lesson_section_${lessonId}_6`);
          if (!raw6) {
            if (emptyView) emptyView.style.display = 'block';
            if (conclusionView) conclusionView.style.display = 'none';
            return;
          }
          
          let data6;
          try {
            data6 = JSON.parse(raw6);
          } catch (e) {
            if (emptyView) emptyView.style.display = 'block';
            if (conclusionView) conclusionView.style.display = 'none';
            return;
          }
          
          // Verifica se tutti i dati sono vuoti
          const hasClosing = data6.closing && data6.closing.trim();
          const hasQuestions = Array.isArray(data6.closingQuestions) && data6.closingQuestions.some(q => q && q.trim());
          const hasUrl = data6.externalFormUrl && data6.externalFormUrl.trim();
          
          if (!hasClosing && !hasQuestions && !hasUrl) {
            if (emptyView) emptyView.style.display = 'block';
            if (conclusionView) conclusionView.style.display = 'none';
            return;
          }
          
          // Render header card
          const headerCard = document.getElementById('headerCard');
          headerCard.innerHTML = '';
          const headerTitle = document.createElement('h2');
          headerTitle.textContent = 'üéØ Conclusione & Feedback';
          headerCard.appendChild(headerTitle);
          const lessonTitleHeader = document.createElement('p');
          lessonTitleHeader.id = 'lessonTitleHeader';
          lessonTitleHeader.className = 'section-subtitle';
          lessonTitleHeader.style.fontSize = '1.1rem';
          lessonTitleHeader.style.marginTop = '4px';
          lessonTitleHeader.style.marginBottom = '0';
          lessonTitleHeader.textContent = (lesson.home && lesson.home.title) || lesson.title || '';
          headerCard.appendChild(lessonTitleHeader);
          
          // Render sottosezione 1 - Messaggio di chiusura
          const closingMessageCard = document.getElementById('closingMessageCard');
          closingMessageCard.innerHTML = '';
          if (hasClosing) {
            const title1 = document.createElement('h3');
            title1.style.fontWeight = 'bold';
            title1.textContent = 'Messaggio di chiusura';
            closingMessageCard.appendChild(title1);
            const box1 = document.createElement('div');
            box1.className = 'desc-box';
            const p1 = document.createElement('p');
            p1.textContent = data6.closing;
            p1.style.whiteSpace = 'pre-line';
            box1.appendChild(p1);
            closingMessageCard.appendChild(box1);
            closingMessageCard.style.display = 'block';
          } else {
            closingMessageCard.style.display = 'none';
          }
          
          // Render sottosezione 2 - Domande di chiusura
          const closingQuestionsCard = document.getElementById('closingQuestionsCard');
          closingQuestionsCard.innerHTML = '';
          if (hasQuestions) {
            const title2 = document.createElement('h3');
            title2.style.fontWeight = 'bold';
            title2.textContent = 'Domande di chiusura del percorso';
            closingQuestionsCard.appendChild(title2);
            data6.closingQuestions.forEach(question => {
              if (question && question.trim()) {
                const box2 = document.createElement('div');
                box2.className = 'desc-box';
                const p2 = document.createElement('p');
                p2.textContent = question;
                box2.appendChild(p2);
                closingQuestionsCard.appendChild(box2);
              }
            });
            closingQuestionsCard.style.display = 'block';
          } else {
            closingQuestionsCard.style.display = 'none';
          }
          
          // Render sottosezione 3 - Feedback e consegna
          const feedbackCard = document.getElementById('feedbackCard');
          feedbackCard.innerHTML = '';
          if (hasUrl) {
            const title3 = document.createElement('h3');
            title3.style.fontWeight = 'bold';
            title3.textContent = 'Feedback e consegna';
            feedbackCard.appendChild(title3);
            const introP = document.createElement('p');
            introP.className = 'muted';
            introP.style.fontSize = '0.95rem';
            introP.style.fontStyle = 'italic';
            introP.style.marginTop = '4px';
            introP.style.marginBottom = '10px';
            introP.style.lineHeight = '1.35';
            introP.style.color = '#6b7280';
            introP.textContent = 'In questa fase finale puoi inviare al docente riflessioni, commenti, suggerimenti o risposte alle domande di chiusura del percorso. Clicca sul pulsante per aprire il modulo e inviare il tuo feedback.';
            feedbackCard.appendChild(introP);
            const box3 = document.createElement('div');
            box3.className = 'desc-box';
            const a3 = document.createElement('a');
            a3.className = 'btn btn-external';
            a3.href = data6.externalFormUrl;
            a3.target = '_blank';
            a3.rel = 'noopener';
            a3.textContent = 'Apri modulo';
            box3.appendChild(a3);
            feedbackCard.appendChild(box3);
            feedbackCard.style.display = 'block';
          } else {
            feedbackCard.style.display = 'none';
          }
          
          // Render card finale fissa
          const finalMessageCard = document.getElementById('finalMessageCard');
          finalMessageCard.innerHTML = '';
          const finalTitle = document.createElement('h3');
          finalTitle.style.fontWeight = 'bold';
          finalTitle.textContent = 'Messaggio finale';
          finalMessageCard.appendChild(finalTitle);
          const finalBox = document.createElement('div');
          finalBox.className = 'desc-box';
          const finalP = document.createElement('p');
          finalP.textContent = 'Grazie per aver seguito questo percorso. Non finisce qui: le domande, le riflessioni e i dubbi che emergono sono parte importante dell\'apprendimento. Continueremo a lavorarci insieme in classe.';
          finalBox.appendChild(finalP);
          finalMessageCard.appendChild(finalBox);
          
          // Render disclaimer finale (box grigio)
          const disclaimerContainer = document.getElementById('disclaimerBox');
          disclaimerContainer.innerHTML = '';
          const disclaimerBox = document.createElement('div');
          disclaimerBox.className = 'desc-box';
          disclaimerBox.style.textAlign = 'center';
          disclaimerBox.style.fontWeight = '600';
          disclaimerBox.style.color = '#6b7280';
          disclaimerBox.style.boxShadow = '0 2px 8px rgba(0,0,0,.06)';
          disclaimerBox.style.marginTop = '18px';
          const disclaimerP = document.createElement('p');
          disclaimerP.style.margin = '0';
          disclaimerP.textContent = 'Il template non raccoglie direttamente le risposte: riflessioni, domande e contributi saranno ripresi e approfonditi insieme in classe.';
          disclaimerBox.appendChild(disclaimerP);
          disclaimerContainer.appendChild(disclaimerBox);
          
        } catch (e) {
          console.error('Errore caricamento configurazione lezione:', e);
        }
      } else {
        // Lezione non trovata
        if (emptyView) emptyView.style.display = 'block';
        if (conclusionView) conclusionView.style.display = 'none';
        return;
      }
    }
    
    // Carica configurazione al caricamento della pagina
    document.addEventListener('DOMContentLoaded', loadLessonConfig);
  </script>
  
  <!-- Lettore Vocale per Accessibilit√† -->
  <script src="../assets/js/voice-reader.js"></script>
</body>
</html>
