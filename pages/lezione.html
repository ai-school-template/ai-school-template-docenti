<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lezione</title>
  <link rel="icon" type="image/png" href="../assets/brand/favicon.png">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="../assets/css/styles.css">
  <link rel="stylesheet" href="../assets/css/global-header.css">
  <style>
    #lesson-view details summary {
      list-style: none;
    }
    #lesson-view details summary::-webkit-details-marker {
      display: none;
    }
    #lesson-cards > * + * {
      margin-top: 16px;
    }
    /* Normalizza la spaziatura tra le card dentro #lesson-media (Video + Immagini) */
    #lesson-media > .card {
      margin: 0 !important;
    }
    #lesson-media > .card + .card {
      margin-top: 16px !important;
    }
  </style>
</head>
<body class="fix-global-header">
  <main class="layout-wrap">
    <a id="backToLessonTop" href="../percorso-tematico.html" class="btn" style="margin-bottom: 1rem; display: inline-block;">‚Üê Torna alla home della lezione</a>
    <div id="empty-view" class="card" style="text-align:center; margin-top:2rem;">
      <h2>‚ö†Ô∏è Lezione non disponibile</h2>
      <p>Questa lezione non √® ancora stata preparata per questa sezione.</p>
    </div>

    <div id="lesson-view" style="display:none">
      <div id="lesson-cards">
        <div class="card">
          <h2 id="lessonTitle">üìñ Lezione</h2>
          <p id="lessonSubtitle" style="font-weight: 600; color: #1E1E1E; margin-top: 0.5rem; margin-bottom: 0; display: none;"></p>
        </div>

        <div id="lesson-objectives-card" class="card" style="display: none;">
          <h2>Obiettivi</h2>
          <div class="desc-box">
            <p id="lesson-objectives-text" style="margin: 0;"></p>
          </div>
        </div>

        <div id="lesson-text"></div>
        <div id="lesson-glossary"></div>
        <div id="lesson-media"></div>
        <div id="lesson-concept"></div>
        <div id="lesson-curipod"></div>
      </div>
    </div>
  </main>

  <!-- Scripts -->
  <script src="../assets/js/global-header.js"></script>
  <script src="../assets/js/lesson/LessonTextIA.js"></script>
  <script src="../assets/js/lesson/LessonVideo.js"></script>
  <script src="../assets/js/lesson/LessonImage.js"></script>
  <script src="../assets/js/lesson/LessonGlossary.js"></script>
  <script src="../assets/js/lesson/CuripodEmbed.js"></script>
  <script src="../assets/js/lesson/LessonChecklist.js"></script>
  
  <script>
    // IndexedDB helpers per blob
    async function idbOpen(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open('ai_school_template', 1);
        req.onerror = () => reject(req.error);
        req.onsuccess = () => resolve(req.result);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if(!db.objectStoreNames.contains('blobs')){
            db.createObjectStore('blobs', {keyPath: 'key'});
          }
        };
      });
    }

    async function idbGetBlob(key){
      try {
        const db = await idbOpen();
        return new Promise((resolve, reject) => {
          const tx = db.transaction('blobs', 'readonly');
          const store = tx.objectStore('blobs');
          const req = store.get(key);
          req.onerror = () => reject(req.error);
          req.onsuccess = () => resolve(req.result ? req.result.blob : null);
        });
      } catch(e) {
        return null;
      }
    }

    // Carica la lezione principale salvata
    (function () {
      // Controlla se √® modalit√† anteprima
      const urlParams = new URLSearchParams(window.location.search);
      const isPreview = urlParams.get('preview') === 'true';
      const lessonId = urlParams.get('lesson');
      const isValidLessonId = lessonId && lessonId !== 'null' && lessonId !== 'undefined' && lessonId.trim() !== '';
      const isStudent = urlParams.get('student') === '1';
      const ret = urlParams.get('return');
      const dash = urlParams.get('dashboard');
      const emptyView = document.getElementById('empty-view');
      const backToLessonTop = document.getElementById('backToLessonTop');
      
      // Imposta href per backToLessonTop con fallback se lessonId non valido
      if (backToLessonTop) {
        if (isValidLessonId) {
          let href = `../percorso-tematico.html?lesson=${encodeURIComponent(lessonId)}`;
          if (isStudent) {
            href += '&student=1';
          } else {
            if (ret) href += `&return=${encodeURIComponent(ret)}`;
            if (dash) href += `&dashboard=${encodeURIComponent(dash)}`;
          }
          backToLessonTop.href = href;
        } else {
          backToLessonTop.href = isStudent ? '../student-lessons.html' : '../teacher-dashboard.html';
        }
      }
      const lessonView = document.getElementById('lesson-view');

      // REGOLA UNICA: senza lessonId -> mostra solo empty-view e stop
      if (!lessonId) {
        if (lessonView) lessonView.style.display = 'none';
        if (emptyView) {
          emptyView.style.display = 'block';
          const h2 = emptyView.querySelector('h2');
          if (h2) h2.textContent = '‚ö†Ô∏è Lezione non disponibile';
          const p = emptyView.querySelector('p');
          // non aggiungere testi nuovi se non necessario
        }
        return;
      }
      
      // Leggi Wizard Step 1
      let step1 = null;
      if (lessonId) {
        try {
          const step1Raw = localStorage.getItem('lesson_section_' + lessonId + '_1');
          if (step1Raw) {
            step1 = JSON.parse(step1Raw);
          }
        } catch (e) {}
      }
      
      let lessonData = null;
      
      if (isPreview) {
        // Modalit√† anteprima: carica da sessionStorage
        const previewData = sessionStorage.getItem('section_preview');
        if (previewData) {
          const preview = JSON.parse(previewData);
          
          // Costruisci struttura dati compatibile
          lessonData = JSON.stringify({
            meta: {
              title: "üîç ANTEPRIMA - Lezione",
              subtitle: "Questa √® un'anteprima di come apparir√† la tua lezione agli studenti"
            },
            textIA: {
              enabled: !!preview.text,
              etichettaIA: false,
              titolo: "Contenuto della Lezione",
              paragrafi: preview.text ? [preview.text] : [],
              fonti: [],
              registroIA: {}
            },
            media: {
              video: {
                enabled: !!preview.videoUrl,
                title: "Video della Lezione",
                source: preview.videoUrl,
                caption: "",
                transcript: preview.videoTranscript,
                transcriptSummary: preview.videoSummary,
                etichettaIA: false
              }
            },
            glossary: { enabled: false },
            curipod: { enabled: false },
            checklist: {
              altTextOk: true,
              videoTranscriptOk: !!preview.videoTranscript,
              videoSummaryOk: !!preview.videoSummary,
              iaLabelOk: true,
              copyrightOk: true,
              privacyOk: true,
              biasOk: true
            }
          });
        }
      } else {
        if (lessonId) {
          const cfgRaw = localStorage.getItem('lesson_config_'+lessonId);
          if (!cfgRaw) {
            if (lessonView) lessonView.style.display = 'none';
            if (emptyView) {
              emptyView.style.display = 'block';
              const h2 = emptyView.querySelector('h2');
              if (h2) h2.textContent = '‚ö†Ô∏è Lezione non disponibile';
            }
            return;
          }
          if (cfgRaw) {
            try {
              const cfg = JSON.parse(cfgRaw) || {};
              const dataObj = {
                meta: cfg.meta || {},
                home: cfg.home || {},
                glossary: cfg.glossary,
                curipod: cfg.curipod,
                checklist: cfg.checklist,
                media: cfg.media || {}
              };
              
              // Adapter: mappa step1 ‚Üí dataObj
              if (step1) {
                // 2.1 Testo
                if (step1.text && step1.text.trim()) {
                  dataObj.textIA = {
                    enabled: true,
                    etichettaIA: false,
                    titolo: "Contenuto della lezione",
                    paragrafi: [step1.text],
                    fonti: [],
                    registroIA: {}
                  };
                }
                
                // 2.2 Video
                if (Array.isArray(step1.videos) && step1.videos.some(v => v && v.url)) {
                  dataObj.media.video = step1.videos
                    .filter(v => v && v.url)
                    .map(v => ({
                      enabled: true,
                      source: v.url,
                      transcript: v.transcript || "",
                      transcriptSummary: v.summary || ""
                    }));
                }
                
                // 2.3 Immagini
                if (Array.isArray(step1.images)) {
                  if (!dataObj.media.images || !Array.isArray(dataObj.media.images) || dataObj.media.images.length === 0) {
                    const step1Images = step1.images.filter(i => i.url || i.blobKey).map(i => ({
                      src: i.url || '',
                      alt: i.alt || "",
                      credit: "",
                      etichettaIA: false,
                      blobKey: i.blobKey || ''
                    }));
                    dataObj.media.images = step1Images;
                  }
                }
                
                // 2.4 Glossario
                if (Array.isArray(step1.glossary) && step1.glossary.some(g => g.term)) {
                  dataObj.glossary = {
                    enabled: true,
                    entries: step1.glossary.filter(g => g.term).map(g => ({
                      it: g.term,
                      def_it: g.explain || "",
                      tr: "",
                      example_it: ""
                    }))
                  };
                }
              }
              
              const contentRaw = localStorage.getItem(`lesson_${lessonId}_content`);
              if (contentRaw) {
                try {
                  const content = JSON.parse(contentRaw);
                  const home = dataObj.home || {};
                  dataObj.meta = dataObj.meta || {};
                  dataObj.meta.title = dataObj.meta.title || home.title || "";
                  dataObj.meta.subtitle = dataObj.meta.subtitle || home.subtitle || "";
                  if (content && typeof content.text === 'string' && content.text.trim()) {
                    dataObj.textIA = {
                      enabled: true,
                      etichettaIA: false,
                      titolo: "Contenuto della Lezione",
                      paragrafi: [content.text],
                      fonti: [],
                      registroIA: {}
                    };
                  }
                } catch (e) {}
              }
              
              const hasText = !!(dataObj.textIA && dataObj.textIA.enabled) || !!(step1 && step1.text && step1.text.trim());
              const hasVideo = !!(dataObj.media && dataObj.media.video && dataObj.media.video.enabled) || !!(step1 && Array.isArray(step1.videos) && step1.videos.some(v => v && ((v.url && v.url.trim()) || (v.blobKey && v.blobKey.trim()))));
              const hasImages = !!(dataObj.media && Array.isArray(dataObj.media.images) && dataObj.media.images.length) || !!(step1 && Array.isArray(step1.images) && step1.images.some(i => i && (i.url || i.blobKey)));
              const hasGlossary = !!(dataObj.glossary && dataObj.glossary.enabled && Array.isArray(dataObj.glossary.entries) && dataObj.glossary.entries.length);
              const hasConcept = !!(step1 && step1.concept && ((step1.concept.url && step1.concept.url.trim()) || (step1.concept.imageUrl && step1.concept.imageUrl.trim()) || (step1.concept.blobKey && step1.concept.blobKey.trim())));
              if (!hasText && !hasVideo && !hasImages && !hasGlossary && !hasConcept) {
                if (lessonView) lessonView.style.display = 'none';
                if (emptyView) {
                  emptyView.style.display = 'block';
                  const h2 = emptyView.querySelector('h2');
                  if (h2) h2.textContent = '‚ö†Ô∏è Lezione non disponibile';
                }
                return;
              }
              
              // Mostra lesson-view e nascondi empty-view se c'√® contenuto
              if (lessonView) lessonView.style.display = 'block';
              if (emptyView) emptyView.style.display = 'none';
              
              // Costruisci href per "Torna alla lezione"
              let backHref = `../percorso-tematico.html?lesson=${encodeURIComponent(lessonId)}`;
              if (isStudent) backHref += '&student=1';
              else {
                if (ret) backHref += `&return=${encodeURIComponent(ret)}`;
                if (dash) backHref += `&dashboard=${encodeURIComponent(dash)}`;
              }
              if (backToLessonTop) backToLessonTop.href = backHref;
              lessonData = JSON.stringify(dataObj);
            } catch (e) {
              if (lessonView) lessonView.style.display = 'none';
              if (emptyView) {
                emptyView.style.display = 'block';
                const h2 = emptyView.querySelector('h2');
                if (h2) h2.textContent = '‚ö†Ô∏è Lezione non disponibile';
              }
              return;
            }
          }
        
        }
      }
      
      if (!lessonData) {
        // Nessuna lezione ‚Üí mostra vista vuota
        document.getElementById('empty-view').style.display = 'block';
        console.log('‚ÑπÔ∏è Nessuna lezione salvata. Crea la tua prima lezione!');
        return;
      }

      // Lezione trovata ‚Üí mostra vista lezione
      try {
        const data = JSON.parse(lessonData);
        // Verifica hasContent (gi√† calcolato sopra nel blocco if (cfgRaw))
        const hasText = !!(data.textIA && data.textIA.enabled) || !!(step1 && step1.text && step1.text.trim());
        const hasVideo = !!(data.media && data.media.video && data.media.video.enabled) || !!(step1 && Array.isArray(step1.videos) && step1.videos.some(v => v && ((v.url && v.url.trim()) || (v.blobKey && v.blobKey.trim()))));
        const hasImages = !!(data.media && Array.isArray(data.media.images) && data.media.images.length) || !!(step1 && Array.isArray(step1.images) && step1.images.some(i => i && (i.url || i.blobKey)));
        const hasGlossary = !!(data.glossary && data.glossary.enabled && Array.isArray(data.glossary.entries) && data.glossary.entries.length);
        const hasConcept = !!(step1 && step1.concept && ((step1.concept.url && step1.concept.url.trim()) || (step1.concept.imageUrl && step1.concept.imageUrl.trim()) || (step1.concept.blobKey && step1.concept.blobKey.trim())));
        
        if (hasText || hasVideo || hasImages || hasGlossary || hasConcept) {
          if (lessonView) lessonView.style.display = 'block';
          if (emptyView) emptyView.style.display = 'none';
          renderLesson(data, isPreview, step1);
          console.log('‚úÖ Lezione caricata con successo!');
        } else {
          if (lessonView) lessonView.style.display = 'none';
          if (emptyView) emptyView.style.display = 'block';
        }
      } catch (err) {
        console.error('‚ùå Errore caricamento lezione:', err);
        if (lessonView) lessonView.style.display = 'none';
        if (emptyView) emptyView.style.display = 'block';
      }

      function renderLesson(data, isPreview = false, step1 = null) {
        const el = {
          title: document.getElementById("lessonTitle"),
          subtitle: document.getElementById("lessonSubtitle"),
          text: document.getElementById("lesson-text"),
          media: document.getElementById("lesson-media"),
          glossary: document.getElementById("lesson-glossary"),
          concept: document.getElementById("lesson-concept"),
          curipod: document.getElementById("lesson-curipod")
        };

        // Titolo sezione (sempre "üìñ Lezione")
        if (el.title) {
          el.title.textContent = 'üìñ Lezione';
        }
        
        // Sottotitolo (titolo lezione)
        const lessonTitle = data.meta?.title || (step1 && step1.title && step1.title.trim() ? step1.title : '');
        if (el.subtitle && lessonTitle) {
          el.subtitle.textContent = lessonTitle;
          el.subtitle.style.display = 'block';
        } else if (el.subtitle) {
          el.subtitle.style.display = 'none';
        }
        
        // Card Obiettivi (solo se presenti)
        const objectivesCard = document.getElementById('lesson-objectives-card');
        const objectivesText = document.getElementById('lesson-objectives-text');
        if (step1 && step1.objectives && step1.objectives.trim()) {
          if (objectivesCard) objectivesCard.style.display = 'block';
          if (objectivesText) objectivesText.textContent = step1.objectives.trim();
        } else {
          if (objectivesCard) objectivesCard.style.display = 'none';
        }
        
        // Se √® anteprima, aggiungi badge
        if (isPreview) {
          const previewBadge = document.createElement('span');
          previewBadge.style.cssText = 'background: #ffc107; color: #000; padding: 8px 16px; border-radius: 12px; font-size: 0.9rem; font-weight: 600; margin-left: 1rem;';
          previewBadge.textContent = 'üëÅÔ∏è ANTEPRIMA';
          el.title.appendChild(previewBadge);
        }

        // Blocchi
        if (data.textIA?.enabled) window.LessonTextIA.render(el.text, data.textIA);
        if (data.glossary?.enabled) window.LessonGlossary.render(el.glossary, data.glossary);
        // Immagini con bottone "Apri immagine" e gestione errori
        if (data.media?.images && Array.isArray(data.media.images) && data.media.images.length) {
          const wrap = document.createElement("div");
          wrap.className = "card media";
          wrap.innerHTML = `<h2>üñºÔ∏è Immagini</h2>`;
          
          for (const img of data.media.images) {
            const descBox = document.createElement('div');
            descBox.className = 'desc-box';
            
            const openUrl = (img.url && img.url.trim()) ? img.url.trim() : (img.src && img.src.trim() ? img.src.trim() : '');
            
            const imgEl = document.createElement('img');
            imgEl.alt = img.alt || "";
            imgEl.style.display = 'block';
            imgEl.style.margin = '0 auto 0.75rem';
            imgEl.style.maxWidth = '520px';
            imgEl.style.width = '100%';
            imgEl.style.borderRadius = '8px';
            imgEl.addEventListener('error', function() {
              this.style.display = 'none';
            });
            
            if (img.blobKey && img.blobKey.trim()) {
              (async () => {
                try {
                  const blob = await idbGetBlob(img.blobKey);
                  if (blob) {
                    imgEl.src = URL.createObjectURL(blob);
                  }
                } catch(e) {
                  console.error('Errore caricamento blob immagine', e);
                }
              })();
            } else if (img.url && img.url.trim()) {
              imgEl.src = img.url.trim();
            } else if (img.src && img.src.trim()) {
              imgEl.src = img.src.trim();
            }
            
            descBox.appendChild(imgEl);
            
            if (openUrl) {
              const openBtn = document.createElement('a');
              openBtn.href = openUrl;
              openBtn.target = '_blank';
              openBtn.rel = 'noopener';
              openBtn.textContent = 'Apri immagine';
              openBtn.className = 'btn';
              openBtn.style.display = 'inline-block';
              openBtn.style.marginBottom = '0.75rem';
              descBox.appendChild(openBtn);
            }
            
            if (img.alt && img.alt.trim()) {
              const descP = document.createElement('p');
              descP.style.margin = '0';
              descP.innerHTML = '<strong>Descrizione:</strong> ' + img.alt.trim();
              descBox.appendChild(descP);
            }
            
            wrap.appendChild(descBox);
          }
          
          el.media.appendChild(wrap);
        }
        
        // Video da step1.videos con bottone sempre visibile
        if (step1 && Array.isArray(step1.videos) && step1.videos.length) {
          for (const video of step1.videos) {
            if (!video) return;
            
            const url = (video.url || '').trim();
            const blobKey = (video.blobKey || '').trim();
            if (!url && !blobKey) return;
            
            // FIX MINIMO: video da URL viene renderizzato da LessonVideo.render (evita duplicati)
            if (url) continue;
            
            const videoWrap = document.createElement('div');
            videoWrap.className = 'desc-box';
            
            if (url) {
              const openBtn = document.createElement('a');
              openBtn.href = url;
              openBtn.target = '_blank';
              openBtn.rel = 'noopener';
              openBtn.textContent = 'Apri video';
              openBtn.className = 'btn';
              openBtn.style.display = 'inline-block';
              openBtn.style.marginBottom = '0.75rem';
              videoWrap.appendChild(openBtn);
            }
            
            const videoEl = document.createElement('video');
            videoEl.controls = true;
            videoEl.style.width = '100%';
            videoEl.style.maxWidth = '520px';
            videoEl.style.display = 'block';
            videoEl.style.margin = '0 auto 0.75rem';
            videoEl.addEventListener('error', function() {
              this.style.display = 'none';
            });
            
            if (blobKey) {
              (async () => {
                try {
                  const blob = await idbGetBlob(blobKey);
                  if (blob) {
                    const objUrl = URL.createObjectURL(blob);
                    videoEl.src = objUrl;
                  }
                } catch(e) {
                  console.error('Errore caricamento blob video', e);
                }
              })();
            } else if (url) {
              videoEl.src = url;
            }
            
            videoWrap.appendChild(videoEl);
            
            if (video.transcript && video.transcript.trim()) {
              const transcriptP = document.createElement('p');
              transcriptP.style.margin = '0.5rem 0 0 0';
              transcriptP.innerHTML = '<strong>Trascrizione:</strong> ' + video.transcript.trim();
              videoWrap.appendChild(transcriptP);
            }
            
            if (video.summary && video.summary.trim()) {
              const summaryP = document.createElement('p');
              summaryP.style.margin = '0.5rem 0 0 0';
              summaryP.innerHTML = '<strong>Riassunto:</strong> ' + video.summary.trim();
              videoWrap.appendChild(summaryP);
            }
            
            const cardWrap = document.createElement('div');
            cardWrap.className = 'card media';
            cardWrap.innerHTML = '<h2>üé• Video</h2>';
            cardWrap.appendChild(videoWrap);
            el.media.appendChild(cardWrap);
          }
        }
        
        window.LessonVideo.render(el.media, data.media?.video);
        
        // 2.5 Mappa concettuale (solo se c'√® contenuto)
        if (step1 && step1.concept) {
          const concept = step1.concept;
          const hasConceptContent = (concept.imageUrl && concept.imageUrl.trim()) || (concept.url && concept.url.trim()) || (concept.blobKey && concept.blobKey.trim());
          if (hasConceptContent) {
            el.concept.innerHTML = '';
            const conceptSection = document.createElement('div');
            conceptSection.className = 'card';
            conceptSection.innerHTML = '<h2>üó∫Ô∏è Mappa concettuale</h2>';
            
            const descBox = document.createElement('div');
            descBox.className = 'desc-box';
            
            const openUrl = (concept.url && concept.url.trim()) ? concept.url.trim() : ((concept.imageUrl && concept.imageUrl.trim()) ? concept.imageUrl.trim() : '');
            
            if (concept.url && concept.url.trim() && !concept.imageUrl && !concept.blobKey) {
              const link = document.createElement('a');
              link.href = concept.url.trim();
              link.target = '_blank';
              link.rel = 'noopener';
              link.textContent = 'Apri mappa concettuale';
              link.className = 'btn';
              descBox.appendChild(link);
            } else {
              const img = document.createElement('img');
              img.alt = concept.imageAlt || '';
              img.style.cssText = 'display: block; margin: 0 auto 0.75rem; width: 100%; max-width: 520px; border-radius: 8px; cursor: zoom-in;';
              img.addEventListener('error', function() {
                this.style.display = 'none';
              });
              
              if (concept.blobKey && concept.blobKey.trim()) {
                (async () => {
                  try {
                    const blob = await idbGetBlob(concept.blobKey);
                    if (blob) {
                      img.src = URL.createObjectURL(blob);
                    }
                  } catch(e) {
                    console.error('Errore caricamento blob mappa', e);
                  }
                })();
              } else if (concept.imageUrl && concept.imageUrl.trim()) {
                img.src = concept.imageUrl.trim();
              }
              
              descBox.appendChild(img);
              
              if (openUrl) {
                const openBtn = document.createElement('a');
                openBtn.href = openUrl;
                openBtn.target = '_blank';
                openBtn.rel = 'noopener';
                openBtn.textContent = 'Apri immagine';
                openBtn.className = 'btn';
                openBtn.style.display = 'inline-block';
                openBtn.style.marginBottom = '0.75rem';
                descBox.appendChild(openBtn);
              }
              
              if (concept.imageAlt && concept.imageAlt.trim()) {
                const descP = document.createElement('p');
                descP.style.margin = '0';
                descP.innerHTML = '<strong>Descrizione:</strong> ' + concept.imageAlt.trim();
                descBox.appendChild(descP);
              }
            }
            
            conceptSection.appendChild(descBox);
            el.concept.appendChild(conceptSection);
          } else {
            el.concept.innerHTML = '';
          }
        } else {
          el.concept.innerHTML = '';
        }
        
        if (data.curipod?.enabled) window.CuripodEmbed.render(el.curipod, data.curipod);
        
        // Nascondi sezioni vuote
        [el.text, el.media, el.glossary, el.concept, el.curipod].forEach(container => {
          if (container) {
            if (!container.children.length || container.innerHTML.trim() === '') {
              container.style.display = 'none';
            } else {
              container.style.display = 'block';
            }
          }
        });
      }
    })();
  </script>
  
  
  <!-- Lettore Vocale per Accessibilit√† -->
  <script src="../assets/js/voice-reader.js"></script>
  
  <script>
    /* FIX MINIMO: se la lezione non √® ancora visibile, ritenta "Ascolta" dopo poco (solo lezione) */
    (function(){
      let retrying = false;

      document.addEventListener('click', function(e){
        const btn = e.target && e.target.closest ? e.target.closest('#voiceReaderBtn') : null;
        if (!btn) return;

        const lessonView = document.getElementById('lesson-view');
        if (!lessonView) return;

        // Se la lezione √® ancora nascosta, blocca il click e riprova tra poco
        const hidden = (lessonView.style.display === 'none');
        if (hidden && !retrying) {
          e.preventDefault();
          e.stopPropagation();
          retrying = true;
          setTimeout(function(){
            retrying = false;
            // riprova automaticamente
            btn.click();
          }, 500);
        }
      }, true);
    })();
  </script>
</body>
</html>
